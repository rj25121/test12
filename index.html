<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vastu Pro Analyzer |
AI Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
/* *** CRITICAL MOBILE TOUCH FIXES *** */
html, body {
    height: 100%; /* FIX: Ensures height is calculated against viewport */
    touch-action: pan-y; /* FIX: Allows vertical scrolling and prevents touch freezing */
    -webkit-tap-highlight-color: transparent; /* Optional: improves responsiveness feel */
}

:root {
            /* Pastel Blue & White Theme */
            --color-primary: #60a5fa;
/* Blue 400 - Main Accent */
            --color-secondary: #93c5fd;
/* Blue 300 - Light Accent */
            --color-background: #f0f8ff;
/* Alice Blue / Lightest Pastel */
            --color-surface-base: rgba(255, 255, 255, 0.7); /* Slightly lighter glass */
/* Semi-transparent White for Glass */
            --color-text-dark: #1e3a8a;
/* Blue 800 - Deep Blue Text */
            --color-text-light: #6b7280;
/* Gray 500 */
            --color-chat-bg-user: #e0f2fe;
/* Blue 50 */
            --color-chat-bg-ai: #fff;
}
        body {
            font-family: 'Inter', sans-serif;
background-color: var(--color-background);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--color-text-dark);
            padding: 16px;
}

        /* Glassmorphism Card Style */
        .glass-card {
            background-color: var(--color-surface-base);
backdrop-filter: blur(8px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
}

        /* Step Indicator Styles */
        .step-indicator {
            transition: all 0.3s ease;
            /* UPDATED: Made smaller for icons */
            min-width: 50px; 
            padding-left: 0.5rem;
            padding-right: 0.5rem;
}
        .step-active {
            color: var(--color-primary);
border-bottom: 2px solid var(--color-primary);
            font-weight: 600;
        }

        /* --- NEW: Main App Tab Styles --- */
        .main-tab {
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        .main-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        /* Button Styles */
        .primary-btn {
            background-color: var(--color-primary);
color: white;
            transition: background-color: 0.2s;
            box-shadow: 0 4px var(--color-text-dark);
        }
        .primary-btn:hover:not(:disabled) {
            background-color: #3b82f6;
/* Blue 500 */
        }
        .primary-btn:active:not(:disabled) {
            transform: translateY(2px);
box-shadow: 0 2px var(--color-text-dark);
        }
        .primary-btn:disabled {
            background-color: #93c5fd;
/* Blue 300 */
            cursor: not-allowed;
            box-shadow: none;
}
        /* NEW: Secondary button style for planner tools */
        .secondary-btn {
            background-color: #fff;
            color: var(--color-text-dark);
            border: 1px solid var(--color-primary);
            transition: all 0.2s;
            box-shadow: 0 2px var(--color-secondary);
        }
        .secondary-btn:hover:not(:disabled) {
            background-color: #eff6ff;
/* Blue 50 */
            box-shadow: 0 2px var(--color-primary);
        }
        .secondary-btn:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 1px var(--color-primary);
        }
        
        /* Checkbox Styles for new step */
        .concern-checkbox:checked {
            background-color: var(--color-primary);
            border-color: var(--color-text-dark);
        }

        /* Compass Visual */
        #compassNeedle {
            transition: transform 0.1s linear;
}
        /* *** NEW: Step 4 Compass *** */
        #step4CompassNeedle {
            transition: transform 0.1s linear;
            /* NEW: Proper needle origin */
            transform-origin: bottom; 
            bottom: 50%;
        }

        /* --- Report Formatting --- */
        #reportContent strong, #expertReportContent strong {
            /* Targeted styles for the AI's section titles (e.g., **II. Assessment**) */
            display: block;
margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.15rem;
            font-weight: 800;
            color: #f97316;
/* Orange color for headings */
            border-bottom: 2px solid #93c5fd;
/* Light Blue border */
            padding-bottom: 0.25rem;
}
        #reportContent, #expertReportContent {
            line-height: 1.6;
        }
        .report-section p {
            margin-bottom: 1em;
/* Ensures clear paragraph separation */
        }
        
        /* Image Grid Styling for Captured Frames */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-top: 2px solid #ddd;
            padding-top: 0.5rem;
}
        .frame-item {
            border: 1px solid #ccc;
border-radius: 0.5rem;
            overflow: hidden;
            text-align: center;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}
        .frame-item img {
            width: 100%;
height: auto;
            object-fit: cover;
            aspect-ratio: 1/1; 
        }
        .text-xxs {
            font-size: 0.6rem;
}

        /* --- Live Overlay Styles --- */
        #compassOverlay {
            pointer-events: none;
}
        #overlayHeading {
            /* Large degree number */
            font-size: 2.25rem;
/* 3xl */
        }

        /* Chatbot Styles */
        .chat-message {
            max-width: 85%;
padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .user-message {
            background-color: var(--color-chat-bg-user);
align-self: flex-end;
            margin-left: auto;
            border-top-right-radius: 2px;
        }
        .ai-message {
            background-color: var(--color-chat-bg-ai);
align-self: flex-start;
            margin-right: auto;
            border-top-left-radius: 2px;
            border: 1px solid #e0e7ff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}
        /* --- NEW: Feedback Icons --- */
        .feedback-icons {
            margin-top: 8px;
            opacity: 0.5;
        }
        .feedback-icons i {
            cursor: pointer;
            margin-right: 8px;
            transition: all 0.2s;
        }
        .feedback-icons i:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        .feedback-icons i.selected {
             opacity: 1;
             color: var(--color-primary);
        }

        /* --- PRINT-FRIENDLY STYLES --- */
        @media print {
            /* --- *** PRINT FIX *** --- */
            html, body {
                overflow: visible !important;
                height: auto !important;
                background-color: #fff;
            }
            body {
                padding: 0;
                margin: 0;
            }
            /* Hide all .no-print elements */
            .no-print {
                display: none !important;
            }

            /* Expand all containers */
            #appContainer, #analyzerWrapper {
                max-height: none;
                overflow: visible !important;
                display: block !important;
                box-shadow: none;
                border: none;
            }
            
            #mainContentArea, #stepContent6 {
                overflow: visible !important;
                height: auto !important;
                display: block !important;
            }
            
            /* Hide ALL tab content by default */
            .tab-content {
                display: none !important; 
            }
            /* ONLY show the one we tag with .print-this */
            .print-this {
                display: block !important;
                visibility: visible;
            }
            #chatView {
                display: none !important; /* Hide chat */
            }

            /* Make the report content visible and printable */
            .print-this #reportContent, 
            .print-this #expertReportContent {
                visibility: visible;
                display: block;
                width: 100%;
                height: auto; /* Let content determine height */
                overflow-y: visible; /* Show all content */
                background: #fff;
                border: none;
                box-shadow: none;
                backdrop-filter: none;
                padding: 0.5in; /* Reduced padding */
                font-size: 11pt;
                color: var(--color-text-dark); /* Use theme dark color */
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            /* Ensure report titles print well */
            .print-this #reportContent strong, 
            .print-this #expertReportContent strong {
                /* REMOVED color: #000; to allow orange to print */
                border-bottom: 2px solid #ccc;
                page-break-after: avoid;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            /* Ensure images in the gallery print */
            .print-this .image-gallery img {
                visibility: visible;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            /* --- *** END PRINT FIX *** */
        }

        /* --- NEW FIX: Maximize Camera Viewport in Step 5 --- */
        /* Hides elements that take up space when the user is scanning */
        .step-5-active #mainHeader,
        .step-5-active #stepIndicatorWrapper {
            display: none;
        }

        .step-5-active #appContainer {
            /* Allow the app container to take full height of the viewport */
            max-height: 100vh; 
            /* This is the key scroll fix */
            overflow: hidden !important; 
        }

        .step-5-active #mainContentArea {
            /* Expand main content area to use all available space */
            flex-grow: 1;
            height: 100%;
            overflow: hidden;
            padding-top: 0;
            padding-bottom: 0;
        }
        .step-5-active #cameraContainer {
            /* Force camera container to take up maximum space */
            height: 80vh; 
            /* Remove margins that cause scrolling */
            margin-bottom: 0 !important;
        }
        .step-5-active #cameraVideo {
            /* Make video fill the container */
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* ====================================================================
        END: CAMERA VIEW FIX
        ======================================================================
        */
        
        /* ======================================================================
        START: NEW "BALLOON TIP" TUTORIAL STYLES
        ======================================================================
        */
        #tutorialTooltip {
            position: absolute; /* Changed from fixed to absolute */
            /* NEW: "Glass-like" translucent style */
            background-color: rgba(255, 255, 255, 0.7); /* Light glass */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--color-text-dark); /* Dark text for readability */
            padding: 1rem 1.25rem; /* Made larger */
            border-radius: 1.25rem; /* More rounded */
            font-size: 0.875rem;
            font-weight: 600;
            line-height: 1.4;
            max-width: 250px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            opacity: 0;
            transform: scale(0.95) translateY(5px);
            transition: all 0.2s ease-out;
            visibility: hidden;
            pointer-events: none; /* So it doesn't block clicks */
            /* NEW: Add drop-shadow filter for the outline */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        #tutorialTooltip.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            visibility: visible;
        }

        /* The little pointer arrow */
        #tutorialTooltip::after {
            content: '';
            position: absolute;
            border: 10px solid transparent; /* Made pointer larger */
        }

        /* Pointing DOWN (when tip is ABOVE element) */
        #tutorialTooltip.pos-top::after {
            top: 100%; /* At the bottom of the balloon */
            left: 50%;
            transform: translateX(-50%);
            border-top-color: rgba(255, 255, 255, 0.7);
            border-bottom-width: 0;
        }

        /* Pointing UP (when tip is BELOW element) */
        #tutorialTooltip.pos-bottom::after {
            bottom: 100%; /* At the top of the balloon */
            left: 50%;
            transform: translateX(-50%);
            border-bottom-color: rgba(255, 255, 255, 0.7);
            border-top-width: 0;
        }

        /* Pointing RIGHT (when tip is to the LEFT of element) */
        #tutorialTooltip.pos-left::after {
            top: 50%;
            left: 100%; /* At the right of the balloon */
            transform: translateY(-50%);
            border-left-color: rgba(255, 255, 255, 0.7);
            border-right-width: 0;
        }

        /* Pointing LEFT (when tip is to the RIGHT of element) */
        #tutorialTooltip.pos-right::after {
            top: 50%;
            right: 100%; /* At the left of the balloon */
            transform: translateY(-50%);
            border-right-color: rgba(255, 255, 255, 0.7);
            border-left-width: 0;
        }
        /* ====================================================================
        END: "BALLOON TIP" TUTORIAL
        ======================================================================
        */
        
        /* --- NEW: Export Modal Styles --- */
        #exportOverlay {
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        #exportTextArea {
            font-family: monospace;
            font-size: 0.8rem;
            background-color: #f4f4f5; /* Zinc 100 */
            color: #3f3f46; /* Zinc 700 */
        }

        /* ======================================================================
        START: NEW STEP 4 GRID STYLES
        ======================================================================
        */
        .location-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--color-secondary);
        }
        .location-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-dark);
            background-color: #fff;
            border: 1px solid var(--color-secondary);
            border-radius: 0.5rem;
            padding: 0.75rem 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.2;
            min-height: 50px;
        }
        .location-cell:hover {
            background-color: #eff6ff; /* Blue 50 */
            border-color: var(--color-primary);
        }
        .location-cell.selected {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-text-dark);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }
        /* ====================================================================
        END: NEW STEP 4 GRID STYLES
        ======================================================================
        */

        /* ======================================================================
        START: NEW UI/UX ENHANCEMENT STYLES
        ======================================================================
        */

        /* --- REMOVED: Tutorial Instruction Box --- */


        /* --- 5. Gallery Slot --- */
        .gallery-slot {
            border: 2px dashed var(--color-secondary);
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.4);
            width: 80px; /* Corresponds to grid-template-columns */
            height: 80px; /* Corresponds to grid-template-columns */
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-secondary);
            font-size: 0.75rem;
            aspect-ratio: 1/1;
        }

        /* --- 1. Sticky Footer --- */
        #mainContentArea {
            /* This will be the only scrolling part */
            overflow-y: auto;
            flex-grow: 1;
            /* Add padding to content area */
            padding: 0.25rem;
            /* *** FIX: Ensure it can shrink on small screens *** */
            min-height: 200px;
            /* NEW: For smooth scrolling */
            scroll-behavior: smooth;
        }
        #actionFooter {
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 1rem;
            padding-bottom: 0.5rem; /* Reduced bottom padding */
            flex-shrink: 0;
        }
        .footer-step-wrapper {
            display: none; /* Hidden by default, JS will show */
        }

        /* --- 4. Step 4 Checklist --- */
        #step4Checklist {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--color-secondary);
        }
        .checklist-item.complete {
            color: var(--color-text-dark);
            font-weight: 600;
        }
        .checklist-item.pending {
            color: var(--color-text-light);
        }

        /* --- 6. Step Animation --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* --- 1. Larger Reading Area (Step 6) --- */
        #reportContent, #expertReportContent {
            /* REMOVED h-96 */
            /* NEW: Let flex-grow handle the height */
            flex-grow: 1;
            overflow-y: auto;
            /* Give it a min-height to push footer down */
            min-height: 400px; 
        }
        /* --- NEW: Chat View Structure --- */
        #chatView {
            /* This is now a top-level view */
            /* REMOVED: display: flex; This was the bug. */
            flex-direction: column;
            /* Use a fixed height for the chat view based on viewport */
            height: 65vh; 
        }
        #chatMessages {
            min-height: 100px;
            flex-grow: 1; /* Make messages area grow */
            overflow-y: auto; /* Make messages scrollable */
        }
        /* --- End Larger Reading Area --- */

        /* ====================================================================
        END: NEW UI/UX ENHANCEMENT STYLES
        ======================================================================
        */
    </style>
</head>
<body class="p-4 sm:p-8">
    <!-- *** MODIFIED: Structural change for sticky footer *** -->
    <div id="appContainer" class="glass-card w-full max-w-sm sm:max-w-xl md:max-w-2xl p-6 flex flex-col max-h-[90vh] relative"> <!-- NEW: Added relative -->

        <!-- === HEADER (Non-scrolling) === -->
        <div class="flex-shrink-0" id="mainHeader">
            <h1 class="text-xl sm:text-2xl font-extrabold text-center no-print">Vastu Pro Analyzer |
    AI Edition</h1>
            
            <!-- *** NEW: Main App Tabs *** -->
            <div class="flex justify-center gap-6 border-b border-gray-200 mt-4 no-print">
                <button id="analyzerTab" class="main-tab active py-2 px-4 font-bold text-lg">
                    <i class="fas fa-camera-retro mr-2"></i>Analyzer
                </button>
                <button id="chatbotTab" class="main-tab py-2 px-4 font-bold text-lg">
                    <i class="fas fa-comment-dots mr-2"></i>Vastu Chatbot
                </button>
            </div>
        </div>

        <!-- === ANALYZER WRAPPER (Steps 1-6) === -->
        <div id="analyzerWrapper" class="flex flex-col flex-grow min-h-0">
            <!-- *** SUGGESTION 2: Icon-Based Step Indicators *** -->
            <div id="stepIndicatorWrapper" class="flex flex-wrap justify-center text-center text-sm border-b pb-2 border-gray-200 no-print mt-6 flex-shrink-0">
                <div id="step1" class="step-indicator m-1" title="FAQ"><i class="fas fa-question-circle text-xl"></i></div>
                <div id="step2" class="step-indicator m-1" title="Sensors"><i class="fas fa-compass text-xl"></i></div>
                <div id="step3" class="step-indicator m-1" title="Context"><i class="fas fa-tasks text-xl"></i></div>
                <div id="step4" class="step-indicator m-1" title="Floor Plan"><i class="fas fa-th-large text-xl"></i></div>
                <div id="step5" class="step-indicator m-1" title="Scan"><i class="fas fa-camera text-xl"></i></div>
                <div id="step6" class="step-indicator m-1" title="Report"><i class="fas fa-file-alt text-xl"></i></div>
            </div>

            <!-- === MAIN CONTENT (Scrolling) === -->
            <div id="mainContentArea" class="my-4">
                <div id="stepContent1" class="step-content no-print">
                    <!-- *** REMOVED: Tutorial Box *** -->
                    <div class="glass-card p-4 rounded-lg border-2 border-blue-100 h-96 overflow-y-auto">
                        <h3 class="font-bold text-lg text-blue-800 mb-3"><i class="fas fa-question-circle mr-2"></i>User FAQ & How-To</h3>
                        <div class="text-sm text-gray-700 space-y-4">
                            <div>
                                <p class="font-bold text-blue-700">Q: How do I get the most accurate scan?</p>
                                <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> Stand in the center of the room and turn in a slow, 360-degree circle. Make sure the room is well-lit so the AI can see everything clearly. The scan takes about 16 seconds.</p>
                            </div>
                            <div>
                                <p class="font-bold text-blue-700">Q: What is the "Holistic Context" in Step 3?</p>
                                <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This is an optional but powerful step. By telling the AI your concerns (e.g., "Financial", "Health"), it can tailor the Vastu remedies specifically to help you with those problems.</p>
                            </div>
                            <!-- UPDATED FAQ for Step 4 -->
                            <div>
                                <p class="font-bold text-blue-700">Q: What is the "Floor Plan" in Step 4?</p>
                                <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This is the most critical step.
                                <br>1. First, select the <strong>type of room</strong> you are in (e.g., "Kitchen").
                                <br>2. Second, select <strong>where that room is located</strong> in your house (e.g., "South-East").
                                <br>This two-part selection is required for an accurate analysis.</p>
                            </div>
                            <div>
                                <p class="font-bold text-blue-700">Q: What's the difference between the two report buttons?</p>
                                <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A: "Formal Report"</strong> gives a full, 5-section analysis with simple, practical remedies. <strong>"Expert Analysis"</strong> gives a short, bulleted list of high-stakes, structural remedies (like moving a wall) that a human expert might suggest.</p>
                            </div>
                             <div>
                                <p class="font-bold text-blue-700">Q: My report failed or was empty. What do I do?</p>
                                <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This can happen if the images are too dark or blurry, triggering the AI's safety filters. Please try scanning again in a room with better lighting.</p>
                            </div>
                            <div>
                                <p class="font-bold text-blue-700">Q: Can I scan just one wall?</p>
                                <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> No. The app is designed to capture all 8 directions in a full 360-degree scan to analyze every Vastu zone, not just one.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Button moved to footer -->
                </div>
                <div id="stepContent2" class="step-content hidden no-print">
                    <!-- *** REMOVED: Tutorial Box *** -->
                    <p class="text-sm text-center text-gray-600 mb-4">Please grant permission to access your device's sensors.</p>
                    <div class="flex justify-center items-center p-4">
                        <div class="relative w-24 h-24 sm:w-32 sm:h-32 bg-white rounded-full border-4 border-gray-300 flex items-center justify-center">
                            <i class="fas fa-compass text-6xl text-gray-400"></i>
                            <i id="compassNeedle" 
        class="fas fa-arrow-up absolute text-red-500 text-3xl transition-transform" style="transform: rotate(0deg);"></i>
                        </div>
                    </div>
                    <p class="text-center font-bold text-lg" id="headingDisplay">Heading: N/A</p>
                    <p class="text-center text-xs text-gray-500 mb-4" id="sensorStatus">Sensors: Inactive</p>
                    <!-- Button moved to footer -->
                </div>

                <div id="stepContent3" class="step-content hidden no-print">
                    <!-- *** REMOVED: Tutorial Box *** -->
                    <p class="text-sm text-center text-gray-600 mb-4">This step is optional, but helps the AI personalize your report.</p>
                    <div class="glass-card p-4 mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-3" id="userConcernsLabel">
                            Step 3a: What are your primary concerns? (Optional)
                            <!-- REMOVED: Info Icon -->
                        </label>
                        <div id="userConcernsContainer" class="grid grid-cols-2 gap-2 text-sm">
                            <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                                <input type="checkbox" class="concern-checkbox" value="Financial">
                                <span><i class="fas fa-wallet mr-1"></i> Financial</span>
                            </label>
                            <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                                <input type="checkbox" class="concern-checkbox" value="Health">
                                <span><i class="fas fa-heartbeat mr-1"></i> Health</span>
                            </label>
                            <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                                <input type="checkbox" class="concern-checkbox" value="Relationships">
                                <span><i class="fas fa-users mr-1"></i> Relationships</span>
                            </label>
                            <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                                <input type="checkbox" class="concern-checkbox" value="Career">
                                <span><i class="fas fa-briefcase mr-1"></i> Career</span>
                            </label>
                        </div>
                    </div>

                    <div class="glass-card p-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            Step 3b: What is surrounding the property? (Optional)
                            <!-- REMOVED: Info Icon -->
                        </label>
                        <div class="space-y-2">
                            <input type="text" id="surroundingsWater" placeholder="E.g., River in North, Lake in East"
                                   class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Water body (lake, river, etc.) and its direction?</p>
                            
                            <input type="text" id="surroundingsHills" placeholder="E.g., Mountain in South-West"
                                   class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Hills or large structures and their direction?</p>
                        </div>
                    </div>
                    <!-- Button moved to footer -->
                </div>
                
                <!-- ======================================================================
                START: STEP 4 (NEW GRID-BASED PLANNER)
                ======================================================================
                -->
                <div id="stepContent4" class="step-content hidden no-print space-y-4">
                    
                    <!-- *** REMOVED: Tutorial Box *** -->

                    <!-- Part 1: Select Room Type -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            Step 4a: What room are you scanning?
                            <!-- REMOVED: Info Icon -->
                        </label>
                        <div id="roomTypeGrid" class="location-grid">
                            <!-- JS will populate this -->
                        </div>
                    </div>

                    <!-- *** NEW: Side-by-side layout (sm:flex) *** -->
                    <div class="sm:flex sm:gap-4 sm:items-start" id="roomLocationTarget">
                        <!-- *** MOVED: STEP 4 VISUAL NORTH GUIDE *** -->
                        <div class="glass-card p-3 sm:w-1/3"> <!-- NEW: sm:w-1/3 -->
                            <label class="block text-sm font-bold text-gray-700 mb-2 text-center">
                                Visual North Guide
                                <!-- REMOVED: Info Icon -->
                            </label>
                            <p class="text-xs text-center text-gray-600 mb-3">Use this to find your direction.</p>
                            <!-- *** NEW: Compass Dial *** -->
                            <div class="flex justify-center items-center">
                                <div class="relative w-24 h-24 bg-white rounded-full border-4 border-gray-300 flex items-center justify-center shadow-inner">
                                    <span class="absolute top-1 text-sm font-bold text-gray-500">N</span>
                                    <span class="absolute bottom-1 text-sm font-bold text-gray-500">S</span>
                                    <span class="absolute left-2.5 text-sm font-bold text-gray-500">W</span>
                                    <span class="absolute right-2.5 text-sm font-bold text-gray-500">E</span>
                                    <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                                    <!-- The existing needle -->
                                    <i id="step4CompassNeedle" class="fas fa-arrow-up absolute text-red-500 text-3xl transition-transform" style="transform: rotate(0deg);"></i>
                                </div>
                            </div>
                             <!-- *** END: Compass Dial *** -->
                        </div>
                        <!-- *** END: STEP 4 VISUAL NORTH GUIDE *** -->

                        <!-- Part 2: Select Location in House -->
                        <div class="sm:w-2/3 mt-4 sm:mt-0"> <!-- NEW: sm:w-2/3 -->
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                Step 4b: Where is this room in your house?
                                <!-- REMOVED: Info Icon -->
                            </label>
                            <div id="roomLocationGrid" class="location-grid">
                                <!-- JS will populate this -->
                            </div>
                        </div>
                    </div>
                    <!-- *** END: Side-by-side layout *** -->

                    
                    <p class="text-center text-xs text-gray-500 my-2 p-2 glass-card" id="currentRoomDisplay">
                        Selected for Scan: <strong>...</strong> (in <strong>...</strong>)
                    </p>

                    <!-- Part 3: Floor Number -->
                    <div class="p-4 glass-card">
                        <label for="floorNumberInput" class="block text-sm font-bold text-gray-700 mb-2">
                            Step 4c: Which floor is this on?
                            <!-- REMOVED: Info Icon -->
                        </label>
                        <input type="text" id="floorNumberInput" placeholder="E.g., 1st Floor, Ground Floor (Required)" 
                               class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- *** SUGGESTION 4: Step 4 Checklist *** -->
                    <div id="step4Checklist" class="glass-card p-4 space-y-2 text-sm rounded-lg">
                        <div id="checklistRoom" class="checklist-item pending"><i class="far fa-square mr-2"></i>Select Room Type</div>
                        <div id="checklistLocation" class="checklist-item pending"><i class="far fa-square mr-2"></i>Select Room Location</div>
                        <div id="checklistFloor" class="checklist-item pending"><i class="far fa-square mr-2"></i>Enter Floor</div>
                    </div>
                    <!-- Button moved to footer -->
                </div>
                <!-- ====================================================================
                END: STEP 4
                ======================================================================
                -->


                <div id="stepContent5" class="step-content hidden no-print">
                    
                    <!-- *** REMOVED: Tutorial Box *** -->

                    <p class="text-sm text-center text-gray-600 mb-4">Hold your device steady and turn in a slow 360Â° circle to capture all zones.</p>

                    <!-- *** BUG FIX: Moved Progress Bar Up *** -->
                    <div id="captureProgressContainer" class="h-2 bg-gray-200 rounded-full mt-2 mb-4 hidden">
                        <div id="captureProgress" class="h-2 bg-green-500 rounded-full transition-all duration-100"></div>
                    </div>
                    
                    <div id="cameraContainer" class="glass-card overflow-hidden mb-4 relative">
                        <!-- *** BUG FIX: Added z-10 *** -->
                        <video id="cameraVideo" autoplay playsinline class="bg-gray-200 hidden relative z-10"></video>
                        
                        <!-- *** BUG FIX: Added z-20. REMOVED transform-gpu *** -->
                        <div id="compassOverlay" class="absolute w-full h-full flex flex-col justify-between p-4 pointer-events-none z-20">
                            
                            <div class="text-center">
                                <span class="inline-block p-1 px-3 bg-black bg-opacity-70 text-white text-3xl font-extrabold rounded-lg shadow-xl" id="overlayHeading">N/A</span>
                            </div>
                            <div class="text-center self-center mb-4">
                                <span class="inline-block p-1 px-3 bg-black bg-opacity-70 text-white text-base rounded-lg font-semibold" id="overlayZone">Zone: Unknown</span>
                            </div>
                        </div>

                        <div id="cameraFallback" class="w-full h-full bg-gray-200 flex flex-col items-center justify-center text-center p-4 absolute top-0 left-0 z-0">
                            <i 
        class="fas fa-video camera-icon"></i>
                            <p class="mt-2 text-sm text-gray-500">Camera access is required for Vastu analysis.</p>
                        </div>
                        
                        <!-- *** FIX: Gallery removed from Step 5 *** -->
                    </div>
                 
                    <p class="text-center text-sm mb-4">
                        <span 
        id="captureCount">0/8</span> Segments Captured. Scan takes ~16 seconds.
                    </p>
         
                    <!-- *** BUG FIX: Removed duplicate progress bar *** -->

                    <!-- *** FIX: Gallery removed from Step 5 *** -->
                    <div id="gallery" class="hidden">
                        <!-- Gallery is no longer shown on this step -->
                    </div>
                    <!-- Button moved to footer -->
                </div>

                <!-- *** STEP 6: Modified for Tabs and Flex *** -->
                <div id="stepContent6" class="step-content hidden h-full flex flex-col">
                    
                    <!-- *** REMOVED: Tutorial Box *** -->

                    <div id="reportLoader" 
        class="text-center py-8 hidden no-print">
                        <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                        <p class="mt-4 font-semibold text-gray-600">Generating Your AI Report...</p>
                        <p class="text-xs text-gray-500 mt-2">Analyzing 8 images. This may take 1-2 minutes, especially on the first try.</p>
                    </div>

                   
                     <!-- *** NEW 3-TAB SYSTEM *** -->
                     <div class="flex border-b border-gray-200 mb-4 no-print flex-shrink-0">
                        <button id="fullReportTab" class="py-2 px-4 text-xs sm:text-sm font-bold text-gray-600 border-b-2 border-transparent transition-colors hover:bg-gray-50">
                            <i class="fas fa-file-alt mr-1"></i> Full Report
                        </button>
                        <button id="expertReportTab" class="py-2 px-4 text-xs sm:text-sm font-bold text-gray-600 border-b-2 border-transparent transition-colors hover:bg-gray-50">
                            <i class="fas fa-exclamation-triangle mr-1"></i> Expert Analysis
                        </button>
                        <!-- *** REMOVED: Chat tab from here *** -->
                    </div>

                    <!-- Tab Content: Full Report -->
                    <div id="fullReportView" class="tab-content">
                        <div id="reportContent" class="glass-card p-4 text-sm report-section">
                            Click "Formal Report" below to generate.
                        </div>
                    </div>
                    
                    <!-- Tab Content: Expert Report -->
                    <div id="expertReportView" class="tab-content hidden">
                        <div id="expertReportContent" class="glass-card p-4 text-sm report-section">
                            Click "Expert Analysis" below to generate.
                        </div>
                    </div>
                    
                    <!-- *** BUG FIX: Removed duplicate chat view *** -->
                    
                </div>
            </div> <!-- === END MAIN CONTENT === -->


            <!-- === STICKY FOOTER (Suggestion 1) === -->
            <div id="actionFooter" class="flex-shrink-0">
                <!-- Step 1 Button -->
                <div id="footerStep1" class="footer-step-wrapper">
                    <button id="tipsNextButton" class="primary-btn w-full p-3 rounded-lg font-bold">
                        Next: Activate Sensors <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
                <!-- Step 2 Button -->
                <div id="footerStep2" class="footer-step-wrapper">
                    <button id="compassButton" class="primary-btn w-full p-3 rounded-lg font-bold">
                        <i class="fas fa-magic mr-2"></i>Activate Sensors
                    </button>
                </div>
                <!-- Step 3 Button -->
                <div id="footerStep3" class="footer-step-wrapper">
                    <button id="holisticNextButton" class="primary-btn w-full p-3 rounded-lg font-bold">
                        Next: Floor Plan <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
                <!-- Step 4 Button -->
                <div id="footerStep4" class="footer-step-wrapper">
                     <button id="cameraButton" class="primary-btn w-full p-3 rounded-lg font-bold" disabled>
                        <i class="fas fa-arrow-right mr-2"></i>Next: Activate Camera
                    </button>
                </div>
                <!-- Step 5 Button -->
                <div id="footerStep5" class="footer-step-wrapper">
                    <button id="captureButton" class="primary-btn w-full p-3 rounded-lg font-bold" disabled>
                        <i class="fas fa-location-arrow mr-2"></i>Start 16-Second Vastu Scan
                    </button>
                </div>
                <!-- Step 6 Buttons -->
                <div id="footerStep6" class="footer-step-wrapper">
                    <!-- *** MODIFIED: Smaller, more compact buttons *** -->
                    <div class="flex flex-wrap gap-2 no-print">
                        <button id="analyzeButton" class="primary-btn p-3 rounded-lg font-bold flex-1" disabled>
                            <i class="fas fa-chart-area mr-2"></i>Formal Report
                         </button>
                        <button id="deepAnalysisButton" class="primary-btn p-3 rounded-lg font-bold bg-blue-500 hover:bg-blue-600 flex-1" style="box-shadow: 0 4px #1d4ed8;" disabled>
                            <i class="fas fa-exclamation-triangle mr-2"></i>Expert Analysis
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2 no-print mt-2">
                        <!-- *** SUGGESTION 3: Scan Again Button *** -->
                        <button id="scanAgainButton" class="secondary-btn p-2 text-sm rounded-lg font-bold flex-1">
                            <i class="fas fa-redo mr-1"></i>New Scan
                        </button>
                        <button id="saveReportButton" class="secondary-btn p-2 text-sm rounded-lg font-bold flex-1 hidden">
                            <i class="fas fa-file-export mr-1"></i>Export .txt
                        </button>
                        <button id="printReportButton" class="secondary-btn p-2 text-sm rounded-lg font-bold flex-1 hidden">
                            <i class="fas fa-print mr-1"></i>Print/Save PDF
                        </button>
                    </div>
                    <!-- *** NEW: Report Feedback Buttons *** -->
                    <div class="flex justify-center items-center gap-4 no-print mt-3 pt-3 border-t border-gray-300/50">
                        <span class="text-xs font-semibold text-gray-600">Was this report helpful?</span>
                        <button class="secondary-btn p-2 text-sm rounded-lg font-bold"><i class="far fa-thumbs-up"></i></button>
                        <button class="secondary-btn p-2 text-sm rounded-lg font-bold"><i class="far fa-thumbs-down"></i></button>
                    </div>
                </div>
            </div>
            <!-- === END STICKY FOOTER === -->
        </div> <!-- === END ANALYZER WRAPPER === -->


        <!-- === NEW: CHATBOT VIEW (Top Level) === -->
        <div id="chatView" class="hidden no-print h-full flex flex-col">
            <div id="chatMessages" class="glass-card p-4 text-sm flex flex-col space-y-2">
                <div class="ai-message chat-message text-gray-700">
                   <i class="fas fa-robot mr-1 text-blue-500"></i>
                    Hello! I am your Vastu AI Assistant. You can ask me general Vastu questions, or complete a scan in the "Analyzer" tab to ask about your specific report.
                </div>
            </div>
            <div class="flex mt-4 flex-shrink-0">
                <input type="text" id="chatInput" placeholder="Ask your Vastu question..." class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800">
                <button id="sendChatButton" class="primary-btn p-3 rounded-r-lg font-bold">
                   <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        <!-- === END CHATBOT VIEW === -->


        <!-- 
        ======================================================================
        START: NEW "BALLOON TIP" TUTORIAL
        ======================================================================
        -->
        <div id="tutorialTooltip" class="no-print">
            <!-- Text will be set by JS -->
        </div>
        <!-- ====================================================================
        END: "BALLOON TIP" TUTORIAL
        ======================================================================
        -->

        <!-- 
        ======================================================================
        START: NEW EXPORT TEXT MODAL
        ======================================================================
        -->
        <div id="exportOverlay" class="fixed inset-0 p-4 z-50 flex justify-center items-center hidden no-print">
            <div class="glass-card w-full max-w-xl p-6 flex flex-col max-h-[80vh]">
                <h3 class="text-xl font-bold mb-4">Export Report Text</h3>
                <p class="text-sm text-gray-600 mb-2">Your browser is blocking automatic downloads. Please copy the text below and paste it into your preferred text editor (like Notepad or TextEdit).</p>
                <textarea id="exportTextArea" class="w-full flex-1 p-3 border border-gray-300 rounded-lg" readonly></textarea>
                <div class="flex gap-4 mt-4">
                    <button id="copyExportButton" class="primary-btn p-3 rounded-lg font-bold flex-1">
                        <i class="fas fa-copy mr-2"></i>Copy to Clipboard
                    </button>
                    <button id="closeExportButton" class="secondary-btn p-3 rounded-lg font-bold w-1/3">
                        Close
                    </button>
                </div>
            </div>
        </div>
        <!-- ====================================================================
        END: EXPORT TEXT MODAL
        ======================================================================
        -->


    </div> <!-- This is the closing tag for #appContainer -->

    <!-- *** REMOVED: VISIBLE DEBUG BUTTON *** -->

    <canvas id="captureCanvas" style="display:none;" class="no-print"></canvas>


    <script type="module">
        // ----------------------------------------------------------------------------------
        // *** CLIENT-SIDE CODE: API KEY IS REMOVED ***
        // ----------------------------------------------------------------------------------
        
        // --- IMPROVEMENT: PASTE YOUR RENDER SERVER URL HERE ---
        // e.g., "https://vastu-app-server.onrender.com"
        const renderApiUrl = "https://test12-6qay.onrender.com"; 
        // ----------------------------------------------------------------------------------
        
        let currentHeading = null;
let isCompassActive = false;
        let isCameraActive = false;
        let isCapturing = false;
        let isReportGenerating = false;
        let isChatGenerating = false;
let videoStream = null;
        let capturedFrames = [];
        let fullReportMarkdown = "";
        let expertReportMarkdown = ""; // *** NEW: Separate expert report ***
        let chatContextSummary = "";
// NEW: Variable to hold the summary for the chatbot
        let chatHistory = [];
let simulationInterval;
        let captureInterval;
        let sensorCheckTimeout; // NEW: Global for the fallback timer
        
        // --- NEW: Tutorial State ---
        let isTutorialActive = true; // Is the main guidance flow active?
        let tutorialTimeout; // To show delayed tips

        const totalCaptures = 8;
const captureIntervalTime = 2000; // 2 seconds
        const scanDuration = totalCaptures * (captureIntervalTime / 1000);
// 16 seconds

        // --- GLOBAL STATE FOR ROOM CONTEXT ---
        let currentRoomTag = null; // Default
let roomLocationInHouse = null; // Default
        let floorNumber = "";

        // --- REMOVED: FLOOR PLANNER GLOBALS ---
        
        const VASTU_ZONES_16 = [
            "N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
            "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"
        ];


        // --- IMPROVEMENT: GLOBAL STATE FOR HOLISTIC CONTEXT ---
        let userIssues = [];
        let propertySurroundings = {}; // e.g., { "Water Body": "North", "Hills": "South-West" }

        // --- DOM Elements (GLOBAL DECLARATIONS) ---
        // These will be assigned values *after* the DOM loads
        let stepContents, stepIndicators, tipsNextButton, headingDisplay, sensorStatus,
            compassNeedle, compassButton, cameraButton, captureCanvas, cameraVideo,
            cameraFallback, overlayHeading, overlayZone, gallery, captureButton,
            captureCountDisplay, captureProgressContainer, captureProgress, analyzeButton,
            deepAnalysisButton, saveReportButton, printReportButton, reportContent,
            reportLoader, 
            chatInput, sendChatButton, currentRoomDisplay,
            floorNumberInput, holisticNextButton,
            userConcernsContainer, surroundingsWater, surroundingsHills,
            mainContentArea, appContainer; // <-- NEW: For scrolling & positioning

        // --- NEW: STEP 4 GRID DOM ELEMENTS ---
        let roomTypeGrid, roomLocationGrid, step4CompassNeedle;
        
        // --- NEW: STICKY FOOTER DOM ELEMENTS ---
        let actionFooter, footerStepWrappers, stepIndicatorWrapper;

        // --- NEW: STEP 4 CHECKLIST DOM ELEMENTS ---
        let checklistRoom, checklistLocation, checklistFloor;

        // --- NEW: SCAN AGAIN BUTTON ---
        let scanAgainButton;
        
        // --- NEW: STEP 6 TABS AND VIEWS (MODIFIED) ---
        let fullReportTab, expertReportTab,
            fullReportView, expertReportView,
            expertReportContent;
            
        // --- NEW: TOP LEVEL APP TABS ---
        let analyzerTab, chatbotTab, analyzerWrapper, chatView, chatMessages;


        // --- NEW: Tutorial Tooltip Element ---
        let tutorialTooltip;
        let currentTutorialElement = null; // Track what the tip is pointing to


        // --- UTILITY FUNCTIONS ---
        function getVastuZone(degrees) {
            // This function is for the COMPASS (0 = North)
            const offset = 11.25;
            let index = Math.floor(((degrees + offset) % 360) / 22.5);
            return VASTU_ZONES_16[index % 16];
}

        // --- REMOVED: Planner Zone Calculation ---
        // function getVastuZoneFromAngle(angle) { ... }


        // IMPROVEMENT: RE-ENABLED asterisk-to-strong conversion
        function formatAITextForDisplay(rawText) {
            let formattedText = rawText;
formattedText = formattedText.replace(/\n\n/g, '<p></p>');
            formattedText = formattedText.replace(/\n/g, '<br>');
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Re-enabled bold
            return formattedText.length > 0 ?
`<div class="pdf-report-body">${formattedText}</div>` : '';
        }

        // IMPROVEMENT: Enabled bolding
        function displayCapturedFrames() {
            let html = `
                <strong class="no-print">VI.
Captured Visual Data Segments (${capturedFrames.length} Frames)</strong>
                <p class="text-sm font-semibold text-gray-600 mt-2 no-print">Scan Context: Data captured for the ${currentRoomTag} area, located in the ${roomLocationInHouse ||
'N/A'} of the entire property, on the ${floorNumber || 'N/A'}.</p>
                <div class="image-gallery">
            `;
capturedFrames.forEach((frame, index) => {
                const zone = getVastuZone(frame.heading);
                const imageUrl = `data:image/jpeg;base64,${frame.image}`;

                html += `
                    <div class="frame-item">
                    
    <img src="${imageUrl}" alt="Segment ${index + 1}" title="Segment ${index + 1}: ${zone}">
                        <div class="frame-data">
                            <span class="text-xs font-bold text-blue-500">#${index + 1}</span> | 
                          
  ${frame.heading.toFixed(1)}Â° 
                        </div>
                    </div>
                `;
            });
html += `</div>`;
            return html;
        }
        
        function formatAITextForTxtExport(rawText) {
             let formattedText = rawText;
formattedText = formattedText.replace(/\n\n/g, '\n\n');
             formattedText = formattedText.replace(/(?<!\n)\n(?!\n)/g, ' ');
             // We still want to format for .txt export
             formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, (match, p1) => `\n\n--- ${p1.toUpperCase()} ---\n`);
             return formattedText;
}

        // --- NEW: Function to generate combined report content (text only) ---
        function getCombinedReportText(isExport = false) {
             const activeReportMarkdown = fullReportTab.classList.contains('active') ? fullReportMarkdown : expertReportMarkdown;

            if (!activeReportMarkdown) {
                // If no report is generated, return null or empty string
                return null;
            }

            // Create Context Header
            const header = `
*** Vastu Pro Analyzer Report ***
Scan Area: ${currentRoomTag} 
Location in House (C-Point): ${roomLocationInHouse || 'N/A'}
Floor: ${floorNumber || 'N/A'}
----------------------------------------------------------------------------------------------------------------------
\n`;
            
            // Format the main body
            const formattedBody = isExport 
                ? formatAITextForTxtExport(activeReportMarkdown) 
                : activeReportMarkdown;

            // Create Footer for Captured Segments
            const footer = `
\n----------------------------------------------------------------------------------------------------------------------
*** Captured Visual Data Segments (Images are NOT included in this text file) ***
${capturedFrames.map((f, i) => `#${i + 1}: ${f.heading.toFixed(1)} degrees (${f.zone})`).join(' | ')}
----------------------------------------------------------------------------------------------------------------------
This file contains the full Vastu analysis.
\n`;

            return header + formattedBody + footer;
        }


        // REMOVED updateStatus function

        // --- *** NEW: Main App Tab Switcher *** ---
        function switchMainTab(target) {
            // --- NEW: Tutorial logic ---
            if (isTutorialActive) {
                // If user clicks Analyzer, start the tutorial flow
                if (target === 'analyzer') {
                    // This is handled by the event listener now
                } else {
                    // If they click chatbot, pause tutorial
                    isTutorialActive = false;
                    hideTutorialTip();
                }
            } else {
                // Show informational tip on click
                if (target === 'analyzer') {
                    showTutorialTip(analyzerTab, "This is the Analyzer. Click 'New Scan' to start over.", 'bottom');
                } else {
                    showTutorialTip(chatbotTab, "Ask me any Vastu questions here.", 'bottom');
                }
                // Hide it after a few seconds
                clearTimeout(tutorialTimeout);
                tutorialTimeout = setTimeout(hideTutorialTip, 3000);
            }
            // --- END: Tutorial logic ---

            if (target === 'analyzer') {
                analyzerTab.classList.add('active');
                chatbotTab.classList.remove('active');
                analyzerWrapper.classList.remove('hidden');
                chatView.classList.add('hidden');
            } else {
                analyzerTab.classList.remove('active');
                chatbotTab.classList.add('active');
                analyzerWrapper.classList.add('hidden');
                chatView.classList.remove('hidden');
                // Scroll chat to bottom
                setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 10);
            }
        }


        // IMPROVEMENT: Updated for 6 steps
        function updateNextStepHighlight(currentStep = 1) {
            
            // --- REMOVED: Tutorial logic from here ---

            // *** FIX: Apply class to body for Step 5 to hide headers/lock scroll ***
            if (currentStep === 5) {
                document.body.classList.add('step-5-active');
            } else {
                document.body.classList.remove('step-5-active');
            }

            stepContents.forEach((content, index) => {
                const stepNum = index + 1;
                stepIndicators[index].classList.remove('step-active');
                if (stepNum === currentStep) {
         
           content.classList.remove('hidden');
                    stepIndicators[index].classList.add('step-active');
                } else {
                    content.classList.add('hidden');
                }
            });

            // --- NEW: Sticky Footer Logic ---
            footerStepWrappers.forEach((wrapper, index) => {
                const stepNum = index + 1;
                if (stepNum === currentStep) {
                    wrapper.style.display = 'block';
                } else {
                    wrapper.style.display = 'none';
                }
            });

            // --- NEW: Hide/Show Step Indicators ---
            if (currentStep === 6) {
                stepIndicatorWrapper.classList.add('hidden');
            } else {
                stepIndicatorWrapper.classList.remove('hidden');
            }
            // --- END ---

            if (currentStep === 4) { // Location Step
                // *** NEW: Auto-activate compass for Step 4 North Guide ***
                if (!isCompassActive) {
                    activateCompass(null); // Pass null to prevent navigation
                }
                checkStep4Completion(); // Check if next button should be enabled
            
            } else if (currentStep === 5) { // Scan Step
                if (capturedFrames.length === 0) {
                    initializeGallerySlots(); // *** NEW (Suggestion 5) ***
                }
                captureButton.disabled = isCapturing || capturedFrames.length >= totalCaptures;

            } else if (currentStep === 6) { // Report Step
                analyzeButton.disabled = isReportGenerating || capturedFrames.length < totalCaptures;
                deepAnalysisButton.disabled = isReportGenerating || capturedFrames.length < totalCaptures; 
            }
            
            // --- Tutorial logic is now handled by the action triggers ---
        }

        // --- *** NEW: Step 4 Grid Logic *** ---
        function initializeStep4Grids() {
            // *** MODIFIED: Added Garage, Utility Room, Garden ***
            const ROOM_TYPES = [
                'Living Room', 'Kitchen', 'Master Bed',
                'Bedroom', 'Pooja Room', 'Toilet/Bath',
                'Main Entrance', 'Study Room', 'Garden/Lawn', 'Utility Room', 'Garage'
            ];

            const LOCATIONS = [
                'NW', 'N', 'NE',
                'W', 'Center', 'E',
                'SW', 'S', 'SE'
            ];

            roomTypeGrid.innerHTML = '';
            ROOM_TYPES.forEach(type => {
                const cell = document.createElement('div');
                cell.className = 'location-cell';
                cell.textContent = type;
                cell.dataset.value = type;
                cell.addEventListener('click', () => selectGridCell(roomTypeGrid, cell, 'room'));
                roomTypeGrid.appendChild(cell);
            });

            roomLocationGrid.innerHTML = '';
            LOCATIONS.forEach(loc => {
                const cell = document.createElement('div');
                cell.className = 'location-cell';
                cell.textContent = loc;
                cell.dataset.value = loc;
                cell.addEventListener('click', () => selectGridCell(roomLocationGrid, cell, 'location'));
                roomLocationGrid.appendChild(cell);
            });

            updateRoomDisplay(); // Set initial text
            updateChecklist(); // Set initial checklist
        }

        function selectGridCell(grid, cell, type) {
            // Remove 'selected' from all siblings
            Array.from(grid.children).forEach(c => c.classList.remove('selected'));
            // Add 'selected' to the clicked cell
            cell.classList.add('selected');

            if (type === 'room') {
                currentRoomTag = cell.dataset.value;
                
                // --- NEW: Update tutorial based on specific room ---
                if (isTutorialActive) {
                    let nextTip = "Now tap the <strong>Room's Location</strong> in your house.";
                    if (currentRoomTag === 'Main Entrance') {
                        nextTip = "Since this is the **Main Entrance**, stand at the center of the doorway for the most accurate reading. Then select the location below.";
                    } else if (currentRoomTag === 'Garden/Lawn') {
                        nextTip = "For the **Garden**, stand at the center-most part of the open area. Then select the location below.";
                    } else if (currentRoomTag === 'Garage') {
                         nextTip = "Since this is the **Garage**, stand at the center of the entire structure or the entrance. Then select the location below.";
                    }
                    showTutorialTip(step4CompassNeedle, `1. Use the compass to find North. 2. ${nextTip}`, 'right');
                    clearTimeout(tutorialTimeout);
                    // *** FIX: Autoscroll and re-show tip *after* scroll ***
                    mainContentArea.scrollTo({ top: 0, behavior: 'smooth' });
                    tutorialTimeout = setTimeout(() => {
                        showTutorialTip(roomLocationGrid, `2. Now tap the <strong>Room's Location</strong> in your house.`, 'bottom');
                    }, 350); // Short delay to let autoscroll finish
                }

            } else if (type === 'location') {
                roomLocationInHouse = cell.dataset.value;
                // --- NEW: Auto-scroll and update tutorial ---
                if (isTutorialActive) {
                    clearTimeout(tutorialTimeout); // Cancel previous timeout
                    floorNumberInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    floorNumberInput.focus();
                    showTutorialTip(floorNumberInput, "Perfect! Last thing: enter the <strong>Floor Number</strong>.", 'top');
                }
            }

            updateRoomDisplay();
            checkStep4Completion();
        }

        function updateRoomDisplay() {
            const room = currentRoomTag || '...';
            const loc = roomLocationInHouse || '...';
            currentRoomDisplay.innerHTML = `Selected for Scan: <strong>${room}</strong> (in <strong>${loc}</strong> zone)`;
        }

        function checkStep4Completion() {
            // Check if all 3 parts of Step 4 are complete
            const allDone = currentRoomTag && roomLocationInHouse && floorNumber.trim().length > 0;
            
            if (allDone) {
                cameraButton.disabled = false;
                if (isTutorialActive) {
                    hideTutorialTip(); // Hide tutorial on complete
                    showTutorialTip(cameraButton, "All set! Tap here to start the camera.", 'top');
                }
            } else {
                cameraButton.disabled = true;
                // Tutorial text is handled by selectGridCell and floorNumberInput listener
            }
            updateChecklist(); // *** NEW (Suggestion 4) ***
        }

        // --- *** NEW: Step 4 Checklist UI Function (Suggestion 4) *** ---
        function updateChecklist() {
            if (checklistRoom) { // Add safety checks
                if (currentRoomTag) {
                    checklistRoom.innerHTML = `<i class="far fa-check-square mr-2 text-green-500"></i>Room: <strong>${currentRoomTag}</strong>`;
                    checklistRoom.className = 'checklist-item complete';
                } else {
                    checklistRoom.innerHTML = `<i class="far fa-square mr-2"></i>Select Room Type`;
                    checklistRoom.className = 'checklist-item pending';
                }
            }

            if (checklistLocation) {
                if (roomLocationInHouse) {
                    checklistLocation.innerHTML = `<i class="far fa-check-square mr-2 text-green-500"></i>Location: <strong>${roomLocationInHouse}</strong>`;
                    checklistLocation.className = 'checklist-item complete';
                } else {
                    checklistLocation.innerHTML = `<i class="far fa-square mr-2"></i>Select Room Location`;
                    checklistLocation.className = 'checklist-item pending';
                }
            }

            if (checklistFloor) {
                if (floorNumber.trim().length > 0) {
                    checklistFloor.innerHTML = `<i class="far fa-check-square mr-2 text-green-500"></i>Floor: <strong>${floorNumber}</strong>`;
                    checklistFloor.className = 'checklist-item complete';
                } else {
                    checklistFloor.innerHTML = `<i class="far fa-square mr-2"></i>Enter Floor`;
                    checklistFloor.className = 'checklist-item pending';
                }
            }
        }
        // --- *** END: Step 4 Grid Logic *** ---

        
        // --- *** MODIFIED: For 3 Tabs *** ---
        function switchReportTab(target) {
            hideTutorialTip(); // Hide tip on tab switch
            // Reset all tabs to inactive state
            fullReportTab.classList.remove('border-blue-500', 'border-b-2', 'text-blue-800');
            expertReportTab.classList.remove('border-blue-500', 'border-b-2', 'text-blue-800');
            // chatTab.classList.remove('border-blue-500', 'border-b-2', 'text-blue-800');
            fullReportTab.classList.add('border-transparent', 'text-gray-600');
            expertReportTab.classList.add('border-transparent', 'text-gray-600');
            // chatTab.classList.add('border-transparent', 'text-gray-600');

            // Hide all views
            fullReportView.classList.add('hidden');
            expertReportView.classList.add('hidden');
            // chatView.classList.add('hidden');

            if (target === 'full') {
                fullReportTab.classList.remove('border-transparent', 'text-gray-600');
                fullReportTab.classList.add('border-blue-500', 'border-b-2', 'text-blue-800');
                fullReportView.classList.remove('hidden');
            } else if (target === 'expert') {
                expertReportTab.classList.remove('border-transparent', 'text-gray-600');
                expertReportTab.classList.add('border-blue-500', 'border-b-2', 'text-blue-800');
                expertReportView.classList.remove('hidden');
            } 
            // Chat is handled by switchMainTab
        }

        // ----------------------------------------------------------------------------------
        // --- NEW: "BALLOON TIP" TUTORIAL FUNCTIONS ---
        // ----------------------------------------------------------------------------------

        function showTutorialTip(targetElement, text, position = 'top') {
            if (!tutorialTooltip || !targetElement) return;

            // Clear any pending hide timeouts
            clearTimeout(tutorialTimeout);

            // Set text and position class
            tutorialTooltip.innerHTML = text;
            // Remove all old positions
            tutorialTooltip.className = 'no-print'; 
            
            // Get coordinates
            const targetRect = targetElement.getBoundingClientRect();
            const appRect = appContainer.getBoundingClientRect(); // Get app container's rect
            
            // Calculate position relative to the appContainer (which is position: relative)
            const topOffset = appRect.top;
            const leftOffset = appRect.left;

            // Get tip dimensions *after* setting text
            const tipRect = tutorialTooltip.getBoundingClientRect();

            let top, left;
            let finalPosition = position; // Store the final position

            // --- NEW: Boundary Detection ---
            const tipHeight = tipRect.height;
            const tipWidth = tipRect.width;
            const gap = 12; // 12px arrow + gap

            // Check Top/Bottom
            if (position === 'top') {
                // If top edge is less than 0 (off the top), flip to bottom
                if (targetRect.top - tipHeight - gap < 0) { 
                    finalPosition = 'bottom';
                }
            } else if (position === 'bottom') {
                 // If bottom edge is beyond app container height, flip to top
                if (targetRect.bottom + tipHeight + gap > appRect.bottom) { 
                    finalPosition = 'top';
                }
            }

            // Check Left/Right
            if (position === 'left') {
                if (targetRect.left - leftOffset - tipWidth - gap < 0) { // Not enough space at left
                    finalPosition = 'right';
                }
            } else if (position === 'right') {
                if (targetRect.right - leftOffset + tipWidth + gap > appRect.width) { // Not enough space at right
                    finalPosition = 'left';
                }
            }
            // --- End Boundary Detection ---

            // Re-calculate based on finalPosition
            switch (finalPosition) {
                case 'top':
                    top = targetRect.top - topOffset - tipHeight - gap;
                    left = targetRect.left - leftOffset + (targetRect.width / 2) - (tipWidth / 2);
                    break;
                case 'bottom':
                    top = targetRect.bottom - topOffset + gap;
                    left = targetRect.left - leftOffset + (targetRect.width / 2) - (tipWidth / 2);
                    break;
                case 'left':
                    top = targetRect.top - topOffset + (targetRect.height / 2) - (tipHeight / 2);
                    left = targetRect.left - leftOffset - tipWidth - gap;
                    break;
                case 'right':
                    top = targetRect.top - topOffset + (targetRect.height / 2) - (tipHeight / 2);
                    left = targetRect.right - leftOffset + gap;
                    break;
            }

            // Apply styles
            tutorialTooltip.style.top = `${top}px`;
            tutorialTooltip.style.left = `${left}px`;
            
            // Show it
            tutorialTooltip.classList.add(`pos-${finalPosition}`); // Add the correct arrow class
            tutorialTooltip.classList.add('visible');
            currentTutorialElement = targetElement;
        }

        function hideTutorialTip() {
             if (tutorialTooltip) {
                tutorialTooltip.classList.remove('visible');
             }
             currentTutorialElement = null;
        }

        // ----------------------------------------------------------------------------------
        // --- STEP 2: COMPASS ACTIVATION (FIXED WITH TIMEOUT FALLBACK) ---
        // ----------------------------------------------------------------------------------
        
        function handleOrientation(event) {
            let heading;
if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading; // iOS
} else if (event.alpha !== null) {
                // Use absolute orientation if available (0 = North)
                if (event.absolute === true || typeof event.absolute === 'undefined') {
                     heading = (360 - event.alpha) % 360; 
                } else {
                    // Fallback for relative orientation (less reliable)
                    // We can't be sure where "0" is.
                    // For this app, absolute is required.
                    console.warn("Relative orientation not supported. Using 0.");
                    heading = (360 - event.alpha) % 360; // Assume it's absolute-like
                }
} else {
                return;
}
            
            if (sensorCheckTimeout) {
                clearTimeout(sensorCheckTimeout);
sensorCheckTimeout = null;
            }

            currentHeading = parseFloat(heading.toFixed(1));
if (headingDisplay) headingDisplay.textContent = `${currentHeading}Â°`;
            if (overlayHeading) overlayHeading.textContent = `${currentHeading}Â°`;
            if (compassNeedle) compassNeedle.style.transform = `rotate(-${currentHeading}deg)`;
            if (overlayZone) overlayZone.textContent = `Zone: ${getVastuZone(currentHeading)}`;

            // *** NEW: Update Step 4 compass needle ***
            if (step4CompassNeedle) {
                step4CompassNeedle.style.transform = `rotate(-${currentHeading}deg)`;
            }
        }

        // Handles permission request on iOS
        function requestIOSSensorPermission(navigateToStep) {
             if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                      
  if (permissionState === 'granted') {
                            // Add listeners *after* permission is granted
                            window.addEventListener('deviceorientation', handleOrientation);
                            window.addEventListener('deviceorientationabsolute', handleOrientation);
                            startCompassLogic(navigateToStep); // Now start the logic
     
                   } else {
                            // Permission denied
                            console.warn("Sensor permission denied by user.");
                            startCompassSimulation(navigateToStep);
        }
                    })
                    .catch(e => {
    console.error('Sensor permission error:', e);
                        startCompassSimulation(navigateToStep); // Fallback on error
                    });
} else {
                // Not iOS 13+, or not a function
                startCompassLogic(navigateToStep);
}
        }

        // Start logic with original, complex listener attachment check
        function startCompassLogic(navigateToStep = null) {
            if (isCompassActive) return;
            
            if (window.DeviceOrientationEvent) {
                // Add listeners (if not already added by iOS permission)
                // This check avoids duplicate listeners
                if (typeof DeviceOrientationEvent.requestPermission !== 'function') { 
                     window.addEventListener('deviceorientation', handleOrientation);
                     window.addEventListener('deviceorientationabsolute', handleOrientation);
                }
            } else {
                 startCompassSimulation(navigateToStep); // No sensors found
return;
            }

            sensorCheckTimeout = setTimeout(() => {
                if (currentHeading === null) {
                    // No sensor data received after 1s
                    console.warn("No sensor data. Falling back to simulation.");
                    stopCompassLogic(); // Stop listeners
                    startCompassSimulation(navigateToStep);
                } 
            }, 1000); // 1 second timeout


            isCompassActive = true;
if (sensorStatus) sensorStatus.textContent = 'Sensors: Active';
            // --- BUTTON REVERTED TO SEQUENTIAL ---
            compassButton.classList.remove('primary-btn');
            compassButton.classList.add('bg-gray-400');
            compassButton.innerHTML = '<i class="fas fa-check mr-2"></i>Sensors Active';
            compassButton.style.boxShadow = 'none';
            compassButton.disabled = true; // Not a toggle
            
            // *** NEW CONDITIONAL NAVIGATION ***
            if (navigateToStep) {
                updateNextStepHighlight(navigateToStep);
                // --- NEW: Auto-scroll ---
                if (mainContentArea) setTimeout(() => mainContentArea.scrollTo({ top: 0, behavior: 'smooth' }), 100);
            }
        }

        function startCompassSimulation(navigateToStep = null) {
            if (isCompassActive) return;
isCompassActive = true;
            let simHeading = 0;
            if (sensorStatus) sensorStatus.textContent = 'Sensors: SIMULATION (Not Found)';
simulationInterval = setInterval(() => {
                simHeading = (simHeading + 0.1) % 360; 
                currentHeading = parseFloat(simHeading.toFixed(1));
                if (headingDisplay) headingDisplay.textContent = `Heading: ${currentHeading}Â° (SIM)`;
                if (overlayHeading) overlayHeading.textContent = `${currentHeading}Â° (SIM)`;
                

                if (compassNeedle) compassNeedle.style.transform = `rotate(-${currentHeading}deg)`;
                if (overlayZone) overlayZone.textContent = 'Zone: Unknown';

                // *** NEW: Update Step 4 compass needle ***
                if (step4CompassNeedle) {
                    step4CompassNeedle.style.transform = `rotate(-${currentHeading}deg)`;
                }
            }, 100);
            
            // --- BUTTON REVERTED TO SEQUENTIAL ---
            compassButton.classList.remove('primary-btn');
            compassButton.classList.add('bg-gray-400');
            compassButton.innerHTML = '<i class="fas fa-check mr-2"></i>Simulation Active';
            compassButton.style.boxShadow = 'none';
            compassButton.disabled = true; // Not a toggle
            
            // *** NEW CONDITIONAL NAVIGATION ***
            if (navigateToStep) {
                updateNextStepHighlight(navigateToStep);
                // --- NEW: Auto-scroll ---
                if (mainContentArea) setTimeout(() => mainContentArea.scrollTo({ top: 0, behavior: 'smooth' }), 100);
            }
        }
        
        // --- REFACTORED activateCompass ---
        function activateCompass(navigateToStep = null) {
            // --- REVERTED: No longer a toggle ---
            if (isCompassActive) {
                // *** NEW: If already active, just navigate ***
                if (navigateToStep) {
                    updateNextStepHighlight(navigateToStep);
                    // --- NEW: Auto-scroll ---
                    if (mainContentArea) setTimeout(() => mainContentArea.scrollTo({ top: 0, behavior: 'smooth' }), 100);
                }
                return;
            }
            
            // --- NEW: Hide tutorial on click ---
            hideTutorialTip();

            // --- NEW PERMISSION-FIRST LOGIC ---
            if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // This is iOS 13+. Must request permission.
                requestIOSSensorPermission(navigateToStep);
            } 
            else if (window.DeviceOrientationEvent) {
                // This is Android or other non-iOS. No permission needed.
                startCompassLogic(navigateToStep);
            } 
            else {
                // No sensors detected.
                startCompassSimulation(navigateToStep);
            }
        }


        function stopVideoStream() {
            if (!isCameraActive) return; // Already stopped
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            isCameraActive = false;
            cameraVideo.classList.add('hidden');
            cameraFallback.classList.remove('hidden');

            // Reset button state (back on Step 4)
            cameraButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-gray-400');
            cameraButton.classList.add('primary-btn');
            cameraButton.innerHTML = `<i class="fas fa-arrow-right mr-2"></i>Next: Activate Camera`;
            cameraButton.style.boxShadow = '0 4px var(--color-text-dark)';
            checkStep4Completion(); // Re-check if button should be enabled
        }

        function stopCompassLogic() {
            if (!isCameraActive) return; // Already stopped
            isCameraActive = false;
            if (sensorStatus) sensorStatus.textContent = 'Sensors: Inactive';
            
            // Reset button state
            compassButton.classList.remove('primary-btn');
            compassButton.classList.add('bg-gray-400');
            compassButton.innerHTML = '<i class="fas fa-check mr-2"></i>Sensors Active';
            compassButton.style.boxShadow = 'none';
            compassButton.disabled = true; // Not a toggle
            
            if (headingDisplay) headingDisplay.textContent = 'Heading: N/A';
            if (overlayHeading) overlayHeading.textContent = 'N/A';
            if (compassNeedle) compassNeedle.style.transform = `rotate(0deg)`;
            if (step4CompassNeedle) {
                step4CompassNeedle.style.transform = `rotate(0deg)`;
            }
            if (overlayZone) overlayZone.textContent = 'Zone: Unknown';

            window.removeEventListener('deviceorientation', handleOrientation);
            window.removeEventListener('deviceorientationabsolute', handleOrientation);
if (simulationInterval) {
                clearInterval(simulationInterval);
simulationInterval = null;
            }
            if (sensorCheckTimeout) {
                clearTimeout(sensorCheckTimeout);
sensorCheckTimeout = null;
            }
        }


        async function activateCamera() {
            // This button is now ONLY a "Next" button on Step 4
            const currentStep = Array.from(stepIndicators).findIndex(s => s.classList.contains('step-active')) + 1;

            if (currentStep === 4) {
                hideTutorialTip(); // Hide tip on click
                // We are on the floor plan step. Move to camera step.
                // We also need to activate the compass FOR the camera step
                if (!isCompassActive) {
                    activateCompass(null); // *** FIX: Pass null to prevent navigation ***
                }
                updateNextStepHighlight(5); // Go to Step 5
                // --- NEW: Auto-scroll ---
                if (mainContentArea) setTimeout(() => mainContentArea.scrollTo({ top: 0, behavior: 'smooth' }), 100);
                
                // Now, activate the camera
                if (isCameraActive) return; // Already on
                if (isCapturing) return; // Don't mess with it

                 try {
                    videoStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            // *** FIX: Request higher res/wider view ***
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        } 
                    });
                    cameraVideo.srcObject = videoStream;
                    cameraVideo.classList.remove('hidden'); 
                    cameraFallback.classList.add('hidden');
                    await cameraVideo.play();
                    isCameraActive = true;
                } catch (err) {
                    console.error('Camera access error:', err);
                    cameraVideo.classList.add('hidden');
                    cameraFallback.classList.remove('hidden');
                }
            }
        }

        function captureCurrentFrame() {
            const video = cameraVideo;
const canvas = captureCanvas;
            const context = canvas.getContext('2d');

            if (!isCameraActive || !currentHeading) {
                console.error("Cannot capture: Camera or compass is inactive.");
return null;
            }
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                console.warn("Video dimensions not ready yet. Skipping this frame capture.");
return null;
            }
            const size = Math.min(video.videoWidth, video.videoHeight);
canvas.width = size;
            canvas.height = size;
            const startX = (video.videoWidth - size) / 2;
const startY = (video.videoHeight - size) / 2;
            context.drawImage(video, startX, startY, size, size, 0, 0, size, size);
            
            // Payload Size Reduced: 0.1 -> 0.05
const dataUrl = canvas.toDataURL('image/jpeg', 0.05); 
            const base64Data = dataUrl.split(',')[1];
            
            return {
                image: base64Data, 
                heading: currentHeading,
                zone: getVastuZone(currentHeading),
                timestamp: Date.now()
            };
}

        function startCapture() {
            if (isCapturing) return;

            if (!isCompassActive || !isCameraActive) {
                alert("Please ensure sensors and camera are active (Steps 2 & 5).");
                return;
            }
            
            // Data now comes from the planner, but we still need floor number
            if (!floorNumber || floorNumber.length < 1) {
                alert("Please go back to Step 4 and enter the 'Floor Number' before scanning.");
return;
            }
            
            isCapturing = true;
            hideTutorialTip(); // Hide tutorial on action
capturedFrames = [];
            captureCountDisplay.textContent = `0/${totalCaptures}`;
            captureButton.disabled = true;
            captureButton.textContent = 'Scanning... (Hold Steady)';
            // gallery.innerHTML = ''; // --- MODIFIED: Don't clear, just let it be overwritten
            captureProgressContainer.classList.remove('hidden');
captureProgress.style.width = '0%';
            analyzeButton.disabled = true;
            deepAnalysisButton.disabled = true; // Disable new button
            saveReportButton.classList.add('hidden');
            printReportButton.classList.add('hidden'); // Hide print button
let capturesTaken = 0;
            
            const executeCapture = () => {
                const frameData = captureCurrentFrame();
if (frameData) {
                    capturedFrames.push(frameData);
capturesTaken++;
                    // *** FIX: Gallery removed from step 5, so we skip this ***
                    // displayCapturedFrame(frameData, capturesTaken - 1);
                    captureCountDisplay.textContent = `${capturesTaken}/${totalCaptures}`;
                    captureProgress.style.width = `${(capturesTaken / totalCaptures) * 100}%`;
if (capturesTaken >= totalCaptures) {
                        clearInterval(captureInterval);
endCapture();
                    }
                }
            };
executeCapture(); 
            captureInterval = setInterval(executeCapture, captureIntervalTime);
            
            setTimeout(() => {
                if(isCapturing) {
                    clearInterval(captureInterval);
                    endCapture(); 
                }
            }, captureIntervalTime * totalCaptures + 500);
}

        function endCapture() {
            isCapturing = false;
captureProgressContainer.classList.add('hidden');
            captureButton.textContent = 'Start 16-Second Vastu Scan';
            captureButton.disabled = false;
            
            stopVideoStream();
            stopCompassLogic();
if (capturedFrames.length === totalCaptures) {
                // IMPROVEMENT: Go to new Step 6 (Report)
                updateNextStepHighlight(6);
                if(isTutorialActive) showTutorialTip(analyzeButton, "Scan complete! Tap here for your <strong>Formal Report</strong>.", 'bottom');
analyzeButton.disabled = false;
                deepAnalysisButton.disabled = false; // Enable new button
            } else {
                // IMPROVEMENT: Go to new Step 6 (Report)
                updateNextStepHighlight(6);
analyzeButton.disabled = true; 
                deepAnalysisButton.disabled = true; // Keep disabled
            }
            // --- NEW: Auto-scroll ---
            if (mainContentArea) setTimeout(() => mainContentArea.scrollTo({ top: 0, behavior: 'smooth' }), 100);
        }

        // --- *** (FIXED) Function to fill one gallery slot *** ---
        function displayCapturedFrame(frame, index) {
            // *** FIX: Gallery removed from step 5, this function is no longer called in a loop ***
            // It is ONLY called by displayCapturedFrames (plural) in the final report
            if (!gallery) return; 
            const allSlots = gallery.children;
            if (index >= allSlots.length) return; // Safety check

            const slot = allSlots[index];
            slot.innerHTML = ''; // Clear the slot number
            slot.classList.remove('gallery-slot');
            slot.classList.add('frame-item');

            const img = document.createElement('img');
            img.src = `data:image/jpeg;base64,${frame.image}`;
            img.alt = `Segment ${index + 1}: ${frame.zone}`;
            img.title = `Segment ${index + 1}: ${frame.zone} (${frame.heading}Â°)`;
            
            const labelContainer = document.createElement('div');
            labelContainer.className = 'frame-data';
            labelContainer.innerHTML = `<span class="text-xs font-bold text-blue-500">#${index + 1}</span> | ${frame.heading.toFixed(1)}Â°`;

            slot.appendChild(img);
            slot.appendChild(labelContainer);
        }

        // --- *** NEW: Function to create empty gallery slots (Suggestion 5) *** ---
        function initializeGallerySlots() {
            // *** FIX: Gallery removed from step 5 ***
            if (!gallery) return; 
            gallery.innerHTML = ''; // Clear previous images
            for (let i = 0; i < totalCaptures; i++) {
                const slot = document.createElement('div');
                slot.className = 'gallery-slot';
                slot.innerHTML = `<i class="far fa-image"></i>`;
                gallery.appendChild(slot);
            }
        }
        
        // --- STEP 6: REPORT GENERATION (SYNCHRONOUS) ---

        // IMPROVEMENT: Added isDeepAnalysis flag
        async function generateReport(isDeepAnalysis = false) {
            if (isReportGenerating || capturedFrames.length < totalCaptures) {
return;
            }
            
            // SERVER-CLIENT CHANGE: Check for Render URL
            if (renderApiUrl.includes("YOUR_RENDER_URL_HERE") || renderApiUrl.length < 10) {
reportContent.innerHTML = formatAITextForDisplay(`**Error:** Server not configured. Please paste your Render server's URL into the 'renderApiUrl' variable at the top of the script.`);
return;
            }

            isReportGenerating = true;
            hideTutorialTip(); // Hide tutorial on action
            isTutorialActive = false; // Main tutorial flow is done
            // *** MODIFIED: Clear specific report variables ***
            if (isDeepAnalysis) {
                expertReportMarkdown = "";
            } else {
                fullReportMarkdown = "";
            }
            chatContextSummary = ""; // Reset summary
            // chatHistory = []; // --- MODIFIED: Don't reset history
            // *** NEW: Show loader, switch tab ***
            reportLoader.classList.remove('hidden');
            if (isDeepAnalysis) {
                expertReportContent.innerHTML = '';
                switchReportTab('expert');
            } else {
                reportContent.innerHTML = '';
                switchReportTab('full');
            }

            analyzeButton.disabled = true;
            deepAnalysisButton.disabled = true; // Disable new button
            saveReportButton.classList.add('hidden');
            printReportButton.classList.add('hidden'); // Hide print button
            if (chatInput) chatInput.disabled = true; // Chat is disabled during generation
            if (sendChatButton) sendChatButton.disabled = true;

            // scanAgainButton.disabled = true; // <-- MODIFIED: This is now REMOVED to keep "New Scan" active

            // Format holistic context for the prompt
            let holisticIssues = "None specified";
            if (userIssues.length > 0) {
                holisticIssues = userIssues.join(', ');
            }
            
            let holisticSurroundings = "None specified";
            const surroundingsEntries = Object.entries(propertySurroundings).filter(([key, value]) => value.trim() !== "");
            if (surroundingsEntries.length > 0) {
                holisticSurroundings = surroundingsEntries.map(([key, value]) => `${key}: ${value}`).join('; ');
            }

            // SERVER-CLIENT CHANGE: Create the payload for our *own* server
            const clientPayload = {
                isDeepAnalysis: isDeepAnalysis,
                scanData: {
                    capturedFrames: capturedFrames.map(f => ({ 
                        image: f.image, 
                        heading: f.heading, 
                        zone: f.zone 
                    })),
                    // --- UPDATED CONTEXT ---
                    currentRoomTag: currentRoomTag,
                    roomLocationInHouse: roomLocationInHouse,
                    floorNumber: floorNumber,
                    // --- END UPDATED CONTEXT ---
                    holisticIssues: holisticIssues,
                    holisticSurroundings: holisticSurroundings
                }
            };
            
            // --- NEW: Client-side Timeout (Fixes "forever" & "keeps generating") ---
            const controller = new AbortController();
            const timeoutDuration = 180000; // 3 minutes (180,000 ms)
            const timeoutId = setTimeout(() => {
                console.warn("Client-side timeout reached. Aborting fetch.");
                controller.abort();
            }, timeoutDuration);
            // --- END: Client-side Timeout ---

try {
                // SERVER-CLIENT CHANGE: Call our Render server, not Google
                const apiUrl = `${renderApiUrl}/api/generateReport`;
const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clientPayload),
                    signal: controller.signal // <-- Add signal
                });

                clearTimeout(timeoutId); // <-- Clear timeout if fetch succeeds

if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Server Error: ${response.status} - ${errorData.error || 'Failed to fetch'}`);
}

                const result = await response.json();
                const reportText = result.text || ""; // Get the raw text
                
                if (!reportText) {
                    throw new Error("API returned an empty response. This is likely due to the API's safety filters (e.g., a blurry/dark image) or a silent timeout. Please try scanning again in a well-lit area.");
}

                // IMPROVEMENT: Always update chat context
                const summaryEndMarker = '**II. Directional Data and Environmental Assessment**'; 
                const summaryEndIndex = reportText.indexOf(summaryEndMarker);

                if (summaryEndIndex !== -1) { // It's a Formal Report, grab the summary
                    chatContextSummary = reportText.substring(0, summaryEndIndex).trim();
} else { // It's an Expert Analysis, just grab the first 500 chars for context
                    chatContextSummary = reportText.substring(0, 500).trim();
}
                
                // *** NEW: Populate correct view and variable ***
                const formattedHtml = formatAITextForDisplay(reportText) + displayCapturedFrames();
                if (isDeepAnalysis) {
                    expertReportMarkdown = reportText; // Save to correct variable
                    expertReportContent.innerHTML = formattedHtml;
                } else {
                    fullReportMarkdown = reportText; // Save to correct variable
                    reportContent.innerHTML = formattedHtml;
                }

                saveReportButton.classList.remove('hidden');
                printReportButton.classList.remove('hidden'); // Show print button
                if (chatInput) chatInput.disabled = false; // Re-enable chat
                if (sendChatButton) sendChatButton.disabled = false;
} catch (error) {
                clearTimeout(timeoutId); // <-- Clear timeout if fetch fails
                console.error('Chatbot Error:', error);

                let specificErrorMessage = error.message;
                if (error.name === 'AbortError') {
                    specificErrorMessage = "The request took too long and was timed out by the app (3-minute limit). This can happen if the AI server is very busy or slow to start. Please try again.";
                }

let errorHtml = formatAITextForDisplay(`**I. Executive Summary (Layman's Terms)**\n\nReport generation failed due to an error.`);
errorHtml += `<p class="text-red-600 font-bold mt-4">REPORT GENERATION FAILED</p>
                              <p class="mt-2 text-sm">A critical API error occurred.
Please try running the scan again.</p>
                              <p class="mt-2 text-xs text-gray-400">Error Details: ${error.message}</p>`;
                
                // *** NEW: Populate correct view with error ***
                if (isDeepAnalysis) {
                    expertReportContent.innerHTML = errorHtml + displayCapturedFrames();
                } else {
                    reportContent.innerHTML = errorHtml + displayCapturedFrames();
                }
            } finally {
                isReportGenerating = false;
reportLoader.classList.add('hidden');
                analyzeButton.disabled = false;
                deepAnalysisButton.disabled = false; // Re-enable
                // scanAgainButton.disabled = false; // <-- MODIFIED: This is now REMOVED
            }
        }

        // --- TEXT EXPORT LOGIC ---
        function exportReportAsTxt() {
            // *** NEW: Check which report is active ***
            let reportToExport = "";
            if (fullReportTab.classList.contains('active')) {
                reportToExport = fullReportMarkdown;
            } else if (expertReportTab.classList.contains('active')) {
                reportToExport = expertReportMarkdown;
            }

            // *** FIX: Use a more reliable check for content ***
            const reportText = getCombinedReportText(true);

            if (!reportText) {
                alert("Please generate a report first.");
                return;
            }
            
            // --- MODIFICATION: Bypassing Sandbox ---
            
            // 1. Generate the text content
            const fullTextContent = reportText; // Already formatted by getCombinedReportText(true)

            // 2. Put text in the new modal's textarea
            document.getElementById('exportTextArea').value = fullTextContent;

            // 3. Show the modal
            document.getElementById('exportOverlay').classList.remove('hidden');

            // --- REMOVED OLD BLOCKED CODE ---
            // const blob = new Blob([fullTextContent], { type: 'text/plain' });
            // const a = document.createElement('a');
            // a.download = `Vastu_Report_${Date.now()}.txt`;
            // a.href = URL.createObjectURL(blob);
            // document.body.appendChild(a);
            // a.click();
            // document.body.removeChild(a);
            // saveReportButton.disabled = false;
        }


        // --- CHATBOT LOGIC ---

        // IMPROVEMENT: Re-enabled bolding
        function appendMessage(text, sender) {
            const msgDiv = document.createElement('div');
msgDiv.className = `chat-message ${sender}-message`;

            if (sender === 'ai') {
                // Format AI text: Convert markdown bold to <strong> and newlines to <br>
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedText = formattedText.replace(/\n/g, '<br>');
                // *** NEW: Add feedback icons ***
                msgDiv.innerHTML = `<i class="fas fa-robot mr-1 text-blue-500"></i> ${formattedText}
                    <div class="feedback-icons text-xs">
                        <i class="far fa-thumbs-up"></i>
                        <i class="far fa-thumbs-down"></i>
                    </div>`;
} else {
                // User text is plain
                msgDiv.textContent = text;
}
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
}

        async function handleChat() {
            const userText = chatInput.value.trim();
if (!userText || isChatGenerating) return;

            // SERVER-CLIENT CHANGE: Check for Render URL
            if (renderApiUrl.includes("YOUR_RENDER_URL_HERE") || renderApiUrl.length < 10) {
    appendMessage("Error: Chat server not configured.", 'ai');
                 return;
            }
            
            appendMessage(userText, 'user');
if (chatInput) chatInput.value = '';
            
            isChatGenerating = true;
            if (chatInput) chatInput.disabled = true;
            if (sendChatButton) sendChatButton.disabled = true;
            
            // *** NEW: Append temporary processing message ***
            const processingMessage = document.createElement('div');
            processingMessage.className = 'ai-message chat-message text-gray-700 opacity-70';
            processingMessage.innerHTML = '<i class="fas fa-spinner fa-spin mr-1 text-blue-500"></i> Thinking...';
            chatMessages.appendChild(processingMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;

chatHistory.push({ role: "user", parts: [{ text: userText }] });
            
            const chatHistoryToSend = chatHistory.slice(-3);

            // SERVER-CLIENT CHANGE: Create payload for our *own* server
            const clientPayload = {
                chatHistory: chatHistoryToSend,
                chatContextSummary: chatContextSummary // *** This is the "magic" context ***
            };

            try {
                // SERVER-CLIENT CHANGE: Call our Render server, not Google
                const apiUrl = `${renderApiUrl}/api/handleChat`;
const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clientPayload)
                });

                // *** REMOVED: redundant clearTimeout(timeoutId) logic, fixed error ***

if (!response.ok) {
                    const errorData = await response.json();
throw new Error(`Server Error: ${response.status} - ${errorData.error || 'Failed to fetch'}`);
}

                const result = await response.json();
const aiResponse = result.text || "Sorry, I couldn't process that.";

                // *** NEW: Remove processing message before appending actual response ***
                if (processingMessage.parentNode) {
                    processingMessage.parentNode.removeChild(processingMessage);
                }

                appendMessage(aiResponse, 'ai');
chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
} catch (error) {
                // *** NEW: Remove processing message on error ***
                if (processingMessage.parentNode) {
                    processingMessage.parentNode.removeChild(processingMessage);
                }
               // clearTimeout(timeoutId); // <-- Clear timeout if fetch fails
                console.error('Chatbot Error:', error);
appendMessage(`I apologize, I encountered an error: ${error.message}. Please try again.`, 'ai');
} finally {
                isChatGenerating = false;
                if (chatInput) chatInput.disabled = false;
                if (sendChatButton) sendChatButton.disabled = chatInput.value.trim() === '' || isChatGenerating;
                if (chatInput) chatInput.focus();
}
        }

        // ----------------------------------------------------------------------------------
        // --- REMOVED: FLOOR PLANNER FUNCTIONS ---
        // ----------------------------------------------------------------------------------
        
        // --- NEW: DEBUG FUNCTION TO SKIP TO STEP 6 (Globally accessible) ---
        function __debug_skipToStep6() {
            console.log("DEBUG: Skipping to Step 6...");
            
            // 1. Set fake context data
            currentRoomTag = "Test Room";
            roomLocationInHouse = "Test Location";
            floorNumber = "Test Floor";
            
            // 2. Create fake scan data
            capturedFrames = [];
            // A tiny 1x1 red pixel base64 string
            const fakeImg = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
            for (let i = 0; i < totalCaptures; i++) {
                capturedFrames.push({
                    image: fakeImg,
                    heading: i * 45, // 0, 45, 90...
                    zone: getVastuZone(i * 45)
                });
            }
            
            // 3. Create fake report content
            fullReportMarkdown = `**DEBUG MODE: TEST REPORT**

This is a functional test report. The content here is generated by the \`__debug_skipToStep6()\` function to allow for testing of the Step 6 UI and print functionality without needing to perform a full scan.

**I. Fake Room Analysis**
- The (fake) room appears to be well-lit.
- All 8 (fake) directional images have been successfully captured.

**II. Test Data**
- **Room:** ${currentRoomTag}
- **Location:** ${roomLocationInHouse}
- **Floor:** ${floorNumber}

You can now test the 'Formal Report', 'Expert Analysis', 'Export .txt', and 'Print/Save PDF' buttons.
`;
            expertReportMarkdown = `**DEBUG MODE: EXPERT ANALYSIS**

- This is the test for the expert analysis view.
- Printing this report should also work.
`;
            
            reportContent.innerHTML = formatAITextForDisplay(fullReportMarkdown) + displayCapturedFrames();
            expertReportContent.innerHTML = formatAITextForDisplay(expertReportMarkdown) + displayCapturedFrames();

            // 4. Navigate to Step 6
            updateNextStepHighlight(6);
            switchReportTab('full'); // Default to full report
            
            // 5. Enable all buttons
            analyzeButton.disabled = false;
            deepAnalysisButton.disabled = false;
            saveReportButton.classList.remove('hidden');
            printReportButton.classList.remove('hidden');
            isTutorialActive = false; // Stop tutorial
            hideTutorialTip();
            
            console.log("DEBUG: Step 6 is ready for testing.");
        }
        
        // --- END: DEBUG FUNCTION ---


        // --- Event Listeners and Initialization ---
        // IMPROVEMENT: All listeners are now wrapped in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {

            // --- IMPROVEMENT: ALL DOM ELEMENT GRABBERS MOVED HERE ---
            stepContents = [1, 2, 3, 4, 5, 6].map(i => document.getElementById(`stepContent${i}`));
            stepIndicators = [1, 2, 3, 4, 5, 6].map(i => document.getElementById(`step${i}`));
            mainContentArea = document.getElementById('mainContentArea'); // <-- NEW
            appContainer = document.getElementById('appContainer'); // <-- NEW
            
            // --- Buttons are now in the footer ---
            tipsNextButton = document.getElementById('tipsNextButton');
            compassButton = document.getElementById('compassButton');
            holisticNextButton = document.getElementById('holisticNextButton');
            cameraButton = document.getElementById('cameraButton');
            captureButton = document.getElementById('captureButton');
            analyzeButton = document.getElementById('analyzeButton');
            deepAnalysisButton = document.getElementById('deepAnalysisButton');
            saveReportButton = document.getElementById('saveReportButton');
            printReportButton = document.getElementById('printReportButton');
            scanAgainButton = document.getElementById('scanAgainButton'); // *** NEW ***

            // --- Sticky Footer Wrappers ---
            actionFooter = document.getElementById('actionFooter');
            footerStepWrappers = [
                document.getElementById('footerStep1'),
                document.getElementById('footerStep2'),
                document.getElementById('footerStep3'),
                document.getElementById('footerStep4'),
                document.getElementById('footerStep5'),
                document.getElementById('footerStep6')
            ];
            stepIndicatorWrapper = document.getElementById('stepIndicatorWrapper'); // *** NEW ***

            // --- Other UI Elements ---
            headingDisplay = document.getElementById('headingDisplay');
            sensorStatus = document.getElementById('sensorStatus');
            compassNeedle = document.getElementById('compassNeedle');
            captureCanvas = document.getElementById('captureCanvas');
            cameraVideo = document.getElementById('cameraVideo');
            cameraFallback = document.getElementById('cameraFallback');
            overlayHeading = document.getElementById('overlayHeading');
            overlayZone = document.getElementById('overlayZone');
            gallery = document.getElementById('gallery'); // <-- *** FIX: Re-enabled this grabber ***
            captureCountDisplay = document.getElementById('captureCount');
            captureProgressContainer = document.getElementById('captureProgressContainer');
            captureProgress = document.getElementById('captureProgress');
            reportContent = document.getElementById('reportContent');
            expertReportContent = document.getElementById('expertReportContent');
            reportLoader = document.getElementById('reportLoader');
            
            // --- UPDATED STEP 4 GRABBERS ---
            currentRoomDisplay = document.getElementById('currentRoomDisplay'); 
            floorNumberInput = document.getElementById('floorNumberInput'); 
            roomTypeGrid = document.getElementById('roomTypeGrid');
            roomLocationGrid = document.getElementById('roomLocationGrid');
            step4CompassNeedle = document.getElementById('step4CompassNeedle'); // *** NEW ***
            checklistRoom = document.getElementById('checklistRoom');
            checklistLocation = document.getElementById('checklistLocation');
            checklistFloor = document.getElementById('checklistFloor');


            holisticNextButton = document.getElementById('holisticNextButton');
            userConcernsContainer = document.getElementById('userConcernsContainer');
            surroundingsWater = document.getElementById('surroundingsWater');
            surroundingsHills = document.getElementById('surroundingsHills');

            // --- NEW: Step 6 Tab/View Grabbers (MODIFIED) ---
            fullReportTab = document.getElementById('fullReportTab');
            expertReportTab = document.getElementById('expertReportTab');
            
            fullReportView = document.getElementById('fullReportView');
            expertReportView = document.getElementById('expertReportView');
            
            // expertReportContent grabbed above
            
            // --- NEW: Top-Level Tab Grabbers ---
            analyzerTab = document.getElementById('analyzerTab');
            chatbotTab = document.getElementById('chatbotTab');
            analyzerWrapper = document.getElementById('analyzerWrapper');
            chatView = document.getElementById('chatView');
            chatMessages = document.getElementById('chatMessages');
            chatInput = document.getElementById('chatInput');
            sendChatButton = document.getElementById('sendChatButton');
            
            
            // --- NEW: Tutorial Tooltip Grabber ---
            tutorialTooltip = document.getElementById('tutorialTooltip');
            
            // --- END OF DOM ELEMENT GRABBERS ---

            // Initial setup
            initializeStep4Grids(); // *** NEW ***
            
            // *** (FIX) Call updateNextStepHighlight to show Step 1 ***
            updateNextStepHighlight(1); // Defaults to step 1 (Tips)
            
            switchReportTab('full'); // Default to full report tab
            switchMainTab('analyzer'); // Default to analyzer view

            // --- FIX: Show first tutorial on load ---
            // We use a small timeout to ensure the element is ready
            setTimeout(() => {
                if (isTutorialActive) {
                    showTutorialTip(analyzerTab, "Welcome! Tap here to start your Vastu scan.", 'bottom');
                }
            }, 300);
            
            // --- NEW: Attach debug function to window for console access ---
            window.__debug_skipToStep6 = __debug_skipToStep6;
        
            // --- *** (FIX #1) Listener for the new Step 1 button *** ---
            tipsNextButton.addEventListener('click', () => {
                updateNextStepHighlight(2);
                if (isTutorialActive) {
                    showTutorialTip(compassButton, "Next, tap here to <strong>activate the compass</strong>.", 'top');
                }
                // --- NEW: Auto-scroll ---
                if (mainContentArea) setTimeout(() => mainContentArea.scrollTo({ top: 0, behavior: 'smooth' }), 100);
            });
            
            // --- Listener for the new Step 3 button ---
            holisticNextButton.addEventListener('click', () => {
                updateNextStepHighlight(4);
                if (isTutorialActive) {
                    showTutorialTip(roomTypeGrid, "First, tap the <strong>Room Type</strong> you're in.", 'bottom');
                }
                // --- NEW: Auto-scroll ---
                if (mainContentArea) setTimeout(() => mainContentArea.scrollTo({ top: 0, behavior: 'smooth' }), 100);
            });
            
            // *** FIX: Pass navigation step to compass ***
            compassButton.addEventListener('click', () => {
                 if (isTutorialActive) {
                    showTutorialTip(holisticNextButton, "Great! This step is optional. Tap 'Next' when you're ready.", 'top');
                 }
                activateCompass(3);
            });
            
            // --- cameraButton now serves 2 purposes ---
            cameraButton.addEventListener('click', () => {
                if (isTutorialActive) {
                    showTutorialTip(captureButton, "Great! Now tap here to start the <strong>16-second scan</strong>.", 'top');
                }
                activateCamera();
            });
            
            captureButton.addEventListener('click', startCapture);
            analyzeButton.addEventListener('click', () => generateReport(false)); // Standard report
            deepAnalysisButton.addEventListener('click', () => generateReport(true)); // Deep analysis report
            
            // *** FIX: Export TXT Logic ***
            saveReportButton.addEventListener('click', exportReportAsTxt);
            
            // --- *** (REVERTED) Print Button Logic (Formal Report Only) *** ---
            printReportButton.addEventListener('click', () => {
                // *** NEW: Check for content before printing ***
                if (!getCombinedReportText(false)) {
                    alert("Please generate a report first.");
                    return;
                }

                // --- NEW: DYNAMIC FILENAME ---
                const originalTitle = document.title;
                const newTitle = `${currentRoomTag || 'Vastu'}-${roomLocationInHouse || 'Report'}-Report`;
                document.title = newTitle.replace(/[^a-z0-9]/gi, '-').toLowerCase();

                // --- MODIFIED: Always target the Full Report view ---
                fullReportView.classList.add('print-this');
                
                // *** CRITICAL FIX: The logic that was causing the blank page has been moved to a 
                // dedicated setTimeout to ensure the CSS renders before the print command. ***
                setTimeout(() => {
                    window.print(); 
                    // Clean up immediately after print dialog is called
                   // fullReportView.classList.remove('print-this');
                    document.title = newTitle.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                }, 100); 
            });

            // ====================================================================
            // START: (MODIFIED) TUTORIAL & NAVIGATION LISTENERS
            // ====================================================================
            
            // --- 3. (FIXED) Scan Again Button (Full App Reset) ---
            scanAgainButton.addEventListener('click', () => {
                
                // --- 1. STOP ALL ACTIVE PROCESSES ---
                stopVideoStream();    // Stops camera, resets Step 4 button
                stopCompassLogic(); // Stops compass, resets Step 2 button
                
                if (isCapturing) {
                    clearInterval(captureInterval); // Stop any scan in progress
                    isCapturing = false;
                }
                isReportGenerating = false; // Stop any pending reports
                
                // --- 2. RESET STATE VARIABLES ---
                currentRoomTag = null;
                roomLocationInHouse = null;
                floorNumber = "";
                capturedFrames = [];
                fullReportMarkdown = "";
                expertReportMarkdown = ""; // *** NEW ***
                chatContextSummary = ""; // --- NEW: Reset chat context
                chatHistory = []; // --- NEW: Reset chat history

                // --- 3. RESET UI - STEP 3 (Context) ---
                if (userConcernsContainer) {
                    document.querySelectorAll('.concern-checkbox').forEach(cb => cb.checked = false);
                }
                if (surroundingsWater) surroundingsWater.value = "";
                if (surroundingsHills) surroundingsHills.value = "";

                // --- 4. RESET UI - STEP 4 (Floor Plan) ---
                if (floorNumberInput) floorNumberInput.value = "";
                initializeStep4Grids(); // This already resets grids and checklist

                // --- 5. RESET UI - STEP 5 (Scan) ---
                // initializeGallerySlots(); // Gallery removed from Step 5
                if (captureButton) captureButton.textContent = 'Start 16-Second Vastu Scan';
                // Reset button state (it will be correctly enabled/disabled by updateNextStepHighlight)
                if (captureProgress) captureProgress.style.width = '0%';
                if (captureProgressContainer) captureProgressContainer.classList.add('hidden');

                // --- 6. RESET UI - STEP 6 (Report) ---
                if (expertReportContent) expertReportContent.innerHTML = "Click 'Expert Analysis' below to generate.";
                if (reportContent) reportContent.innerHTML = "Click 'Formal Report' below to generate.";
                if (reportLoader) reportLoader.classList.add('hidden');
                if (analyzeButton) analyzeButton.disabled = true;
                if (deepAnalysisButton) deepAnalysisButton.disabled = true;
                if (saveReportButton) saveReportButton.classList.add('hidden');
                if (printReportButton) printReportButton.classList.add('hidden');
                switchReportTab('full'); // Default to full report tab
                
                // --- 7. RESET UI - CHAT ---
                if (chatMessages) {
                    // Remove all but the first (intro) message
                    while (chatMessages.children.length > 1) {
                        chatMessages.removeChild(chatMessages.lastChild);
                    }
                }
                if (chatInput) chatInput.value = "";


                // --- 8. NAVIGATE TO START ---
                isTutorialActive = true; // RESTART TUTORIAL FLOW
                switchMainTab('analyzer'); // Ensure we are on the analyzer tab
                updateNextStepHighlight(1); // Go back to Step 1
                // --- NEW: Auto-scroll & restart tutorial ---
                if (mainContentArea) setTimeout(() => mainContentArea.scrollTo({ top: 0, behavior: 'smooth' }), 100);
                setTimeout(() => {
                    if (isTutorialActive) {
                        showTutorialTip(analyzerTab, "Welcome back! Tap here to start a new scan.", 'bottom');
                    }
                }, 300);
            });

            // ====================================================================
            // --- END: (MODIFIED) TUTORIAL & NAVIGATION LISTENERS
            // ====================================================================
            
            // --- (REMOVED) NESTED TUTORIAL LISTENERS ---


            // --- NEW: Main Tab Listeners ---
            analyzerTab.addEventListener('click', () => {
                if (isTutorialActive) {
                    showTutorialTip(tipsNextButton, "Great! This is the main FAQ. Tap 'Next' to begin.", 'top');
                }
                switchMainTab('analyzer');
            });
            chatbotTab.addEventListener('click', () => switchMainTab('chatbot'));
            
            // Listeners for new Step 3 inputs
            if (userConcernsContainer) {
                userConcernsContainer.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        userIssues = Array.from(userConcernsContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                    }
                });
            }
            if (surroundingsWater) {
                surroundingsWater.addEventListener('input', () => {
                    propertySurroundings[surroundingsWater.dataset.key] = surroundingsWater.value;
                });
            }
            if (surroundingsHills) {
                surroundingsHills.addEventListener('input', () => {
                    propertySurroundings[surroundingsHills.dataset.key] = surroundingsHills.value;
                });
            }

            // Listeners for Step 4 inputs
            if (floorNumberInput) {
                floorNumberInput.addEventListener('input', () => {
                    floorNumber = floorNumberInput.value.trim();
                    if (floorNumber.trim().length > 0 && isTutorialActive) {
                        hideTutorialTip(); // Hide tip when user starts typing
                    }
                    checkStep4Completion(); // Check if next button should be enabled
                });
            }

            // Listeners for Step 6
            fullReportTab.addEventListener('click', () => switchReportTab('full'));
            expertReportTab.addEventListener('click', () => switchReportTab('expert'));
            
            // *** FIX: Moved event listeners out of conditional blocks to resolve load error ***
            if (sendChatButton) sendChatButton.addEventListener('click', handleChat);
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleChat();
                    }
                });
                chatInput.addEventListener('input', () => {
                    sendChatButton.disabled = chatInput.value.trim() === '' || isChatGenerating;
                });
            }

            // --- NEW: Chat Feedback Listener ---
            if (chatMessages) {
                chatMessages.addEventListener('click', (e) => {
                    if (e.target.classList.contains('fa-thumbs-up')) {
                        e.target.classList.toggle('selected');
                        e.target.parentElement.querySelector('.fa-thumbs-down').classList.remove('selected');
                    } else if (e.target.classList.contains('fa-thumbs-down')) {
                        e.target.classList.toggle('selected');
                        e.target.parentElement.querySelector('.fa-thumbs-up').classList.remove('selected');
                    }
                });
            }
            
            // --- NEW: Hide tutorial on scroll ---
            mainContentArea.addEventListener('scroll', () => {
                // Only hide non-sticky tips
                if (currentTutorialElement && !currentTutorialElement.closest('#actionFooter')) {
                    hideTutorialTip();
                }
            });

            // --- NEW: Export Modal Listeners ---
            document.getElementById('closeExportButton').addEventListener('click', () => {
                document.getElementById('exportOverlay').classList.add('hidden');
            });
            document.getElementById('copyExportButton').addEventListener('click', () => {
                const textArea = document.getElementById('exportTextArea');
                textArea.select();
                textArea.setSelectionRange(0, 99999); // For mobile
                try {
                    document.execCommand('copy'); // Use execCommand for iframe compatibility
                    alert("Report text copied to clipboard!"); // Use alert here as it's a modal
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    alert("Failed to copy. Please copy manually.");
                }
            });
            
            // --- NEW: Attach debug function to window for console access ---
            window.__debug_skipToStep6 = __debug_skipToStep6;
        
        });
