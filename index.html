<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vastu Pro Analyzer |
AI Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- REMOVED: Fabric.js library -->
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
:root {
            /* Pastel Blue & White Theme */
            --color-primary: #60a5fa;
/* Blue 400 - Main Accent */
            --color-secondary: #93c5fd;
/* Blue 300 - Light Accent */
            --color-background: #f0f8ff;
/* Alice Blue / Lightest Pastel */
            --color-surface-base: rgba(255, 255, 255, 0.6);
/* Semi-transparent White for Glass */
            --color-text-dark: #1e3a8a;
/* Blue 800 - Deep Blue Text */
            --color-text-light: #6b7280;
/* Gray 500 */
            --color-chat-bg-user: #e0f2fe;
/* Blue 50 */
            --color-chat-bg-ai: #fff;
}
        body {
            font-family: 'Inter', sans-serif;
background-color: var(--color-background);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--color-text-dark);
            padding: 16px;
}

        /* Glassmorphism Card Style */
        .glass-card {
            background-color: var(--color-surface-base);
backdrop-filter: blur(8px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
}

        /* Step Indicator Styles */
        .step-indicator {
            transition: all 0.3s ease;
            /* UPDATED: Made smaller for icons */
            min-width: 50px; 
            padding-left: 0.5rem;
            padding-right: 0.5rem;
}
        .step-active {
            color: var(--color-primary);
border-bottom: 2px solid var(--color-primary);
            font-weight: 600;
        }

        /* Button Styles */
        .primary-btn {
            background-color: var(--color-primary);
color: white;
            transition: background-color: 0.2s;
            box-shadow: 0 4px var(--color-text-dark);
        }
        .primary-btn:hover:not(:disabled) {
            background-color: #3b82f6;
/* Blue 500 */
        }
        .primary-btn:active:not(:disabled) {
            transform: translateY(2px);
box-shadow: 0 2px var(--color-text-dark);
        }
        .primary-btn:disabled {
            background-color: #93c5fd;
/* Blue 300 */
            cursor: not-allowed;
            box-shadow: none;
}
        /* NEW: Secondary button style for planner tools */
        .secondary-btn {
            background-color: #fff;
            color: var(--color-text-dark);
            border: 1px solid var(--color-primary);
            transition: all 0.2s;
            box-shadow: 0 2px var(--color-secondary);
        }
        .secondary-btn:hover:not(:disabled) {
            background-color: #eff6ff;
/* Blue 50 */
            box-shadow: 0 2px var(--color-primary);
        }
        .secondary-btn:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 1px var(--color-primary);
        }
        
        /* Checkbox Styles for new step */
        .concern-checkbox:checked {
            background-color: var(--color-primary);
            border-color: var(--color-text-dark);
        }

        /* Compass Visual */
        #compassNeedle {
            transition: transform 0.1s linear;
}

        /* --- Report Formatting --- */
        #reportContent strong, #expertReportContent strong {
            /* Targeted styles for the AI's section titles (e.g., **II. Assessment**) */
            display: block;
margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.15rem;
            font-weight: 800;
            color: #f97316;
/* Orange color for headings */
            border-bottom: 2px solid #93c5fd;
/* Light Blue border */
            padding-bottom: 0.25rem;
}
        #reportContent, #expertReportContent {
            line-height: 1.6;
        }
        .report-section p {
            margin-bottom: 1em;
/* Ensures clear paragraph separation */
        }
        
        /* Image Grid Styling for Captured Frames */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-top: 2px solid #ddd;
            padding-top: 0.5rem;
}
        .frame-item {
            border: 1px solid #ccc;
border-radius: 0.5rem;
            overflow: hidden;
            text-align: center;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}
        .frame-item img {
            width: 100%;
height: auto;
            object-fit: cover;
            aspect-ratio: 1/1; 
        }
        .text-xxs {
            font-size: 0.6rem;
}

        /* --- Live Overlay Styles --- */
        #compassOverlay {
            pointer-events: none;
/* Allows clicks/touches to pass through to the elements beneath (i.e., the video) */
        }
        #overlayHeading {
            /* Large degree number */
            font-size: 2.25rem;
/* 3xl */
        }

        /* Chatbot Styles */
        .chat-message {
            max-width: 85%;
padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .user-message {
            background-color: var(--color-chat-bg-user);
align-self: flex-end;
            margin-left: auto;
            border-top-right-radius: 2px;
        }
        .ai-message {
            background-color: var(--color-chat-bg-ai);
align-self: flex-start;
            margin-right: auto;
            border-top-left-radius: 2px;
            border: 1px solid #e0e7ff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

        /* --- PRINT-FRIENDLY STYLES --- */
        @media print {
            body {
                padding: 0;
                margin: 0;
                background-color: #fff;
            }
            /* Hide all .no-print elements */
            .no-print {
                display: none !important;
            }

            /* Expand all containers */
            #appContainer, #mainContentArea {
                max-height: none;
                overflow: visible;
                display: block;
                box-shadow: none;
                border: none;
            }
            
            /* Ensure the correct report view is visible */
            .tab-content {
                display: none; /* Hide all tabs by default */
            }
            #fullReportView, #expertReportView {
                display: block !important; /* Show both report tabs */
                visibility: visible;
            }
            #chatView {
                display: none !important; /* Hide chat */
            }

            /* Make the report content visible and printable */
            #reportContent, #expertReportContent {
                visibility: visible;
                display: block;
                width: 100%;
                height: auto; /* Let content determine height */
                overflow-y: visible; /* Show all content */
                background: #fff;
                border: none;
                box-shadow: none;
                backdrop-filter: none;
                padding: 0.5in; /* Reduced padding */
                font-size: 11pt;
                color: var(--color-text-dark); /* Use theme dark color */
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            /* Ensure report titles print well */
            #reportContent strong, #expertReportContent strong {
                /* REMOVED color: #000; to allow orange to print */
                border-bottom: 2px solid #ccc;
                page-break-after: avoid;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            /* Ensure images in the gallery print */
            .image-gallery img {
                visibility: visible;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }

        /* ======================================================================
        START: TUTORIAL MODAL STYLES (Add this section)
        ======================================================================
        */
        #tutorialOverlay {
            /* This is handled by Tailwind classes (fixed, inset-0, etc.) */
            /* We add 'hidden' by default */
        }
        
        #tutorialOverlay.hidden {
            display: none;
        }
        /* ====================================================================
        END: TUTORIAL MODAL STYLES
        ======================================================================
        */

        /* ======================================================================
        START: NEW STEP 4 GRID STYLES
        ======================================================================
        */
        .location-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--color-secondary);
        }
        .location-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-dark);
            background-color: #fff;
            border: 1px solid var(--color-secondary);
            border-radius: 0.5rem;
            padding: 0.75rem 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.2;
            min-height: 50px;
        }
        .location-cell:hover {
            background-color: #eff6ff; /* Blue 50 */
            border-color: var(--color-primary);
        }
        .location-cell.selected {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-text-dark);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: scale(1.05);
        }
        /* ====================================================================
        END: NEW STEP 4 GRID STYLES
        ======================================================================
        */

        /* ======================================================================
        START: NEW UI/UX ENHANCEMENT STYLES
        ======================================================================
        */
        /* --- 5. Gallery Slot --- */
        .gallery-slot {
            border: 2px dashed var(--color-secondary);
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.4);
            width: 80px; /* Corresponds to grid-template-columns */
            height: 80px; /* Corresponds to grid-template-columns */
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-secondary);
            font-size: 0.75rem;
            aspect-ratio: 1/1;
        }

        /* --- 1. Sticky Footer --- */
        #mainContentArea {
            /* This will be the only scrolling part */
            overflow-y: auto;
            flex-grow: 1;
            /* Add padding to content area */
            padding: 0.25rem;
            /* *** FIX: Ensure it can shrink on small screens *** */
            min-height: 200px;
        }
        #actionFooter {
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 1rem;
            padding-bottom: 0.5rem; /* Reduced bottom padding */
            flex-shrink: 0;
        }
        .footer-step-wrapper {
            display: none; /* Hidden by default, JS will show */
        }

        /* --- 4. Step 4 Checklist --- */
        #step4Checklist {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--color-secondary);
        }
        .checklist-item.complete {
            color: var(--color-text-dark);
            font-weight: 600;
        }
        .checklist-item.pending {
            color: var(--color-text-light);
        }

        /* --- 6. Step Animation --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* --- 1. Larger Reading Area (Step 6) --- */
        #reportContent, #expertReportContent, #chatMessages {
            /* REMOVED h-96 */
            /* NEW: Let flex-grow handle the height */
            flex-grow: 1;
            overflow-y: auto;
        }
        #chatView {
            /* Make chat view a flex column to fill space */
            display: flex;
            flex-direction: column;
            /* Give it a min-height to push footer down */
            min-height: 400px; 
        }
        /* --- End Larger Reading Area --- */

        /* ====================================================================
        END: NEW UI/UX ENHANCEMENT STYLES
        ======================================================================
        */
    </style>
</head>
<body class="p-4 sm:p-8">
    <!-- *** MODIFIED: Structural change for sticky footer *** -->
    <div id="appContainer" class="glass-card w-full max-w-sm sm:max-w-xl md:max-w-2xl p-6 flex flex-col max-h-[90vh]">

        <!-- === HEADER (Non-scrolling) === -->
        <div class="flex-shrink-0">
            <h1 class="text-xl sm:text-2xl font-extrabold text-center no-print">Vastu Pro Analyzer |
    AI Edition</h1>
            <p class="text-xs text-center text-gray-500 no-print">Generate a Vastu Shastra report using your device's sensors.</p>

            <!-- *** SUGGESTION 2: Icon-Based Step Indicators *** -->
            <div class="flex flex-wrap justify-center text-center text-sm border-b pb-2 border-gray-200 no-print mt-6">
                <div id="step1" class="step-indicator m-1" title="FAQ"><i class="fas fa-question-circle text-xl"></i></div>
                <div id="step2" class="step-indicator m-1" title="Sensors"><i class="fas fa-compass text-xl"></i></div>
                <div id="step3" class="step-indicator m-1" title="Context"><i class="fas fa-tasks text-xl"></i></div>
                <div id="step4" class="step-indicator m-1" title="Floor Plan"><i class="fas fa-th-large text-xl"></i></div>
                <div id="step5" class="step-indicator m-1" title="Scan"><i class="fas fa-camera text-xl"></i></div>
                <div id="step6" class="step-indicator m-1" title="Report"><i class="fas fa-file-alt text-xl"></i></div>
            </div>
        </div>

        <!-- === MAIN CONTENT (Scrolling) === -->
        <div id="mainContentArea" class="my-4">
            <div id="stepContent1" class="step-content no-print">
                <div class="glass-card p-4 rounded-lg border-2 border-blue-100 h-96 overflow-y-auto">
                    <h3 class="font-bold text-lg text-blue-800 mb-3"><i class="fas fa-question-circle mr-2"></i>User FAQ & How-To</h3>
                    <div class="text-sm text-gray-700 space-y-4">
                        <div>
                            <p class="font-bold text-blue-700">Q: How do I get the most accurate scan?</p>
                            <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> Stand in the center of the room and turn in a slow, 360-degree circle. Make sure the room is well-lit so the AI can see everything clearly. The scan takes about 16 seconds.</p>
                        </div>
                        <div>
                            <p class="font-bold text-blue-700">Q: What is the "Holistic Context" in Step 3?</p>
                            <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This is an optional but powerful step. By telling the AI your concerns (e.g., "Financial", "Health"), it can tailor the Vastu remedies specifically to help you with those problems.</p>
                        </div>
                        <!-- UPDATED FAQ for Step 4 -->
                        <div>
                            <p class="font-bold text-blue-700">Q: What is the "Floor Plan" in Step 4?</p>
                            <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This is the most critical step.
                            <br>1. First, select the <strong>type of room</strong> you are in (e.g., "Kitchen").
                            <br>2. Second, select <strong>where that room is located</strong> in your house (e.g., "South-East").
                            <br>This two-part selection is required for an accurate analysis.</p>
                        </div>
                        <div>
                            <p class="font-bold text-blue-700">Q: What's the difference between the two report buttons?</p>
                            <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A: "Formal Report"</strong> gives a full, 5-section analysis with simple, practical remedies. <strong>"Expert Analysis"</strong> gives a short, bulleted list of high-stakes, structural remedies (like moving a wall) that a human expert might suggest.</p>
                        </div>
                         <div>
                            <p class="font-bold text-blue-700">Q: My report failed or was empty. What do I do?</p>
                            <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This can happen if the images are too dark or blurry, triggering the AI's safety filters. Please try scanning again in a room with better lighting.</p>
                        </div>
                        <div>
                            <p class="font-bold text-blue-700">Q: Can I scan just one wall?</p>
                            <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> No. The app is designed to capture all 8 directions in a full 360-degree scan to analyze every Vastu zone, not just one.</p>
                        </div>
                    </div>
                </div>
                <!-- Button moved to footer -->
            </div>
            <div id="stepContent2" class="step-content hidden no-print">
                <p class="text-sm text-center text-gray-600 mb-4">Please grant permission to access your device's sensors.</p>
                <div class="flex justify-center items-center p-4">
                    <div class="relative w-24 h-24 sm:w-32 sm:h-32 bg-white rounded-full border-4 border-gray-300 flex items-center justify-center">
                        <i class="fas fa-compass text-6xl text-gray-400"></i>
                        <i id="compassNeedle" 
    class="fas fa-arrow-up absolute text-red-500 text-3xl transition-transform" style="transform: rotate(0deg);"></i>
                    </div>
                </div>
                <p class="text-center font-bold text-lg" id="headingDisplay">Heading: N/A</p>
                <p class="text-center text-xs text-gray-500 mb-4" id="sensorStatus">Sensors: Inactive</p>
                <!-- Button moved to footer -->
            </div>

            <div id="stepContent3" class="step-content hidden no-print">
                <p class="text-sm text-center text-gray-600 mb-4">This step is optional, but helps the AI personalize your report.</p>
                <div class="glass-card p-4 mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-3">
                        Step 3a: What are your primary concerns? (Optional)
                    </label>
                    <div id="userConcernsContainer" class="grid grid-cols-2 gap-2 text-sm">
                        <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                            <input type="checkbox" class="concern-checkbox" value="Financial">
                            <span><i class="fas fa-wallet mr-1"></i> Financial</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                            <input type="checkbox" class="concern-checkbox" value="Health">
                            <span><i class="fas fa-heartbeat mr-1"></i> Health</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                            <input type="checkbox" class="concern-checkbox" value="Relationships">
                            <span><i class="fas fa-users mr-1"></i> Relationships</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                            <input type="checkbox" class="concern-checkbox" value="Career">
                            <span><i class="fas fa-briefcase mr-1"></i> Career</span>
                        </label>
                    </div>
                </div>

                <div class="glass-card p-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        Step 3b: What is surrounding the property? (Optional)
                    </label>
                    <div class="space-y-2">
                        <input type="text" id="surroundingsWater" placeholder="E.g., River in North, Lake in East"
                               class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500" data-key="Water Body">
                        <p class="text-xs text-gray-500 mt-1">Water body (lake, river, etc.) and its direction?</p>
                        
                        <input type="text" id="surroundingsHills" placeholder="E.g., Mountain in South-West"
                               class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500" data-key="Hills">
                        <p class="text-xs text-gray-500 mt-1">Hills or large structures and their direction?</p>
                    </div>
                </div>
                <!-- Button moved to footer -->
            </div>
            
            <!-- ======================================================================
            START: STEP 4 (NEW GRID-BASED PLANNER)
            ======================================================================
            -->
            <div id="stepContent4" class="step-content hidden no-print space-y-4">
                
                <!-- Part 1: Select Room Type -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        Step 4a: What room are you scanning?
                    </label>
                    <div id="roomTypeGrid" class="location-grid">
                        <!-- JS will populate this -->
                    </div>
                </div>

                <!-- Part 2: Select Location in House -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        Step 4b: Where is this room in your house?
                    </label>
                    <div id="roomLocationGrid" class="location-grid">
                        <!-- JS will populate this -->
                    </div>
                </div>
                
                <p class="text-center text-xs text-gray-500 my-2 p-2 glass-card" id="currentRoomDisplay">
                    Selected for Scan: <strong>...</strong> (in <strong>...</strong>)
                </p>

                <!-- Part 3: Floor Number -->
                <div class="p-4 glass-card">
                    <label for="floorNumberInput" class="block text-sm font-bold text-gray-700 mb-2">
                        Step 4c: Which floor is this on?
                    </label>
                    <input type="text" id="floorNumberInput" placeholder="E.g., 1st Floor, Ground Floor (Required)" 
                           class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- *** SUGGESTION 4: Step 4 Checklist *** -->
                <div id="step4Checklist" class="glass-card p-4 space-y-2 text-sm rounded-lg">
                    <div id="checklistRoom" class="checklist-item pending"><i class="far fa-square mr-2"></i>Select Room Type</div>
                    <div id="checklistLocation" class="checklist-item pending"><i class="far fa-square mr-2"></i>Select Room Location</div>
                    <div id="checklistFloor" class="checklist-item pending"><i class="far fa-square mr-2"></i>Enter Floor</div>
                </div>
                <!-- Button moved to footer -->
            </div>
            <!-- ====================================================================
            END: STEP 4
            ======================================================================
            -->


            <div id="stepContent5" class="step-content hidden no-print">
                
    <p class="text-sm text-center text-gray-600 mb-4">Hold your device steady and turn in a slow 360° circle to capture all zones.</p>
                <div id="cameraContainer" class="glass-card overflow-hidden mb-4 relative">
                    <video id="cameraVideo" autoplay playsinline class="bg-gray-200 hidden"></video>
                    
                    <div id="compassOverlay" class="absolute w-full h-full flex flex-col justify-between p-4 pointer-events-none z-50">
                        
    <div class="text-center">
                            <span class="inline-block p-1 px-3 bg-black bg-opacity-70 text-white text-3xl font-extrabold rounded-lg shadow-xl" id="overlayHeading">N/A</span>
                        </div>
                        <div class="text-center self-center mb-4">
                         
       <span class="inline-block p-1 px-3 bg-black bg-opacity-70 text-white text-base rounded-lg font-semibold" id="overlayZone">Zone: Unknown</span>
                        </div>
                    </div>

                    <div id="cameraFallback" class="w-full h-full bg-gray-200 flex flex-col items-center justify-center text-center p-4 absolute top-0 left-0">
                        <i 
    class="fas fa-video camera-icon"></i>
                        <p class="mt-2 text-sm text-gray-500">Camera access is required for Vastu analysis.</p>
                    </div>
                </div>
             
                <p class="text-center text-sm mb-4">
                    <span 
    id="captureCount">0/8</span> Segments Captured. Scan takes ~16 seconds.
                </p>
     
       
                <div id="captureProgressContainer" class="h-2 bg-gray-200 rounded-full mt-2 mb-4 hidden">
                    <div id="captureProgress" class="h-2 bg-green-500 rounded-full transition-all duration-100"></div>
                </div>

                <!-- *** SUGGESTION 5: Gallery now populates with slots *** -->
                <div id="gallery" class="flex flex-wrap gap-2 justify-center p-2 border-dashed border-2 border-gray-300 rounded-lg bg-white overflow-y-auto max-h-40">
                    <!-- JS will populate this with slots -->
                </div>
                <!-- Button moved to footer -->
            </div>

            <!-- *** STEP 6: Modified for Tabs and Flex *** -->
            <div id="stepContent6" class="step-content hidden h-full flex flex-col">
                
                <div id="reportLoader" 
    class="text-center py-8 hidden no-print">
                    <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                    <p class="mt-4 font-semibold text-gray-600">Generating Report...</p>
                    <p class="text-xs text-gray-500 mt-2">The process may take a few seconds.</p>
                </div>

               
                 <!-- *** NEW 3-TAB SYSTEM *** -->
                 <div class="flex border-b border-gray-200 mb-4 no-print flex-shrink-0">
                    <button id="fullReportTab" class="py-2 px-4 text-xs sm:text-sm font-bold text-gray-600 border-b-2 border-transparent transition-colors hover:bg-gray-50">
                        <i class="fas fa-file-alt mr-1"></i> Full Report
                    </button>
                    <button id="expertReportTab" class="py-2 px-4 text-xs sm:text-sm font-bold text-gray-600 border-b-2 border-transparent transition-colors hover:bg-gray-50">
                        <i class="fas fa-exclamation-triangle mr-1"></i> Expert Analysis
                    </button>
                    <button id="chatTab" class="py-2 px-4 text-xs sm:text-sm font-bold text-gray-600 border-b-2 border-transparent transition-colors 
    hover:bg-gray-50">
                        <i class="fas fa-comment-dots mr-1"></i> Vastu Chatbot
                    </button>
                </div>

                <!-- Tab Content: Full Report -->
                <div id="fullReportView" class="tab-content">
                    <div id="reportContent" class="glass-card p-4 text-sm report-section">
                        Click "Formal Report" below to generate.
                    </div>
                </div>
                
                <!-- Tab Content: Expert Report -->
                <div id="expertReportView" class="tab-content hidden">
                    <div id="expertReportContent" class="glass-card p-4 text-sm report-section">
                        Click "Expert Analysis" below to generate.
                    </div>
                </div>
                
                <!-- Tab Content: Chat -->
                <div id="chatView" class="tab-content hidden no-print flex-grow">
                    <div id="chatMessages" class="glass-card p-4 text-sm flex flex-col space-y-2">
                        <div class="ai-message chat-message text-gray-700">
               <i class="fas fa-robot mr-1 text-blue-500"></i>
                            Hello!
    I am your Vastu AI Assistant. Ask me a general question about Vastu, or ask me for details about the report you just generated (e.g., "Tell me more about the North-East zone in my report").
    </div>
                    </div>
                    <div class="flex mt-4">
                        <input type="text" id="chatInput" placeholder="Ask your Vastu question..." class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800" disabled>
                        <button id="sendChatButton" class="primary-btn p-3 rounded-r-lg font-bold" disabled>
                       <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <!-- Buttons moved to footer -->
            </div>
        </div> <!-- === END MAIN CONTENT === -->


        <!-- === STICKY FOOTER (Suggestion 1) === -->
        <div id="actionFooter" class="flex-shrink-0">
            <!-- Step 1 Button -->
            <div id="footerStep1" class="footer-step-wrapper">
                <button id="tipsNextButton" class="primary-btn w-full p-3 rounded-lg font-bold">
                    Next: Activate Sensors <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
            <!-- Step 2 Button -->
            <div id="footerStep2" class="footer-step-wrapper">
                <button id="compassButton" class="primary-btn w-full p-3 rounded-lg font-bold">
                    <i class="fas fa-magic mr-2"></i>Activate Sensors
                </button>
            </div>
            <!-- Step 3 Button -->
            <div id="footerStep3" class="footer-step-wrapper">
                <button id="holisticNextButton" class="primary-btn w-full p-3 rounded-lg font-bold">
                    Next: Floor Plan <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
            <!-- Step 4 Button -->
            <div id="footerStep4" class="footer-step-wrapper">
                 <button id="cameraButton" class="primary-btn w-full p-3 rounded-lg font-bold" disabled>
                    <i class="fas fa-arrow-right mr-2"></i>Next: Activate Camera
                </button>
            </div>
            <!-- Step 5 Button -->
            <div id="footerStep5" class="footer-step-wrapper">
                <button id="captureButton" class="primary-btn w-full p-3 rounded-lg font-bold" disabled>
                    <i class="fas fa-location-arrow mr-2"></i>Start 16-Second Vastu Scan
                </button>
            </div>
            <!-- Step 6 Buttons -->
            <div id="footerStep6" class="footer-step-wrapper">
                <!-- *** MODIFIED: Smaller, more compact buttons *** -->
                <div class="flex flex-wrap gap-2 no-print">
                    <button id="analyzeButton" class="primary-btn p-3 rounded-lg font-bold flex-1" disabled>
                        <i class="fas fa-chart-area mr-2"></i>Formal Report
                     </button>
                    <button id="deepAnalysisButton" class="primary-btn p-3 rounded-lg font-bold bg-blue-500 hover:bg-blue-600 flex-1" style="box-shadow: 0 4px #1d4ed8;" disabled>
                        <i class="fas fa-exclamation-triangle mr-2"></i>Expert Analysis
                    </button>
                </div>
                <div class="flex flex-wrap gap-2 no-print mt-2">
                    <!-- *** SUGGESTION 3: Scan Again Button *** -->
                    <button id="scanAgainButton" class="secondary-btn p-2 text-sm rounded-lg font-bold flex-1">
                        <i class="fas fa-redo mr-1"></i>New Scan
                    </button>
                    <button id="saveReportButton" class="secondary-btn p-2 text-sm rounded-lg font-bold flex-1 hidden">
                        <i class="fas fa-file-export mr-1"></i>Export .txt
                    </button>
                    <button id="printReportButton" class="secondary-btn p-2 text-sm rounded-lg font-bold flex-1 hidden">
                        <i class="fas fa-print mr-1"></i>Print/Save PDF
                    </button>
                </div>
            </div>
        </div>
        <!-- === END STICKY FOOTER === -->


        <!-- 
        ======================================================================
        START: TUTORIAL MODAL (Add this section)
        ======================================================================
        -->
        <div id="tutorialOverlay" class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex justify-center items-center p-4 z-50 hidden no-print">
            <div class="glass-card w-full max-w-md p-6 relative">
                <h3 id="tutorialTitle" class="font-extrabold text-xl text-blue-800 mb-3">
                    <i class="fas fa-info-circle mr-2"></i> How This Works
                </h3>
                
                <p id="tutorialBody" class="text-sm text-gray-700 mb-6">
                    This is the tutorial text.
                </p>

                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="tutorialCloseButton" class="primary-btn p-3 rounded-lg font-bold sm:flex-1">
                        Got It!
                    </button>
                    <button id="tutorialSkipAllButton" class="bg-gray-200 text-gray-600 p-3 rounded-lg font-bold text-sm hover:bg-gray-300 transition-colors sm:w-auto">
                        Skip All Tutorials
                    </button>
                </div>
            </div>
        </div>
        <!-- ====================================================================
        END: TUTORIAL MODAL
        ======================================================================
        -->

    </div> <!-- This is the closing tag for #appContainer -->

    <canvas id="captureCanvas" style="display:none;" class="no-print"></canvas>


    <script type="module">
        const renderApiUrl="https://test12-6qay.onrender.com";let currentHeading=null;let isCompassActive=!1;let isCameraActive=!1;let isCapturing=!1;let isReportGenerating=!1;let isChatGenerating=!1;let videoStream=null;let capturedFrames=[];let fullReportMarkdown="";let chatContextSummary="";let chatHistory=[];let simulationInterval;let captureInterval;let sensorCheckTimeout;const totalCaptures=8;const captureIntervalTime=2000;const scanDuration=totalCaptures*(captureIntervalTime/1000);let currentRoomTag=null;let roomLocationInHouse=null;let floorNumber="";const VASTU_ZONES_16=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];let userIssues=[];let propertySurroundings={};let stepContents,stepIndicators,tipsNextButton,headingDisplay,sensorStatus,compassNeedle,compassButton,cameraButton,captureCanvas,cameraVideo,cameraFallback,overlayHeading,overlayZone,gallery,captureButton,captureCountDisplay,captureProgressContainer,captureProgress,analyzeButton,deepAnalysisButton,saveReportButton,printReportButton,reportContent,reportLoader,chatInput,sendChatButton,currentRoomDisplay,floorNumberInput,holisticNextButton,userConcernsContainer,surroundingsWater,surroundingsHills;let roomTypeGrid,roomLocationGrid;let actionFooter,footerStepWrappers;let step4Checklist,checklistRoom,checklistLocation,checklistFloor;let scanAgainButton;let fullReportTab,expertReportTab,chatTab,fullReportView,expertReportView,chatView,expertReportContent;let tutorialOverlay,tutorialTitle,tutorialBody,tutorialCloseButton,tutorialSkipAllButton;function getVastuZone(degrees){const offset=11.25;let index=Math.floor(((degrees+offset)%360)/22.5);return VASTU_ZONES_16[index%16]}
function formatAITextForDisplay(rawText){let formattedText=rawText;formattedText=formattedText.replace(/\n\n/g,'<p></p>');formattedText=formattedText.replace(/\n/g,'<br>');formattedText=formattedText.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');return formattedText.length>0?`<div class="pdf-report-body">${formattedText}</div>`:''}
function displayCapturedFrames(){let html=`
                <strong class="no-print">VI.
Captured Visual Data Segments (${capturedFrames.length} Frames)</strong>
                <p class="text-sm font-semibold text-gray-600 mt-2 no-print">Scan Context: Data captured for the ${currentRoomTag} area, located in the ${roomLocationInHouse ||
'N/A'} of the entire property, on the ${floorNumber || 'N/A'}.</p>
                <div class="image-gallery">
            `;capturedFrames.forEach((frame,index)=>{const zone=getVastuZone(frame.heading);const imageUrl=`data:image/jpeg;base64,${frame.image}`;html+=`
                    <div class="frame-item">
                    
    <img src="${imageUrl}" alt="Segment ${index + 1}" title="Segment ${index + 1}: ${zone}">
                        <div class="frame-data">
                            <span class="text-xs font-bold text-blue-500">#${index + 1}</span> | 
                          
  ${frame.heading.toFixed(1)}° 
                        </div>
                    </div>
                `});html+=`</div>`;return html}
function formatAITextForTxtExport(rawText){let formattedText=rawText;formattedText=formattedText.replace(/\n\n/g,'\n\n');formattedText=formattedText.replace(/(?<!\n)\n(?!\n)/g,' ');formattedText=formattedText.replace(/\*\*(.*?)\*\*/g,(match,p1)=>`\n\n--- ${p1.toUpperCase()} ---\n`);return formattedText}
function updateNextStepHighlight(currentStep=1){stepContents.forEach((content,index)=>{const stepNum=index+1;stepIndicators[index].classList.remove('step-active');if(stepNum===currentStep){content.classList.remove('hidden');stepIndicators[index].classList.add('step-active')}else{content.classList.add('hidden')}});footerStepWrappers.forEach((wrapper,index)=>{const stepNum=index+1;if(stepNum===currentStep){wrapper.style.display='block'}else{wrapper.style.display='none'}});if(currentStep===4){checkStep4Completion()}else if(currentStep===5){if(capturedFrames.length===0){initializeGallerySlots()}
captureButton.disabled=isCapturing||capturedFrames.length>=totalCaptures}else if(currentStep===6){analyzeButton.disabled=isReportGenerating||capturedFrames.length<totalCaptures;deepAnalysisButton.disabled=isReportGenerating||capturedFrames.length<totalCaptures;chatInput.disabled=!fullReportMarkdown;sendChatButton.disabled=!fullReportMarkdown}
showTutorial(currentStep)}
function initializeStep4Grids(){const ROOM_TYPES=['Living Room','Kitchen','Master Bed','Bedroom','Pooja Room','Toilet/Bath','Main Entrance','Staircase','Study Room'];const LOCATIONS=['NW','N','NE','W','Center','E','SW','S','SE'];roomTypeGrid.innerHTML='';ROOM_TYPES.forEach(type=>{const cell=document.createElement('div');cell.className='location-cell';cell.textContent=type;cell.dataset.value=type;cell.addEventListener('click',()=>selectGridCell(roomTypeGrid,cell,'room'));roomTypeGrid.appendChild(cell)});roomLocationGrid.innerHTML='';LOCATIONS.forEach(loc=>{const cell=document.createElement('div');cell.className='location-cell';cell.textContent=loc;cell.dataset.value=loc;cell.addEventListener('click',()=>selectGridCell(roomLocationGrid,cell,'location'));roomLocationGrid.appendChild(cell)});updateRoomDisplay();updateChecklist()}
function selectGridCell(grid,cell,type){Array.from(grid.children).forEach(c=>c.classList.remove('selected'));cell.classList.add('selected');if(type==='room'){currentRoomTag=cell.dataset.value}else if(type==='location'){roomLocationInHouse=cell.dataset.value}
updateRoomDisplay();checkStep4Completion()}
function updateRoomDisplay(){const room=currentRoomTag||'...';const loc=roomLocationInHouse||'...';currentRoomDisplay.innerHTML=`Selected for Scan: <strong>${room}</strong> (in <strong>${loc}</strong> zone)`}
function checkStep4Completion(){if(currentRoomTag&&roomLocationInHouse&&floorNumber.trim().length>0){cameraButton.disabled=!1}else{cameraButton.disabled=!0}
updateChecklist()}
function updateChecklist(){if(currentRoomTag){checklistRoom.innerHTML=`<i class="far fa-check-square mr-2 text-green-500"></i>Room: <strong>${currentRoomTag}</strong>`;checklistRoom.className='checklist-item complete'}else{checklistRoom.innerHTML=`<i class="far fa-square mr-2"></i>Select Room Type`;checklistRoom.className='checklist-item pending'}
if(roomLocationInHouse){checklistLocation.innerHTML=`<i class="far fa-check-square mr-2 text-green-500"></i>Location: <strong>${roomLocationInHouse}</strong>`;checklistLocation.className='checklist-item complete'}else{checklistLocation.innerHTML=`<i class="far fa-square mr-2"></i>Select Room Location`;checklistLocation.className='checklist-item pending'}
if(floorNumber.trim().length>0){checklistFloor.innerHTML=`<i class="far fa-check-square mr-2 text-green-500"></i>Floor: <strong>${floorNumber}</strong>`;checklistFloor.className='checklist-item complete'}else{checklistFloor.innerHTML=`<i class="far fa-square mr-2"></i>Enter Floor`;checklistFloor.className='checklist-item pending'}}
function switchReportTab(target){fullReportTab.classList.remove('border-blue-500','border-b-2','text-blue-800');expertReportTab.classList.remove('border-blue-500','border-b-2','text-blue-800');chatTab.classList.remove('border-blue-500','border-b-2','text-blue-800');fullReportTab.classList.add('border-transparent','text-gray-600');expertReportTab.classList.add('border-transparent','text-gray-600');chatTab.classList.add('border-transparent','text-gray-600');fullReportView.classList.add('hidden');expertReportView.classList.add('hidden');chatView.classList.add('hidden');if(target==='full'){fullReportTab.classList.remove('border-transparent','text-gray-600');fullReportTab.classList.add('border-blue-500','border-b-2','text-blue-800');fullReportView.classList.remove('hidden')}else if(target==='expert'){expertReportTab.classList.remove('border-transparent','text-gray-600');expertReportTab.classList.add('border-blue-500','border-b-2','text-blue-800');expertReportView.classList.remove('hidden')}else if(target==='chat'){chatTab.classList.remove('border-transparent','text-gray-600');chatTab.classList.add('border-blue-500','border-b-2','text-blue-800');chatView.classList.remove('hidden');setTimeout(()=>chatMessages.scrollTop=chatMessages.scrollHeight,10)}}
function showTutorial(step){if(localStorage.getItem('vastuAppTutorialsSkipped')==='true'){return}
let title="";let body="";switch(step){case 1:title="Welcome to Vastu Pro AI";body="This app is a 6-step Vastu analyzer. You are on the FAQ page, a great place to start.<br><br>Click 'Got It!' to continue, or 'Skip All Tutorials' to hide these messages permanently.";break;case 2:title="Step 2: Activate Sensors";body="This is a key step. The app needs access to your device's <strong>compass</strong> to know which direction you are facing.<br><br>Please tap the 'Activate Sensors' button and grant permission if prompted.";break;case 3:title="Step 3: Holistic Context (Optional)";body="This step is optional but highly recommended.<br><br>Telling the AI your personal concerns (like 'Financial' or 'Health') helps it create remedies that are specifically tailored to your goals.";break;case 4:title="Step 4: Location (Required)";body=`This is the <strong>most critical step</strong> for accuracy. Please complete all 3 parts:
                        <br><br><strong>1. Room Type:</strong> Tap the button for the room you are currently in.
                        <br><br><strong>2. Room Location:</strong> Tap the button for where this room is located within your *entire* house plan.
                        <br><br><strong>3. Floor:</strong> Type the floor number.
                        <br><br>The 'Next' button will activate once all three are complete.`;break;case 5:title="Step 5: The 360° Scan";body="You're ready to scan! You've selected the <strong>"+currentRoomTag+"</strong> in the <strong>"+roomLocationInHouse+"</strong> zone.<br><br>When you click 'Start Scan', hold your device steady and turn in a <strong>slow, complete 360-degree circle</strong>.";break;case 6:title="Step 6: Your Report";body="Your scan is complete!<br><br>Click <strong>'Formal Report'</strong> for a detailed analysis or <strong>'Expert Analysis'</strong> for high-level structural advice. You can also use the 'Vastu Chatbot' to ask follow-up questions.";break;default:return}
tutorialTitle.textContent=title;tutorialBody.innerHTML=body;tutorialOverlay.classList.remove('hidden')}
function handleOrientation(event){let heading;if(event.webkitCompassHeading){heading=event.webkitCompassHeading}else if(event.alpha!==null){if(event.absolute===!0||typeof event.absolute==='undefined'){heading=(360-event.alpha)%360}else{console.warn("Relative orientation not supported. Using 0.");heading=(360-event.alpha)%360}}else{return}
if(sensorCheckTimeout){clearTimeout(sensorCheckTimeout);sensorCheckTimeout=null}
currentHeading=parseFloat(heading.toFixed(1));headingDisplay.textContent=`Heading: ${currentHeading}°`;overlayHeading.textContent=`${currentHeading}°`;compassNeedle.style.transform=`rotate(-${currentHeading}deg)`;overlayZone.textContent=`Zone: ${getVastuZone(currentHeading)}`}
function requestIOSSensorPermission(navigateToStep){if(typeof DeviceOrientationEvent.requestPermission==='function'){DeviceOrientationEvent.requestPermission().then(permissionState=>{if(permissionState==='granted'){window.addEventListener('deviceorientation',handleOrientation);window.addEventListener('deviceorientationabsolute',handleOrientation);startCompassLogic(navigateToStep)}else{console.warn("Sensor permission denied by user.");startCompassSimulation(navigateToStep)}}).catch(e=>{console.error('Sensor permission error:',e);startCompassSimulation(navigateToStep)})}else{startCompassLogic(navigateToStep)}}
function startCompassLogic(navigateToStep=null){if(isCompassActive)return;if(window.DeviceOrientationEvent){if(typeof DeviceOrientationEvent.requestPermission!=='function'){window.addEventListener('deviceorientation',handleOrientation);window.addEventListener('deviceorientationabsolute',handleOrientation)}}else{startCompassSimulation(navigateToStep);return}
sensorCheckTimeout=setTimeout(()=>{if(currentHeading===null){console.warn("No sensor data. Falling back to simulation.");stopCompassLogic();startCompassSimulation(navigateToStep)}},1000);isCompassActive=!0;sensorStatus.textContent='Sensors: Active';compassButton.classList.remove('primary-btn');compassButton.classList.add('bg-gray-400');compassButton.innerHTML='<i class="fas fa-check mr-2"></i>Sensors Active';compassButton.style.boxShadow='none';compassButton.disabled=!0;if(navigateToStep){updateNextStepHighlight(navigateToStep)}}
function startCompassSimulation(navigateToStep=null){if(isCompassActive)return;isCompassActive=!0;let simHeading=0;sensorStatus.textContent='Sensors: SIMULATION (Not Found)';simulationInterval=setInterval(()=>{simHeading=(simHeading+0.1)%360;currentHeading=parseFloat(simHeading.toFixed(1));headingDisplay.textContent=`Heading: ${currentHeading}° (SIM)`;overlayHeading.textContent=`${currentHeading}° (SIM)`;compassNeedle.style.transform=`rotate(-${currentHeading}deg)`;overlayZone.textContent=`Zone: ${getVastuZone(currentHeading)}`},100);compassButton.classList.remove('primary-btn');compassButton.classList.add('bg-gray-400');compassButton.innerHTML='<i class="fas fa-check mr-2"></i>Simulation Active';compassButton.style.boxShadow='none';compassButton.disabled=!0;if(navigateToStep){updateNextStepHighlight(navigateToStep)}}
function activateCompass(navigateToStep=null){if(isCompassActive){return}
if(window.DeviceOrientationEvent&&typeof DeviceOrientationEvent.requestPermission==='function'){requestIOSSensorPermission(navigateToStep)}else if(window.DeviceOrientationEvent){startCompassLogic(navigateToStep)}else{startCompassSimulation(navigateToStep)}}
function stopVideoStream(){if(!isCameraActive)return;if(videoStream){videoStream.getTracks().forEach(track=>track.stop());videoStream=null}
isCameraActive=!1;cameraVideo.classList.add('hidden');cameraFallback.classList.remove('hidden');cameraButton.classList.remove('bg-red-500','hover:bg-red-600','bg-gray-400');cameraButton.classList.add('primary-btn');cameraButton.innerHTML=`<i class="fas fa-arrow-right mr-2"></i>Next: Activate Camera`;cameraButton.style.boxShadow='0 4px var(--color-text-dark)';checkStep4Completion()}
function stopCompassLogic(){if(!isCompassActive)return;isCompassActive=!1;sensorStatus.textContent='Sensors: Inactive';compassButton.classList.remove('bg-red-500','hover:bg-red-600','bg-gray-400');compassButton.classList.add('primary-btn');compassButton.innerHTML='<i class="fas fa-magic mr-2"></i>Activate Sensors';compassButton.style.boxShadow='0 4px var(--color-text-dark)';compassButton.disabled=!1;headingDisplay.textContent='Heading: N/A';overlayHeading.textContent='N/A';compassNeedle.style.transform=`rotate(0deg)`;overlayZone.textContent='Zone: Unknown';window.removeEventListener('deviceorientation',handleOrientation);window.removeEventListener('deviceorientationabsolute',handleOrientation);if(simulationInterval){clearInterval(simulationInterval);simulationInterval=null}
if(sensorCheckTimeout){clearTimeout(sensorCheckTimeout);sensorCheckTimeout=null}}
async function activateCamera(){const currentStep=Array.from(stepIndicators).findIndex(s=>s.classList.contains('step-active'))+1;if(currentStep===4){if(!isCompassActive){activateCompass(null)}
updateNextStepHighlight(5);if(isCameraActive)return;if(isCapturing)return;try{videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:320},height:{ideal:320}}});cameraVideo.srcObject=videoStream;cameraVideo.classList.remove('hidden');cameraFallback.classList.add('hidden');await cameraVideo.play();isCameraActive=!0}catch(err){console.error('Camera access error:',err);cameraVideo.classList.add('hidden');cameraFallback.classList.remove('hidden')}}}
function captureCurrentFrame(){const video=cameraVideo;const canvas=captureCanvas;const context=canvas.getContext('2d');if(!isCameraActive||!currentHeading){console.error("Cannot capture: Camera or compass is inactive.");return null}
if(video.videoWidth===0||video.videoHeight===0){console.warn("Video dimensions not ready yet. Skipping this frame capture.");return null}
const size=Math.min(video.videoWidth,video.videoHeight);canvas.width=size;canvas.height=size;const startX=(video.videoWidth-size)/2;const startY=(video.videoHeight-size)/2;context.drawImage(video,startX,startY,size,size,0,0,size,size);const dataUrl=canvas.toDataURL('image/jpeg',0.05);const base64Data=dataUrl.split(',')[1];return{image:base64Data,heading:currentHeading,zone:getVastuZone(currentHeading),timestamp:Date.now()}}
function startCapture(){if(isCapturing)return;if(!isCompassActive||!isCameraActive){alert("Please ensure sensors and camera are active (Steps 2 & 5).");return}
if(!floorNumber||floorNumber.length<1){alert("Please go back to Step 4 and enter the 'Floor Number' before scanning.");return}
isCapturing=!0;capturedFrames=[];captureCountDisplay.textContent=`0/${totalCaptures}`;captureButton.disabled=!0;captureButton.textContent='Scanning... (Hold Steady)';captureProgressContainer.classList.remove('hidden');captureProgress.style.width='0%';analyzeButton.disabled=!0;deepAnalysisButton.disabled=!0;saveReportButton.classList.add('hidden');printReportButton.classList.add('hidden');let capturesTaken=0;const executeCapture=()=>{const frameData=captureCurrentFrame();if(frameData){capturedFrames.push(frameData);capturesTaken++;displayCapturedFrame(frameData,capturesTaken-1);captureCountDisplay.textContent=`${capturesTaken}/${totalCaptures}`;captureProgress.style.width=`${(capturesTaken / totalCaptures) * 100}%`;if(capturesTaken>=totalCaptures){clearInterval(captureInterval);endCapture()}}};executeCapture();captureInterval=setInterval(executeCapture,captureIntervalTime);setTimeout(()=>{if(isCapturing){clearInterval(captureInterval);endCapture()}},captureIntervalTime*totalCaptures+500)}
function endCapture(){isCapturing=!1;captureProgressContainer.classList.add('hidden');captureButton.textContent='Start 16-Second Vastu Scan';captureButton.disabled=!1;stopVideoStream();stopCompassLogic();if(capturedFrames.length===totalCaptures){updateNextStepHighlight(6);analyzeButton.disabled=!1;deepAnalysisButton.disabled=!1}else{updateNextStepHighlight(6);analyzeButton.disabled=!0;deepAnalysisButton.disabled=!0}}
function displayCapturedFrame(frame,index){const allSlots=gallery.querySelectorAll('.gallery-slot');if(index>=allSlots.length)return;const slot=allSlots[index];slot.innerHTML='';slot.classList.remove('gallery-slot');slot.classList.add('frame-item');const img=document.createElement('img');img.src=`data:image/jpeg;base64,${frame.image}`;img.alt=`Segment ${index + 1}: ${frame.zone}`;img.title=`Segment ${index + 1}: ${frame.zone} (${frame.heading}°)`;const labelContainer=document.createElement('div');labelContainer.className='frame-data';labelContainer.innerHTML=`<span class="text-xs font-bold text-blue-500">#${index + 1}</span> | ${frame.heading.toFixed(1)}°`;slot.appendChild(img);slot.appendChild(labelContainer)}
function initializeGallerySlots(){gallery.innerHTML='';for(let i=0;i<totalCaptures;i++){const slot=document.createElement('div');slot.className='gallery-slot';slot.innerHTML=`<i class="far fa-image"></i>`;gallery.appendChild(slot)}}
async function generateReport(isDeepAnalysis=!1){if(isReportGenerating||capturedFrames.length<totalCaptures){return}
if(renderApiUrl.includes("YOUR_RENDER_URL_HERE")||renderApiUrl.length<10){reportContent.innerHTML=formatAITextForDisplay(`**Error:** Server not configured. Please paste your Render server's URL into the 'renderApiUrl' variable at the top of the script.`);return}
isReportGenerating=!0;fullReportMarkdown="";chatContextSummary="";chatHistory=[];reportLoader.classList.remove('hidden');if(isDeepAnalysis){expertReportContent.innerHTML='';switchReportTab('expert')}else{reportContent.innerHTML='';switchReportTab('full')}
analyzeButton.disabled=!0;deepAnalysisButton.disabled=!0;saveReportButton.classList.add('hidden');printReportButton.classList.add('hidden');chatInput.disabled=!0;sendChatButton.disabled=!0;scanAgainButton.disabled=!0;let holisticIssues="None specified";if(userIssues.length>0){holisticIssues=userIssues.join(', ')}
let holisticSurroundings="None specified";const surroundingsEntries=Object.entries(propertySurroundings).filter(([key,value])=>value.trim()!=="");if(surroundingsEntries.length>0){holisticSurroundings=surroundingsEntries.map(([key,value])=>`${key}: ${value}`).join('; ')}
const clientPayload={isDeepAnalysis:isDeepAnalysis,scanData:{capturedFrames:capturedFrames.map(f=>({image:f.image,heading:f.heading,zone:f.zone})),currentRoomTag:currentRoomTag,roomLocationInHouse:roomLocationInHouse,floorNumber:floorNumber,holisticIssues:holisticIssues,holisticSurroundings:holisticSurroundings}};try{const apiUrl=`${renderApiUrl}/api/generateReport`;const response=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(clientPayload)});if(!response.ok){const errorData=await response.json();throw new Error(`Server Error: ${response.status} - ${errorData.error || 'Failed to fetch'}`)}
const result=await response.json();fullReportMarkdown=result.text||"";if(!fullReportMarkdown){throw new Error("API returned an empty response. This is likely due to the API's safety filters (e.g., a blurry/dark image) or a silent timeout. Please try scanning again in a well-lit area.")}
const summaryEndMarker='**II. Directional Data and Environmental Assessment**';const summaryEndIndex=fullReportMarkdown.indexOf(summaryEndMarker);if(summaryEndIndex!==-1){chatContextSummary=fullReportMarkdown.substring(0,summaryEndIndex).trim()}else{chatContextSummary=fullReportMarkdown.substring(0,500).trim()}
const formattedHtml=formatAITextForDisplay(fullReportMarkdown)+displayCapturedFrames();if(isDeepAnalysis){expertReportContent.innerHTML=formattedHtml}else{reportContent.innerHTML=formattedHtml}
saveReportButton.classList.remove('hidden');printReportButton.classList.remove('hidden');chatInput.disabled=!1;sendChatButton.disabled=!1}catch(error){console.error('Report Generation Error:',error);let errorHtml=formatAITextForDisplay(`**I. Executive Summary (Layman's Terms)**\n\nReport generation failed due to an error.`);errorHtml+=`<p class="text-red-600 font-bold mt-4">REPORT GENERATION FAILED</p>
                              <p class="mt-2 text-sm">A critical API error occurred.
Please try running the scan again.</p>
                              <p class="mt-2 text-xs text-gray-400">Error Details: ${error.message}</p>`;if(isDeepAnalysis){expertReportContent.innerHTML=errorHtml+displayCapturedFrames()}else{reportContent.innerHTML=errorHtml+displayCapturedFrames()}}finally{isReportGenerating=!1;reportLoader.classList.add('hidden');analyzeButton.disabled=!1;deepAnalysisButton.disabled=!1;scanAgainButton.disabled=!1}}
function exportReportAsTxt(){if(!fullReportMarkdown){return}
saveReportButton.disabled=!0;const header=`
*** Vastu Pro Analyzer Formal AI Report ***
Scan Area: ${currentRoomTag} 
Location in House (C-Point): ${roomLocationInHouse ||
'N/A'}
Floor: ${floorNumber || 'N/A'}
----------------------------------------------------------------------------------------------------------------------
\n`;const formattedBody=formatAITextForTxtExport(fullReportMarkdown);const footer=`
\n----------------------------------------------------------------------------------------------------------------------
*** Captured Visual Data Segments (Images are NOT included in this text file) ***
${capturedFrames.map((f, i) => `#${i+1}:${f.heading.toFixed(1)}degrees(${f.zone})`).join(' | ')}
----------------------------------------------------------------------------------------------------------------------
This file contains the full Vastu analysis.
\n`;const fullTextContent=header+formattedBody+footer;const blob=new Blob([fullTextContent],{type:'text/plain'});const a=document.createElement('a');a.download=`Vastu_Report_${Date.now()}.txt`;a.href=URL.createObjectURL(blob);document.body.appendChild(a);a.click();document.body.removeChild(a);saveReportButton.disabled=!1}
function appendMessage(text,sender){const msgDiv=document.createElement('div');msgDiv.className=`chat-message ${sender}-message`;if(sender==='ai'){let formattedText=text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formattedText=formattedText.replace(/\n/g,'<br>');msgDiv.innerHTML=`<i class="fas fa-robot mr-1 text-blue-500"></i> ${formattedText}`}else{msgDiv.textContent=text}
chatMessages.appendChild(msgDiv);chatMessages.scrollTop=chatMessages.scrollHeight}
async function handleChat(){const userText=chatInput.value.trim();if(!userText||isChatGenerating)return;if(renderApiUrl.includes("YOUR_RENDER_URL_HERE")||renderApiUrl.length<10){appendMessage("Error: Chat server not configured.",'ai');return}
appendMessage(userText,'user');chatInput.value='';isChatGenerating=!0;chatInput.disabled=!0;sendChatButton.disabled=!0;chatHistory.push({role:"user",parts:[{text:userText}]});const chatHistoryToSend=chatHistory.slice(-3);const clientPayload={chatHistory:chatHistoryToSend,chatContextSummary:chatContextSummary};try{const apiUrl=`${renderApiUrl}/api/handleChat`;const response=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(clientPayload)});if(!response.ok){const errorData=await response.json();throw new Error(`Server Error: ${response.status} - ${errorData.error || 'Failed to fetch'}`)}
const result=await response.json();const aiResponse=result.text||"Sorry, I couldn't process that query.";appendMessage(aiResponse,'ai');chatHistory.push({role:"model",parts:[{text:aiResponse}]})}catch(error){console.error('Chatbot Error:',error);appendMessage(`I apologize, I encountered an error: ${error.message}. Please try again.`,'ai')}finally{isChatGenerating=!1;chatInput.disabled=!1;sendChatButton.disabled=chatInput.value.trim()===''||isChatGenerating;chatInput.focus()}}
document.addEventListener('DOMContentLoaded',()=>{stepContents=[1,2,3,4,5,6].map(i=>document.getElementById(`stepContent${i}`));stepIndicators=[1,2,3,4,5,6].map(i=>document.getElementById(`step${i}`));tipsNextButton=document.getElementById('tipsNextButton');compassButton=document.getElementById('compassButton');holisticNextButton=document.getElementById('holisticNextButton');cameraButton=document.getElementById('cameraButton');captureButton=document.getElementById('captureButton');analyzeButton=document.getElementById('analyzeButton');deepAnalysisButton=document.getElementById('deepAnalysisButton');saveReportButton=document.getElementById('saveReportButton');printReportButton=document.getElementById('printReportButton');scanAgainButton=document.getElementById('scanAgainButton');actionFooter=document.getElementById('actionFooter');footerStepWrappers=[document.getElementById('footerStep1'),document.getElementById('footerStep2'),document.getElementById('footerStep3'),document.getElementById('footerStep4'),document.getElementById('footerStep5'),document.getElementById('footerStep6')];headingDisplay=document.getElementById('headingDisplay');sensorStatus=document.getElementById('sensorStatus');compassNeedle=document.getElementById('compassNeedle');captureCanvas=document.getElementById('captureCanvas');cameraVideo=document.getElementById('cameraVideo');cameraFallback=document.getElementById('cameraFallback');overlayHeading=document.getElementById('overlayHeading');overlayZone=document.getElementById('overlayZone');gallery=document.getElementById('gallery');captureCountDisplay=document.getElementById('captureCount');captureProgressContainer=document.getElementById('captureProgressContainer');captureProgress=document.getElementById('captureProgress');reportContent=document.getElementById('reportContent');reportLoader=document.getElementById('reportLoader');chatInput=document.getElementById('chatInput');sendChatButton=document.getElementById('sendChatButton');currentRoomDisplay=document.getElementById('currentRoomDisplay');floorNumberInput=document.getElementById('floorNumberInput');roomTypeGrid=document.getElementById('roomTypeGrid');roomLocationGrid=document.getElementById('roomLocationGrid');step4Checklist=document.getElementById('step4Checklist');checklistRoom=document.getElementById('checklistRoom');checklistLocation=document.getElementById('checklistLocation');checklistFloor=document.getElementById('checklistFloor');holisticNextButton=document.getElementById('holisticNextButton');userConcernsContainer=document.getElementById('userConcernsContainer');surroundingsWater=document.getElementById('surroundingsWater');surroundingsHills=document.getElementById('surroundingsHills');fullReportTab=document.getElementById('fullReportTab');expertReportTab=document.getElementById('expertReportTab');chatTab=document.getElementById('chatTab');fullReportView=document.getElementById('fullReportView');expertReportView=document.getElementById('expertReportView');chatView=document.getElementById('chatView');expertReportContent=document.getElementById('expertReportContent');tutorialOverlay=document.getElementById('tutorialOverlay');tutorialTitle=document.getElementById('tutorialTitle');tutorialBody=document.getElementById('tutorialBody');tutorialCloseButton=document.getElementById('tutorialCloseButton');tutorialSkipAllButton=document.getElementById('tutorialSkipAllButton');initializeStep4Grids();updateNextStepHighlight();switchReportTab('full');tipsNextButton.addEventListener('click',()=>updateNextStepHighlight(2));holisticNextButton.addEventListener('click',()=>updateNextStepHighlight(4));compassButton.addEventListener('click',()=>activateCompass(3));cameraButton.addEventListener('click',activateCamera);captureButton.addEventListener('click',startCapture);analyzeButton.addEventListener('click',()=>generateReport(!1));deepAnalysisButton.addEventListener('click',()=>generateReport(!0));saveReportButton.addEventListener('click',exportReportAsTxt);printReportButton.addEventListener('click',()=>window.print());tutorialCloseButton.addEventListener('click',()=>{tutorialOverlay.classList.add('hidden')});tutorialSkipAllButton.addEventListener('click',()=>{let userIsSure=!1;try{userIsSure=confirm("Are you sure you want to skip all tutorials? This is permanent.")}catch(e){console.warn("`confirm()` dialog might be blocked. Skipping tutorial for this session only.")}
if(userIsSure){localStorage.setItem('vastuAppTutorialsSkipped','true');tutorialOverlay.classList.add('hidden')}else if(!userIsSure){tutorialOverlay.classList.add('hidden')}});scanAgainButton.addEventListener('click',()=>{currentRoomTag=null;roomLocationInHouse=null;floorNumber="";capturedFrames=[];fullReportMarkdown="";chatContextSummary="";chatHistory=[];userIssues=[];propertySurroundings={};floorNumberInput.value="";initializeStep4Grids();initializeGallerySlots();reportContent.innerHTML="Click 'Formal Report' below to generate.";expertReportContent.innerHTML="Click 'Expert Analysis' below to generate.";document.querySelectorAll('.concern-checkbox').forEach(cb=>cb.checked=!1);surroundingsWater.value="";surroundingsHills.value="";updateNextStepHighlight(1)});userConcernsContainer.addEventListener('change',(e)=>{if(e.target.type==='checkbox'){userIssues=Array.from(userConcernsContainer.querySelectorAll('input:checked')).map(cb=>cb.value)}});surroundingsWater.addEventListener('input',()=>{propertySurroundings[surroundingsWater.dataset.key]=surroundingsWater.value});surroundingsHills.addEventListener('input',()=>{propertySurroundings[surroundingsHills.dataset.key]=surroundingsHills.value});floorNumberInput.addEventListener('input',()=>{floorNumber=floorNumberInput.value.trim();checkStep4Completion()});fullReportTab.addEventListener('click',()=>switchReportTab('full'));expertReportTab.addEventListener('click',()=>switchReportTab('expert'));chatTab.addEventListener('click',()=>{if(fullReportMarkdown){switchReportTab('chat')}else{}});sendChatButton.addEventListener('click',handleChat);chatInput.addEventListener('keypress',(e)=>{if(e.key==='Enter'){handleChat()}});chatInput.addEventListener('input',()=>{sendChatButton.disabled=chatInput.value.trim()===''||isChatGenerating})})
</script>
</body>
</html>

