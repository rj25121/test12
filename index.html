<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vastu Pro Analyzer |
AI Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- NEW: Fabric.js library for 2D drawing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
:root {
            /* Pastel Blue & White Theme */
            --color-primary: #60a5fa;
/* Blue 400 - Main Accent */
            --color-secondary: #93c5fd;
/* Blue 300 - Light Accent */
            --color-background: #f0f8ff;
/* Alice Blue / Lightest Pastel */
            --color-surface-base: rgba(255, 255, 255, 0.6);
/* Semi-transparent White for Glass */
            --color-text-dark: #1e3a8a;
/* Blue 800 - Deep Blue Text */
            --color-text-light: #6b7280;
/* Gray 500 */
            --color-chat-bg-user: #e0f2fe;
/* Blue 50 */
            --color-chat-bg-ai: #fff;
}
        body {
            font-family: 'Inter', sans-serif;
background-color: var(--color-background);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--color-text-dark);
            padding: 16px;
}

        /* Glassmorphism Card Style */
        .glass-card {
            background-color: var(--color-surface-base);
backdrop-filter: blur(8px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
}

        /* Step Indicator Styles */
        .step-indicator {
            transition: all 0.3s ease;
}
        .step-active {
            color: var(--color-primary);
border-bottom: 2px solid var(--color-primary);
            font-weight: 600;
        }

        /* Button Styles */
        .primary-btn {
            background-color: var(--color-primary);
color: white;
            transition: background-color: 0.2s;
            box-shadow: 0 4px var(--color-text-dark);
        }
        .primary-btn:hover:not(:disabled) {
            background-color: #3b82f6;
/* Blue 500 */
        }
        .primary-btn:active:not(:disabled) {
            transform: translateY(2px);
box-shadow: 0 2px var(--color-text-dark);
        }
        .primary-btn:disabled {
            background-color: #93c5fd;
/* Blue 300 */
            cursor: not-allowed;
            box-shadow: none;
}
        /* NEW: Secondary button style for planner tools */
        .secondary-btn {
            background-color: #fff;
            color: var(--color-text-dark);
            border: 1px solid var(--color-primary);
            transition: all 0.2s;
            box-shadow: 0 2px var(--color-secondary);
        }
        .secondary-btn:hover:not(:disabled) {
            background-color: #eff6ff;
/* Blue 50 */
            box-shadow: 0 2px var(--color-primary);
        }
        .secondary-btn:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 1px var(--color-primary);
        }
        
        /* Checkbox Styles for new step */
        .concern-checkbox:checked {
            background-color: var(--color-primary);
            border-color: var(--color-text-dark);
        }

        /* Compass Visual */
        #compassNeedle {
            transition: transform 0.1s linear;
}

        /* --- Report Formatting --- */
        #reportContent strong {
            /* Targeted styles for the AI's section titles (e.g., **II. Assessment**) */
            display: block;
margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.15rem;
            font-weight: 800;
            color: #f97316;
/* Orange color for headings */
            border-bottom: 2px solid #93c5fd;
/* Light Blue border */
            padding-bottom: 0.25rem;
}
        #reportContent {
            line-height: 1.6;
}
        .report-section p {
            margin-bottom: 1em;
/* Ensures clear paragraph separation */
        }
        
        /* Image Grid Styling for Captured Frames */
        .image-gallery {
            display: grid;
grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-top: 2px solid #ddd;
            padding-top: 0.5rem;
}
        .frame-item {
            border: 1px solid #ccc;
border-radius: 0.5rem;
            overflow: hidden;
            text-align: center;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}
        .frame-item img {
            width: 100%;
height: auto;
            object-fit: cover;
            aspect-ratio: 1/1; 
        }
        .text-xxs {
            font-size: 0.6rem;
}

        /* --- Live Overlay Styles --- */
        #compassOverlay {
            pointer-events: none;
/* Allows clicks/touches to pass through to the elements beneath (i.e., the video) */
        }
        #overlayHeading {
            /* Large degree number */
            font-size: 2.25rem;
/* 3xl */
        }

        /* Chatbot Styles */
        .chat-message {
            max-width: 85%;
padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .user-message {
            background-color: var(--color-chat-bg-user);
align-self: flex-end;
            margin-left: auto;
            border-top-right-radius: 2px;
        }
        .ai-message {
            background-color: var(--color-chat-bg-ai);
align-self: flex-start;
            margin-right: auto;
            border-top-left-radius: 2px;
            border: 1px solid #e0e7ff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

        /* --- PRINT-FRIENDLY STYLES --- */
        @media print {
            /* Hide all .no-print elements */
            .no-print {
                display: none !important;
            }
            
            /* Reset body for printing */
            body {
                padding: 0;
                margin: 0;
                background-color: #fff;
            }

            /* Make the report view fill the page */
            #reportView {
                visibility: visible;
                display: block;
                width: 100%;
                position: relative;
            }

            /* Make the report content visible and printable */
            #reportContent {
                visibility: visible;
                display: block;
                width: 100%;
                height: auto;
                overflow-y: visible; /* Show all content */
                background: #fff;
                border: none;
                box-shadow: none;
                backdrop-filter: none;
                padding: 0.5in; /* Reduced padding */
                font-size: 11pt;
                color: var(--color-text-dark); /* Use theme dark color */
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            /* Ensure report titles print well */
            #reportContent strong {
                /* REMOVED color: #000; to allow orange to print */
                border-bottom: 2px solid #ccc;
                page-break-after: avoid;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            /* Ensure images in the gallery print */
            .image-gallery img {
                visibility: visible;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
        }

        /* ======================================================================
        START: TUTORIAL MODAL STYLES (Add this section)
        ======================================================================
        */
        #tutorialOverlay {
            /* This is handled by Tailwind classes (fixed, inset-0, etc.) */
            /* We add 'hidden' by default */
        }
        
        #tutorialOverlay.hidden {
            display: none;
        }
        /* ====================================================================
        END: TUTORIAL MODAL STYLES
        ======================================================================
        */

        /* ======================================================================
        START: FLOOR PLANNER STYLES (NEW)
        ======================================================================
        */
        #plannerContainer {
            position: relative;
            width: 100%;
            /* 1:1 Aspect Ratio */
            padding-top: 100%; 
            background-color: #fff;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        #directionGrid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            pointer-events: none;
            z-index: 1;
        }

        .grid-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-secondary);
            border: 1px dashed var(--color-secondary);
            opacity: 0.7;
        }

        /* Place text in the correct cells */
        .grid-cell:nth-child(1) { align-items: flex-start; justify-content: flex-start; padding: 4px; } /* NW */
        .grid-cell:nth-child(2) { align-items: flex-start; } /* N */
        .grid-cell:nth-child(3) { align-items: flex-start; justify-content: flex-end; padding: 4px; } /* NE */
        .grid-cell:nth-child(4) { justify-content: flex-start; } /* W */
        .grid-cell:nth-child(5) { 
            font-size: 1rem;
            color: var(--color-primary);
        } /* Center */
        .grid-cell:nth-child(6) { justify-content: flex-end; } /* E */
        .grid-cell:nth-child(7) { align-items: flex-end; justify-content: flex-start; padding: 4px; } /* SW */
        .grid-cell:nth-child(8) { align-items: flex-end; } /* S */
        .grid-cell:nth-child(9) { align-items: flex-end; justify-content: flex-end; padding: 4px; } /* SE */

        #floorPlanCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
        }
        /* ====================================================================
        END: FLOOR PLANNER STYLES
        ======================================================================
        */

    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="appContainer" class="glass-card w-full max-w-sm sm:max-w-xl md:max-w-2xl p-6 space-y-6">

        <h1 class="text-xl sm:text-2xl font-extrabold text-center no-print">Vastu Pro Analyzer |
AI Edition</h1>
        <p class="text-xs text-center text-gray-500 no-print">Generate a Vastu Shastra report using your device's sensors.</p>

        <!-- STEP INDICATORS: Renamed Step 4 -->
        <div class="flex flex-wrap justify-center text-center text-sm border-b pb-2 border-gray-200 no-print">
            <div id="step1" class="step-indicator m-1 min-w-[60px]">1. FAQ</div>
            <div id="step2" class="step-indicator m-1 min-w-[60px]">2.
Sensors</div>
            <div id="step3" class="step-indicator m-1 min-w-[60px]">3. Context</div>
            <div id="step4" class="step-indicator m-1 min-w-[60px]">4.
Floor Plan</div>
            <div id="step5" class="step-indicator m-1 min-w-[60px]">5.
Scan</div>
            <div id="step6" class="step-indicator m-1 min-w-[60px]">6.
Report & Chat</div>
        </div>

        <div id="stepContent1" class="step-content no-print">
            <div class="glass-card p-4 rounded-lg border-2 border-blue-100 h-96 overflow-y-auto">
                <h3 class="font-bold text-lg text-blue-800 mb-3"><i class="fas fa-question-circle mr-2"></i>User FAQ & How-To</h3>
                <div class="text-sm text-gray-700 space-y-4">
                    <div>
                        <p class="font-bold text-blue-700">Q: How do I get the most accurate scan?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> Stand in the center of the room and turn in a slow, 360-degree circle. Make sure the room is well-lit so the AI can see everything clearly. The scan takes about 16 seconds.</p>
                    </div>
                    <div>
                        <p class="font-bold text-blue-700">Q: What is the "Holistic Context" in Step 3?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This is an optional but powerful step. By telling the AI your concerns (e.g., "Financial", "Health"), it can tailor the Vastu remedies specifically to help you with those problems.</p>
                    </div>
                    <!-- UPDATED FAQ for Step 4 -->
                    <div>
                        <p class="font-bold text-blue-700">Q: What is the "Floor Plan" in Step 4?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This is the most critical step. Use the tools to draw a simple block plan of your house.<br>
                        1. Add blocks and arrange them to match your layout.<br>
                        2. Select the *outer wall* blocks and click "Set Outer Wall". This finds the center (Brahmasthan).<br>
                        3. Add blocks for your rooms. Click a room, label it, and the app will auto-find its Vastu zone.<br>
                        4. This selection is used as the context for your scan in Step 5.</p>
                    </div>
                    <div>
                        <p class="font-bold text-blue-700">Q: What's the difference between the two report buttons?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A: "Formal Report"</strong> gives a full, 5-section analysis with simple, practical remedies. <strong>"Expert Analysis"</strong> gives a short, bulleted list of high-stakes, structural remedies (like moving a wall) that a human expert might suggest.</p>
                    </div>
                     <div>
                        <p class="font-bold text-blue-700">Q: My report failed or was empty. What do I do?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This can happen if the images are too dark or blurry, triggering the AI's safety filters. Please try scanning again in a room with better lighting.</p>
                    </div>
                    <div>
                        <p class="font-bold text-blue-700">Q: Can I scan just one wall?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> No. The app is designed to capture all 8 directions in a full 360-degree scan to analyze every Vastu zone, not just one.</p>
                    </div>
                </div>
            </div>
            <button id="tipsNextButton" class="primary-btn w-full p-3 rounded-lg font-bold mt-6">
                Next: Activate Sensors <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
        <div id="stepContent2" class="step-content hidden no-print">
            <p class="text-sm text-center text-gray-600 mb-4">Please grant permission to access your device's sensors.</p>
            <div class="flex justify-center items-center p-4">
                <div class="relative w-24 h-24 sm:w-32 sm:h-32 bg-white rounded-full border-4 border-gray-300 flex items-center justify-center">
                    <i class="fas fa-compass text-6xl text-gray-400"></i>
                    <i id="compassNeedle" 
class="fas fa-arrow-up absolute text-red-500 text-3xl transition-transform" style="transform: rotate(0deg);"></i>
                </div>
            </div>
            <p class="text-center font-bold text-lg" id="headingDisplay">Heading: N/A</p>
            <p class="text-center text-xs text-gray-500 mb-4" id="sensorStatus">Sensors: Inactive</p>
            <button id="compassButton" class="primary-btn w-full p-3 rounded-lg font-bold">
           
      <i class="fas fa-magic mr-2"></i>Activate Sensors
            </button>
        </div>

        <div id="stepContent3" class="step-content hidden no-print">
            <p class="text-sm text-center text-gray-600 mb-4">This step is optional, but helps the AI personalize your report.</p>
            <div class="glass-card p-4 mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-3">
                    Step 3a: What are your primary concerns? (Optional)
                </label>
                <div id="userConcernsContainer" class="grid grid-cols-2 gap-2 text-sm">
                    <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                        <input type="checkbox" class="concern-checkbox" value="Financial">
                        <span><i class="fas fa-wallet mr-1"></i> Financial</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                        <input type="checkbox" class="concern-checkbox" value="Health">
                        <span><i class="fas fa-heartbeat mr-1"></i> Health</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                        <input type="checkbox" class="concern-checkbox" value="Relationships">
                        <span><i class="fas fa-users mr-1"></i> Relationships</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                        <input type="checkbox" class="concern-checkbox" value="Career">
                        <span><i class="fas fa-briefcase mr-1"></i> Career</span>
                    </label>
                </div>
            </div>

            <div class="glass-card p-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    Step 3b: What is surrounding the property? (Optional)
                </label>
                <div class="space-y-2">
                    <input type="text" id="surroundingsWater" placeholder="E.g., River in North, Lake in East"
                           class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500" data-key="Water Body">
                    <p class="text-xs text-gray-500 mt-1">Water body (lake, river, etc.) and its direction?</p>
                    
                    <input type="text" id="surroundingsHills" placeholder="E.g., Mountain in South-West"
                           class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500" data-key="Hills">
                    <p class="text-xs text-gray-500 mt-1">Hills or large structures and their direction?</p>
                </div>
            </div>

            <button id="holisticNextButton" class="primary-btn w-full p-3 rounded-lg font-bold mt-6">
                Next: Floor Plan <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
        
        <!-- ======================================================================
        START: STEP 4 (NEW FLOOR PLANNER)
        ======================================================================
        -->
        <div id="stepContent4" class="step-content hidden no-print">
            <p class="text-sm text-center text-gray-600 mb-2">Draw your floor plan to find the center and auto-select zones.</p>
            
            <!-- Planner Toolbar -->
            <div class="flex flex-wrap gap-2 mb-2">
                <button id="addRoomButton" class="secondary-btn text-xs py-2 px-3 rounded-lg font-semibold flex-1"><i class="fas fa-plus mr-1"></i> Add Room</button>
                <button id="setOuterWallButton" class="secondary-btn text-xs py-2 px-3 rounded-lg font-semibold flex-1 bg-blue-100"><i class="fas fa-vector-square mr-1"></i> Set Outer Wall</button>
                <button id="labelRoomButton" class="secondary-btn text-xs py-2 px-3 rounded-lg font-semibold flex-1"><i class="fas fa-tag mr-1"></i> Label Selected</button>
                <button id="deleteRoomButton" class="secondary-btn text-xs py-2 px-3 rounded-lg font-semibold flex-1 bg-red-100 text-red-700 border-red-300"><i class="fas fa-trash mr-1"></i> Delete</button>
            </div>

            <!-- Planner Canvas Container -->
            <div id="plannerContainer" class="glass-card">
                <!-- Directional Grid (CSS Background) -->
                <div id="directionGrid">
                    <div class="grid-cell">NW</div>
                    <div class="grid-cell">N</div>
                    <div class="grid-cell">NE</div>
                    <div class="grid-cell">W</div>
                    <div class="grid-cell"><i class="fas fa-dot-circle"></i></div>
                    <div class="grid-cell">E</div>
                    <div class="grid-cell">SW</div>
                    <div class="grid-cell">S</div>
                    <div class="grid-cell">SE</div>
                </div>
                <!-- Fabric.js Canvas -->
                <canvas id="floorPlanCanvas"></canvas>
            </div>
            
            <p class="text-center text-xs text-gray-500 my-2 p-2 glass-card" id="currentRoomDisplay">
                Selected for Scan: <strong>General Property Scan</strong> (in <strong>Center</strong>)
            </p>

            <!-- Re-purposed floorNumberInput -->
            <div class="mt-4 p-4 glass-card">
                <label for="floorNumberInput" class="block text-sm font-bold text-gray-700 mb-2">
                    Which floor is this plan for?
                </label>
                <input type="text" id="floorNumberInput" placeholder="E.g., 1st Floor, 2nd Floor, Ground Floor (Required)" 
                       class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Re-purposed cameraButton -->
            <button id="cameraButton" class="primary-btn w-full p-3 rounded-lg font-bold mt-4">
                <i class="fas fa-arrow-right mr-2"></i>Next: Activate Camera
            </button>
        </div>
        <!-- ====================================================================
        END: STEP 4
        ======================================================================
        -->


        <div id="stepContent5" class="step-content hidden no-print">
            
<p class="text-sm text-center text-gray-600 mb-4">Hold your device steady and turn in a slow 360° circle to capture all zones.</p>
            <div id="cameraContainer" class="glass-card overflow-hidden mb-4 relative">
                <video id="cameraVideo" autoplay playsinline class="bg-gray-200 hidden"></video>
                
                <div id="compassOverlay" class="absolute w-full h-full flex flex-col justify-between p-4 pointer-events-none z-50">
                    
<div class="text-center">
                        <span class="inline-block p-1 px-3 bg-black bg-opacity-70 text-white text-3xl font-extrabold rounded-lg shadow-xl" id="overlayHeading">N/A</span>
                    </div>
                    <div class="text-center self-center mb-4">
                     
   <span class="inline-block p-1 px-3 bg-black bg-opacity-70 text-white text-base rounded-lg font-semibold" id="overlayZone">Zone: Unknown</span>
                    </div>
                </div>

                <div id="cameraFallback" class="w-full h-full bg-gray-200 flex flex-col items-center justify-center text-center p-4 absolute top-0 left-0">
                    <i 
class="fas fa-video camera-icon"></i>
                    <p class="mt-2 text-sm text-gray-500">Camera access is required for Vastu analysis.</p>
                </div>
            </div>
         
            <p class="text-center text-sm mb-4">
                <span 
id="captureCount">0/8</span> Segments Captured. Scan takes ~16 seconds.
            </p>

            <button id="captureButton" class="primary-btn w-full p-3 rounded-lg font-bold mb-4" disabled>
                <i class="fas fa-location-arrow mr-2"></i>Start 16-Second Vastu Scan
            </button>
 
   
            <div id="captureProgressContainer" class="h-2 bg-gray-200 rounded-full mt-2 mb-4 hidden">
                <div id="captureProgress" class="h-2 bg-green-500 rounded-full transition-all duration-100"></div>
            </div>
            <div id="gallery" class="flex flex-wrap gap-2 justify-center p-2 border-dashed border-2 border-gray-300 rounded-lg bg-white overflow-y-auto max-h-40">
            </div>
        </div>

        <div id="stepContent6" class="step-content hidden">
            
            <div id="reportLoader" 
class="text-center py-8 hidden no-print">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                <p class="mt-4 font-semibold text-gray-600">Generating Formal Report...</p>
                <p class="text-xs text-gray-500 mt-2">The process may take a few seconds.</p>
            </div>

           
 <div class="flex border-b border-gray-200 mb-4 no-print">
                <button id="reportTab" class="py-2 px-4 text-sm font-bold text-gray-600 border-b-2 border-transparent transition-colors hover:bg-gray-50 active-tab-style">
                    <i class="fas fa-file-alt mr-1"></i> Full Report
                </button>
                <button id="chatTab" class="py-2 px-4 text-sm font-bold text-gray-600 border-b-2 border-transparent transition-colors 
hover:bg-gray-50">
                    <i class="fas fa-comment-dots mr-1"></i> Vastu Chatbot
                </button>
            </div>


            <div id="reportView" class="tab-content">
                <div id="reportContent" class="glass-card p-4 h-96 overflow-y-auto text-sm report-section">
          Awaiting Scan Data.
</div>
            </div>
            
            <div id="chatView" class="tab-content hidden no-print">
                <div id="chatMessages" class="glass-card p-4 h-96 overflow-y-auto text-sm flex flex-col space-y-2">
                    <div class="ai-message chat-message text-gray-700">
           <i class="fas fa-robot mr-1 text-blue-500"></i>
                        Hello!
I am your Vastu AI Assistant. Ask me a general question about Vastu, or ask me for details about the report you just generated (e.g., "Tell me more about the North-East zone in my report").
</div>
                </div>
                <div class="flex mt-4">
                    <input type="text" id="chatInput" placeholder="Ask your Vastu question..." class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800" disabled>
                    <button id="sendChatButton" class="primary-btn p-3 rounded-r-lg font-bold" disabled>
                   <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>


            <div class="mt-4 flex flex-wrap -mx-1 no-print">
                <button id="deepAnalysisButton" class="primary-btn p-3 rounded-lg font-bold bg-blue-500 hover:bg-blue-600 w-full sm:w-auto sm:flex-1 m-1" style="box-shadow: 0 4px #1d4ed8;" disabled>
                    <i class="fas fa-exclamation-triangle mr-2"></i>Expert Analysis
                </button>
               
 <button id="analyzeButton" class="primary-btn p-3 rounded-lg font-bold w-full sm:w-auto sm:flex-1 m-1" disabled>
                    <i class="fas fa-chart-area mr-2"></i>Formal Report
                 </button>
                <button id="saveReportButton" class="primary-btn p-3 rounded-lg font-bold bg-green-500 hover:bg-green-600 w-[calc(50%-0.5rem)] sm:w-auto m-1 hidden" style="box-shadow: 0 4px #047857;">
                    <i class="fas 
fa-file-export mr-2"></i>Export .txt
                </button>
                <button id="printReportButton" class="primary-btn p-3 rounded-lg font-bold bg-gray-500 hover:bg-gray-600 w-[calc(50%-0.5rem)] sm:w-auto m-1 hidden" style="box-shadow: 0 4px #4b5563;">
                    <i class="fas fa-print mr-2"></i>Print/Save PDF
                </button>
            </div>
            
        </div>

        <!-- 
        ======================================================================
        START: TUTORIAL MODAL (Add this section)
        ======================================================================
        -->
        <div id="tutorialOverlay" class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex justify-center items-center p-4 z-50 hidden no-print">
            <div class="glass-card w-full max-w-md p-6 relative">
                <h3 id="tutorialTitle" class="font-extrabold text-xl text-blue-800 mb-3">
                    <i class="fas fa-info-circle mr-2"></i> How This Works
                </h3>
                
                <p id="tutorialBody" class="text-sm text-gray-700 mb-6">
                    This is the tutorial text.
                </p>

                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="tutorialCloseButton" class="primary-btn p-3 rounded-lg font-bold sm:flex-1">
                        Got It!
                    </button>
                    <button id="tutorialSkipAllButton" class="bg-gray-200 text-gray-600 p-3 rounded-lg font-bold text-sm hover:bg-gray-300 transition-colors sm:w-auto">
                        Skip All Tutorials
                    </button>
                </div>
            </div>
        </div>
        <!-- ====================================================================
        END: TUTORIAL MODAL
        ======================================================================
        -->

    </div> <!-- This is the closing tag for #appContainer -->

    <canvas id="captureCanvas" style="display:none;" class="no-print"></canvas>


    <script type="module">
        // ----------------------------------------------------------------------------------
        // *** CLIENT-SIDE CODE: API KEY IS REMOVED ***
        // ----------------------------------------------------------------------------------
        
        // --- IMPROVEMENT: PASTE YOUR RENDER SERVER URL HERE ---
        // e.g., "https://vastu-app-server.onrender.com"
        const renderApiUrl = "https://test12-6qay.onrender.com"; 
        
        // ----------------------------------------------------------------------------------
        
        let currentHeading = null;
let isCompassActive = false;
        let isCameraActive = false;
        let isCapturing = false;
        let isReportGenerating = false;
        let isChatGenerating = false;
let videoStream = null;
        let capturedFrames = [];
        let fullReportMarkdown = "";
        let chatContextSummary = "";
// NEW: Variable to hold the summary for the chatbot
        let chatHistory = [];
let simulationInterval;
        let captureInterval;
        let sensorCheckTimeout; // NEW: Global for the fallback timer
        
        const totalCaptures = 8;
const captureIntervalTime = 2000; // 2 seconds
        const scanDuration = totalCaptures * (captureIntervalTime / 1000);
// 16 seconds

        // --- GLOBAL STATE FOR ROOM CONTEXT ---
        let currentRoomTag = "General Property Scan"; // Default
let roomLocationInHouse = "Center"; // Default
        let floorNumber = "";

        // --- NEW: FLOOR PLANNER GLOBALS ---
        let fabricCanvas = null;
        let brahmaCenter = null; // Will store { x, y }
        let brahmaDot = null; // The visual circle
        const VASTU_ZONES_16 = [
            "N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
            "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"
        ];


        // --- IMPROVEMENT: GLOBAL STATE FOR HOLISTIC CONTEXT ---
        let userIssues = [];
        let propertySurroundings = {}; // e.g., { "Water Body": "North", "Hills": "South-West" }

        // --- DOM Elements (GLOBAL DECLARATIONS) ---
        // These will be assigned values *after* the DOM loads
        let stepContents, stepIndicators, tipsNextButton, headingDisplay, sensorStatus,
            compassNeedle, compassButton, cameraButton, captureCanvas, cameraVideo,
            cameraFallback, overlayHeading, overlayZone, gallery, captureButton,
            captureCountDisplay, captureProgressContainer, captureProgress, analyzeButton,
            deepAnalysisButton, saveReportButton, printReportButton, reportContent,
            reportLoader, reportTab, chatTab, reportView, chatView, chatMessages,
            chatInput, sendChatButton, roomSelectionContainer, currentRoomDisplay,
            roomLocationInput, floorNumberInput, holisticNextButton,
            userConcernsContainer, surroundingsWater, surroundingsHills;

        // --- NEW: FLOOR PLANNER DOM ELEMENTS ---
        let plannerContainer, addRoomButton, setOuterWallButton, labelRoomButton, deleteRoomButton;


        // --- TUTORIAL MODAL ELEMENTS (Add these lines) ---
        let tutorialOverlay, tutorialTitle, tutorialBody, tutorialCloseButton, tutorialSkipAllButton;


        // --- UTILITY FUNCTIONS ---
        function getVastuZone(degrees) {
            // This function is for the COMPASS (0 = North)
            const offset = 11.25;
            let index = Math.floor(((degrees + offset) % 360) / 22.5);
            return VASTU_ZONES_16[index % 16];
}

        // --- NEW: Planner Zone Calculation ---
        function getVastuZoneFromAngle(angle) {
            // This function is for the CANVAS (0 = East)
            // 1. Convert Fabric.js angle (0=East) to Compass angle (0=North)
            // Fabric: 0=E, 90=S, 180=W, 270=N
            // Compass: 0=N, 90=E, 180=S, 270=W
            let compassAngle = (360 - angle + 90) % 360;
            
            // 2. Use the same logic as getVastuZone
            const offset = 11.25; // 22.5 / 2
            let index = Math.floor(((compassAngle + offset) % 360) / 22.5);
            return VASTU_ZONES_16[index % 16];
        }


        // IMPROVEMENT: RE-ENABLED asterisk-to-strong conversion
        function formatAITextForDisplay(rawText) {
            let formattedText = rawText;
formattedText = formattedText.replace(/\n\n/g, '<p></p>');
            formattedText = formattedText.replace(/\n/g, '<br>');
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Re-enabled bold
            return formattedText.length > 0 ?
`<div class="pdf-report-body">${formattedText}</div>` : '';
        }

        // IMPROVEMENT: Enabled bolding
        function displayCapturedFrames() {
            let html = `
                <strong class="no-print">VI.
Captured Visual Data Segments (${capturedFrames.length} Frames)</strong>
                <p class="text-sm font-semibold text-gray-600 mt-2 no-print">Scan Context: Data captured for the ${currentRoomTag} area, located in the ${roomLocationInHouse ||
'N/A'} of the entire property, on the ${floorNumber || 'N/A'}.</p>
                <div class="image-gallery">
            `;
capturedFrames.forEach((frame, index) => {
                const zone = getVastuZone(frame.heading);
                const imageUrl = `data:image/jpeg;base64,${frame.image}`;

                html += `
                    <div class="frame-item">
                    
    <img src="${imageUrl}" alt="Segment ${index + 1}" title="Segment ${index + 1}: ${zone}">
                        <div class="frame-data">
                            <span class="text-xs font-bold text-blue-500">#${index + 1}</span> | 
                          
  ${frame.heading.toFixed(1)}° 
                        </div>
                    </div>
                `;
            });
html += `</div>`;
            return html;
        }
        
        function formatAITextForTxtExport(rawText) {
             let formattedText = rawText;
formattedText = formattedText.replace(/\n\n/g, '\n\n');
             formattedText = formattedText.replace(/(?<!\n)\n(?!\n)/g, ' ');
             // We still want to format for .txt export
             formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, (match, p1) => `\n\n--- ${p1.toUpperCase()} ---\n`);
             return formattedText;
}

        // REMOVED updateStatus function

        // IMPROVEMENT: Updated for 6 steps
        function updateNextStepHighlight(currentStep = 1) {
            
            // --- NEW NAVIGATION/TOGGLE LOGIC ---
            // Stop sensors/camera IF we are navigating AWAY from the steps that use them.
            if (isCapturing) {
                // Don't allow navigation while actively capturing
                return; 
            }
            if (currentStep !== 5 && isCameraActive) {
                stopVideoStream();
            }
            // Stop compass if not on step 2 (activate) or 5 (scan)
            if (currentStep !== 2 && currentStep !== 5 && isCompassActive) {
                stopCompassLogic();
            }
            // --- END NEW LOGIC ---

            stepContents.forEach((content, index) => {
                const stepNum = index + 1;
                stepIndicators[index].classList.remove('step-active');
                if (stepNum === currentStep) {
         
           content.classList.remove('hidden');
                    stepIndicators[index].classList.add('step-active');
                } else {
                    content.classList.add('hidden');
                }
            });

            if (currentStep === 4) { // Location Step
                // This button now just goes to the next step
                cameraButton.disabled = false;
                cameraButton.innerHTML = `<i class="fas fa-arrow-right mr-2"></i>Next: Activate Camera`;
                // Initialize planner if it hasn't been
                if (!fabricCanvas) {
                    initializePlanner();
                }
            } else if (currentStep === 5) { // Scan Step
                captureButton.disabled = isCapturing || capturedFrames.length >= totalCaptures;
            } else if (currentStep === 6) { // Report Step
                analyzeButton.disabled = isReportGenerating || capturedFrames.length < totalCaptures;
                deepAnalysisButton.disabled = isReportGenerating || capturedFrames.length < totalCaptures; 
                chatInput.disabled = !fullReportMarkdown; // Enable chat
                sendChatButton.disabled = !fullReportMarkdown; // Enable chat
            }

            // --- ADD THIS LINE ---
            // Call the tutorial modal for the new step
            showTutorial(currentStep);
        }

        // --- REMOVED initializeRoomSelection() ---
        // This is now handled by the new Floor Planner

        // --- REMOVED selectRoom() ---
        // This is now handled by the new Floor Planner

        
        // IMPROVEMENT: RE-ADDED switchReportTab function
        function switchReportTab(target) {
            // Reset both tabs to inactive state
            reportTab.classList.remove('border-blue-500', 'border-b-2', 'text-blue-800');
chatTab.classList.remove('border-blue-500', 'border-b-2', 'text-blue-800');
            reportTab.classList.add('border-transparent', 'text-gray-600');
            chatTab.classList.add('border-transparent', 'text-gray-600');

            reportView.classList.add('hidden');
            chatView.classList.add('hidden');

            if (target === 'report') {
                // Activate Report Tab: remove inactive styles, add active styles
                reportTab.classList.remove('border-transparent', 'text-gray-600');
                reportTab.classList.add('border-blue-500', 'border-b-2', 'text-blue-800');
reportView.classList.remove('hidden');
            } else if (target === 'chat') {
                // Activate Chat Tab: remove inactive styles, add active styles
                chatTab.classList.remove('border-transparent', 'text-gray-600');
                chatTab.classList.add('border-blue-500', 'border-b-2', 'text-blue-800');
chatView.classList.remove('hidden');
                setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 10);
            }
        }

        // ----------------------------------------------------------------------------------
        // --- STEP 7 (NEW): TUTORIAL LOGIC ---
        // ----------------------------------------------------------------------------------

        function showTutorial(step) {
            // 1. Check if user has skipped all tutorials
            if (localStorage.getItem('vastuAppTutorialsSkipped') === 'true') {
                return; // Don't show any tutorials
            }

            let title = "";
            let body = "";

            // 2. Define content for each step's tutorial
            switch(step) {
                case 1:
                    title = "Welcome to Vastu Pro AI";
                    body = "This app is a 6-step Vastu analyzer. You are on the FAQ page, a great place to start.<br><br>Click 'Got It!' to continue, or 'Skip All Tutorials' to hide these messages permanently.";
                    break;
                case 2:
                    title = "Step 2: Activate Sensors";
                    body = "This is a key step. The app needs access to your device's <strong>compass</strong> to know which direction you are facing.<br><br>Please tap the 'Activate Sensors' button and grant permission if prompted.";
                    break;
                case 3:
                    title = "Step 3: Holistic Context (Optional)";
                    body = "This step is optional but highly recommended.<br><br>Telling the AI your personal concerns (like 'Financial' or 'Health') helps it create remedies that are specifically tailored to your goals.";
                    break;
                case 4:
                    title = "Step 4: Floor Plan (Required)";
                    body = "This is the <strong>most critical step</strong>.<br><br>1. Use 'Add Room' to draw your layout.<br>2. Select the *outer* blocks and press 'Set Outer Wall' to find the center (Brahmasthan).<br>3. Add more blocks for rooms, select one, and press 'Label Selected'.<br>4. Tapping a room will now select it for the scan.";
                    break;
                case 5:
                    title = "Step 5: The 360° Scan";
                    body = "You're ready to scan! You've selected the <strong>" + currentRoomTag + "</strong> in the <strong>" + roomLocationInHouse + "</strong> zone.<br><br>When you click 'Start Scan', hold your device steady and turn in a <strong>slow, complete 360-degree circle</strong>.";
                    break;
                case 6:
                    title = "Step 6: Your Report";
                    body = "Your scan is complete!<br><br>Click <strong>'Formal Report'</strong> for a detailed analysis or <strong>'Expert Analysis'</strong> for high-level structural advice. You can also use the 'Vastu Chatbot' to ask follow-up questions.";
                    break;
                default:
                    return; // Don't show modal for unknown steps
            }

            // 3. Show the modal with the correct content
            tutorialTitle.textContent = title;
            tutorialBody.innerHTML = body; // Use .innerHTML to render the <br> and <strong> tags
            tutorialOverlay.classList.remove('hidden');
        }


        // ----------------------------------------------------------------------------------
        // --- STEP 2: COMPASS ACTIVATION (FIXED WITH TIMEOUT FALLBACK) ---
        // ----------------------------------------------------------------------------------
        
        function handleOrientation(event) {
            let heading;
if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading; // iOS
} else if (event.alpha !== null) {
                // Use absolute orientation if available (0 = North)
                if (event.absolute === true || typeof event.absolute === 'undefined') {
                     heading = (360 - event.alpha) % 360; 
                } else {
                    // Fallback for relative orientation (less reliable)
                    // We can't be sure where "0" is.
                    // For this app, absolute is required.
                    console.warn("Relative orientation not supported. Using 0.");
                    heading = (360 - event.alpha) % 360; // Assume it's absolute-like
                }
} else {
                return;
}
            
            if (sensorCheckTimeout) {
                clearTimeout(sensorCheckTimeout);
sensorCheckTimeout = null;
            }

            currentHeading = parseFloat(heading.toFixed(1));
headingDisplay.textContent = `Heading: ${currentHeading}°`;
            overlayHeading.textContent = `${currentHeading}°`;
            compassNeedle.style.transform = `rotate(-${currentHeading}deg)`;
            overlayZone.textContent = `Zone: ${getVastuZone(currentHeading)}`;
}

        // Handles permission request on iOS
        function requestIOSSensorPermission() {
             if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                      
  if (permissionState === 'granted') {
                            // Add listeners *after* permission is granted
                            window.addEventListener('deviceorientation', handleOrientation);
                            window.addEventListener('deviceorientationabsolute', handleOrientation);
                            startCompassLogic(); // Now start the logic
     
                   } else {
                            // Permission denied
                            console.warn("Sensor permission denied by user.");
                            startCompassSimulation();
        }
                    })
                    .catch(e => {
    console.error('Sensor permission error:', e);
                        startCompassSimulation(); // Fallback on error
                    });
} else {
                // Not iOS 13+, or not a function
                startCompassLogic();
}
        }

        // Start logic with original, complex listener attachment check
        function startCompassLogic() {
            if (isCompassActive) return;
            
            if (window.DeviceOrientationEvent) {
                // Add listeners (if not already added by iOS permission)
                // This check avoids duplicate listeners
                if (typeof DeviceOrientationEvent.requestPermission !== 'function') { 
                     window.addEventListener('deviceorientation', handleOrientation);
                     window.addEventListener('deviceorientationabsolute', handleOrientation);
                }
            } else {
                 startCompassSimulation(); // No sensors found
return;
            }

            sensorCheckTimeout = setTimeout(() => {
                if (currentHeading === null) {
                    // No sensor data received after 1s
                    console.warn("No sensor data. Falling back to simulation.");
                    stopCompassLogic(); // Stop listeners
                    startCompassSimulation();
                } 
            }, 1000); // 1 second timeout


            isCompassActive = true;
sensorStatus.textContent = 'Sensors: Active';
            // --- BUTTON TOGGLE (NOW RED) ---
            compassButton.classList.remove('primary-btn');
            compassButton.classList.add('bg-red-500', 'hover:bg-red-600', 'primary-btn'); // Make it a red toggle
            compassButton.innerHTML = '<i class="fas fa-times mr-2"></i>Deactivate Sensors';
            compassButton.style.boxShadow = '0 4px #b91c1c';
            compassButton.disabled = false; // It's a toggle
            
            // IMPROVEMENT: Go to new Step 3 (Holistic Context)
            updateNextStepHighlight(3);
}

        function startCompassSimulation() {
            if (isCompassActive) return;
isCompassActive = true;
            let simHeading = 0;
            sensorStatus.textContent = 'Sensors: SIMULATION (Not Found)';
simulationInterval = setInterval(() => {
                simHeading = (simHeading + 0.1) % 360; 
                currentHeading = parseFloat(simHeading.toFixed(1));
                headingDisplay.textContent = `Heading: ${currentHeading}° (SIM)`;
                overlayHeading.textContent = `${currentHeading}° (SIM)`;
                

                compassNeedle.style.transform = `rotate(-${currentHeading}deg)`;
                overlayZone.textContent = `Zone: ${getVastuZone(currentHeading)}`;
            }, 100);
            
            // --- BUTTON TOGGLE (NOW RED) ---
            compassButton.classList.remove('primary-btn');
            compassButton.classList.add('bg-red-500', 'hover:bg-red-600', 'primary-btn'); // Make it a red toggle
            compassButton.innerHTML = '<i class="fas fa-times mr-2"></i>Deactivate Sensors (SIM)';
            compassButton.style.boxShadow = '0 4px #b91c1c';
            compassButton.disabled = false; // It's a toggle
            
            // IMPROVEMENT: Go to new Step 3 (Holistic Context)
            updateNextStepHighlight(3);
}
        
        // --- REFACTORED activateCompass ---
        function activateCompass() {
            // --- NEW TOGGLE LOGIC ---
            if (isCompassActive) {
                stopCompassLogic(); // This will stop sensors and reset the button
                return;
            }
            
            // --- NEW PERMISSION-FIRST LOGIC ---
            if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // This is iOS 13+. Must request permission.
                requestIOSSensorPermission();
            } 
            else if (window.DeviceOrientationEvent) {
                // This is Android or other non-iOS. No permission needed.
                startCompassLogic();
            } 
            else {
                // No sensors detected.
                startCompassSimulation();
            }
        }


        function stopVideoStream() {
            if (!isCameraActive) return; // Already stopped
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
videoStream = null;
            }
            isCameraActive = false;
            cameraVideo.classList.add('hidden');
            cameraFallback.classList.remove('hidden');

            // Reset button state (back on Step 4)
            cameraButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-gray-400');
            cameraButton.classList.add('primary-btn');
            cameraButton.innerHTML = `<i class="fas fa-arrow-right mr-2"></i>Next: Activate Camera`;
            cameraButton.style.boxShadow = '0 4px var(--color-text-dark)';
            cameraButton.disabled = false;
        }

        function stopCompassLogic() {
            if (!isCompassActive) return; // Already stopped
            isCompassActive = false;
            sensorStatus.textContent = 'Sensors: Inactive';
            
            // Reset button state
            compassButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-gray-400');
            compassButton.classList.add('primary-btn');
            compassButton.innerHTML = '<i class="fas fa-magic mr-2"></i>Activate Sensors';
            compassButton.style.boxShadow = '0 4px var(--color-text-dark)';
            compassButton.disabled = false;

            headingDisplay.textContent = 'Heading: N/A';
            overlayHeading.textContent = 'N/A';
            compassNeedle.style.transform = `rotate(0deg)`;
            overlayZone.textContent = 'Zone: Unknown';

            window.removeEventListener('deviceorientation', handleOrientation);
            window.removeEventListener('deviceorientationabsolute', handleOrientation);
if (simulationInterval) {
                clearInterval(simulationInterval);
simulationInterval = null;
            }
            if (sensorCheckTimeout) {
                clearTimeout(sensorCheckTimeout);
sensorCheckTimeout = null;
            }
}


        async function activateCamera() {
            // --- NEW TOGGLE LOGIC ---
            // This button now has two roles:
            // 1. On Step 4: It's a "Next" button.
            // 2. On Step 5: It will be a "Deactivate" toggle (in future)
            // For now, it just moves to Step 5
            
            const currentStep = Array.from(stepIndicators).findIndex(s => s.classList.contains('step-active')) + 1;

            if (currentStep === 4) {
                // We are on the floor plan step. Move to camera step.
                // We also need to activate the compass FOR the camera step
                if (!isCompassActive) {
                    activateCompass();
                }
                updateNextStepHighlight(5); // Go to Step 5
                
                // Now, activate the camera
                if (isCameraActive) return; // Already on
                if (isCapturing) return; // Don't mess with it

                 try {
                    videoStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 320 },
                            height: { ideal: 320 }
                        } 
                    });
                    cameraVideo.srcObject = videoStream;
                    cameraVideo.classList.remove('hidden'); 
                    cameraFallback.classList.add('hidden');
                    await cameraVideo.play();
                    isCameraActive = true;
                } catch (err) {
                    console.error('Camera access error:', err);
                    cameraVideo.classList.add('hidden');
                    cameraFallback.classList.remove('hidden');
                }
            }
        }

        function captureCurrentFrame() {
            const video = cameraVideo;
const canvas = captureCanvas;
            const context = canvas.getContext('2d');

            if (!isCameraActive || !currentHeading) {
                console.error("Cannot capture: Camera or compass is inactive.");
return null;
            }
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                console.warn("Video dimensions not ready yet. Skipping this frame capture.");
return null;
            }
            const size = Math.min(video.videoWidth, video.videoHeight);
canvas.width = size;
            canvas.height = size;
            const startX = (video.videoWidth - size) / 2;
const startY = (video.videoHeight - size) / 2;
            context.drawImage(video, startX, startY, size, size, 0, 0, size, size);
            
            // Payload Size Reduced: 0.1 -> 0.05
const dataUrl = canvas.toDataURL('image/jpeg', 0.05); 
            const base64Data = dataUrl.split(',')[1];
            
            return {
                image: base64Data, 
                heading: currentHeading,
                zone: getVastuZone(currentHeading),
                timestamp: Date.now()
            };
}

        function startCapture() {
            if (isCapturing) return;

            if (!isCompassActive || !isCameraActive) {
                alert("Please ensure sensors and camera are active (Steps 2 & 5).");
                return;
            }
            
            // Data now comes from the planner, but we still need floor number
            if (!floorNumber || floorNumber.length < 1) {
                alert("Please go back to Step 4 and enter the 'Floor Number' before scanning.");
return;
            }
            
            isCapturing = true;
capturedFrames = [];
            captureCountDisplay.textContent = `0/${totalCaptures}`;
            captureButton.disabled = true;
            captureButton.textContent = 'Scanning... (Hold Steady)';
            gallery.innerHTML = '';
            captureProgressContainer.classList.remove('hidden');
captureProgress.style.width = '0%';
            analyzeButton.disabled = true;
            deepAnalysisButton.disabled = true; // Disable new button
            saveReportButton.classList.add('hidden');
            printReportButton.classList.add('hidden'); // Hide print button
let capturesTaken = 0;
            
            const executeCapture = () => {
                const frameData = captureCurrentFrame();
if (frameData) {
                    capturedFrames.push(frameData);
capturesTaken++;
                    displayCapturedFramesInGallery();
                    captureCountDisplay.textContent = `${capturesTaken}/${totalCaptures}`;
                    captureProgress.style.width = `${(capturesTaken / totalCaptures) * 100}%`;
if (capturesTaken >= totalCaptures) {
                        clearInterval(captureInterval);
endCapture();
                    }
                }
            };
executeCapture(); 
            captureInterval = setInterval(executeCapture, captureIntervalTime);
            
            setTimeout(() => {
                if(isCapturing) {
                    clearInterval(captureInterval);
                    endCapture(); 
                }
            }, captureIntervalTime * totalCaptures + 500);
}

        function endCapture() {
            isCapturing = false;
captureProgressContainer.classList.add('hidden');
            captureButton.textContent = 'Start 16-Second Vastu Scan';
            captureButton.disabled = false;
            
            stopVideoStream();
            stopCompassLogic();
if (capturedFrames.length === totalCaptures) {
                // IMPROVEMENT: Go to new Step 6 (Report)
                updateNextStepHighlight(6);
analyzeButton.disabled = false;
                deepAnalysisButton.disabled = false; // Enable new button
            } else {
                // IMPROVEMENT: Go to new Step 6 (Report)
                updateNextStepHighlight(6);
analyzeButton.disabled = true; 
                deepAnalysisButton.disabled = true; // Keep disabled
            }
        }

        function displayCapturedFramesInGallery() {
            gallery.innerHTML = '';
capturedFrames.forEach((frame, index) => {
                const img = document.createElement('img');
                img.src = `data:image/jpeg;base64,${frame.image}`;
                img.className = 'w-16 h-16 object-cover rounded-md border border-gray-300';
                img.title = `Segment ${index + 1}: ${frame.zone} (${frame.heading}°)`;
              

                const container = document.createElement('div');
                container.className = 'relative flex flex-col items-center justify-center p-1';
                const label = document.createElement('span');
                label.className = 'text-xxs text-center text-gray-500 mt-1 truncate w-16';
                

                label.textContent = `${getVastuZone(frame.heading).split(' ')[0]} (${index + 1})`;
        
                container.appendChild(img);
                container.appendChild(label);
                gallery.appendChild(container);
            });
}
        
        // --- STEP 6: REPORT GENERATION (SYNCHRONOUS) ---

        // IMPROVEMENT: Added isDeepAnalysis flag
        async function generateReport(isDeepAnalysis = false) {
            if (isReportGenerating || capturedFrames.length < totalCaptures) {
return;
            }
            
            // SERVER-CLIENT CHANGE: Check for Render URL
            if (renderApiUrl.includes("YOUR_RENDER_URL_HERE") || renderApiUrl.length < 10) {
reportContent.innerHTML = formatAITextForDisplay(`**Error:** Server not configured. Please paste your Render server's URL into the 'renderApiUrl' variable at the top of the script.`);
return;
            }

            isReportGenerating = true;
            fullReportMarkdown = "";
chatContextSummary = ""; // Reset summary
            chatHistory = [];
reportContent.innerHTML = displayCapturedFrames();
            reportLoader.classList.remove('hidden');
            analyzeButton.disabled = true;
            deepAnalysisButton.disabled = true; // Disable new button
            saveReportButton.classList.add('hidden');
            printReportButton.classList.add('hidden'); // Hide print button
            chatInput.disabled = true;
            sendChatButton.disabled = true;

            // Format holistic context for the prompt
            let holisticIssues = "None specified";
            if (userIssues.length > 0) {
                holisticIssues = userIssues.join(', ');
            }
            
            let holisticSurroundings = "None specified";
            const surroundingsEntries = Object.entries(propertySurroundings).filter(([key, value]) => value.trim() !== "");
            if (surroundingsEntries.length > 0) {
                holisticSurroundings = surroundingsEntries.map(([key, value]) => `${key}: ${value}`).join('; ');
            }

            // SERVER-CLIENT CHANGE: Create the payload for our *own* server
            const clientPayload = {
                isDeepAnalysis: isDeepAnalysis,
                scanData: {
                    capturedFrames: capturedFrames.map(f => ({ 
                        image: f.image, 
                        heading: f.heading, 
                        zone: f.zone 
                    })),
                    // --- UPDATED CONTEXT ---
                    currentRoomTag: currentRoomTag,
                    roomLocationInHouse: roomLocationInHouse,
                    floorNumber: floorNumber,
                    // --- END UPDATED CONTEXT ---
                    holisticIssues: holisticIssues,
                    holisticSurroundings: holisticSurroundings
                }
            };
            
try {
                // SERVER-CLIENT CHANGE: Call our Render server, not Google
                const apiUrl = `${renderApiUrl}/api/generateReport`;
const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clientPayload)
                });
if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Server Error: ${response.status} - ${errorData.error || 'Failed to fetch'}`);
}
                
                const result = await response.json();
fullReportMarkdown = result.text || "";
                
                if (!fullReportMarkdown) {
                    throw new Error("API returned an empty response. This is likely due to the API's safety filters (e.g., a blurry/dark image) or a silent timeout. Please try scanning again in a well-lit area.");
}

                // IMPROVEMENT: Always update chat context
                const summaryEndMarker = '**II. Directional Data and Environmental Assessment**'; 
                const summaryEndIndex = fullReportMarkdown.indexOf(summaryEndMarker);

                if (summaryEndIndex !== -1) { // It's a Formal Report, grab the summary
                    chatContextSummary = fullReportMarkdown.substring(0, summaryEndIndex).trim();
} else { // It's an Expert Analysis, just grab the first 500 chars for context
                    chatContextSummary = fullReportMarkdown.substring(0, 500).trim();
}
                
                reportContent.innerHTML = formatAITextForDisplay(fullReportMarkdown) + displayCapturedFrames();
                saveReportButton.classList.remove('hidden');
                printReportButton.classList.remove('hidden'); // Show print button
chatInput.disabled = false;
                sendChatButton.disabled = false;
} catch (error) {
                console.error('Report Generation Error:', error);
let errorHtml = formatAITextForDisplay(`**I. Executive Summary (Layman's Terms)**\n\nReport generation failed due to an error.`);
errorHtml += `<p class="text-red-600 font-bold mt-4">REPORT GENERATION FAILED</p>
                              <p class="mt-2 text-sm">A critical API error occurred.
Please try running the scan again.</p>
                              <p class="mt-2 text-xs text-gray-400">Error Details: ${error.message}</p>`;
reportContent.innerHTML = errorHtml + displayCapturedFrames();
            } finally {
                isReportGenerating = false;
reportLoader.classList.add('hidden');
                analyzeButton.disabled = false;
                deepAnalysisButton.disabled = false; // Re-enable
            }
        }

        // --- TEXT EXPORT LOGIC ---
        function exportReportAsTxt() {
            if (!fullReportMarkdown) {
return;
            }
            
saveReportButton.disabled = true;

            // IMPROVEMENT: Removed timestamp and heading
            const header = `
*** Vastu Pro Analyzer Formal AI Report ***
Scan Area: ${currentRoomTag} 
Location in House (C-Point): ${roomLocationInHouse ||
'N/A'}
Floor: ${floorNumber || 'N/A'}
----------------------------------------------------------------------------------------------------------------------
\n`;
            
            const formattedBody = formatAITextForTxtExport(fullReportMarkdown);
const footer = `
\n----------------------------------------------------------------------------------------------------------------------
*** Captured Visual Data Segments (Images are NOT included in this text file) ***
${capturedFrames.map((f, i) => `#${i + 1}: ${f.heading.toFixed(1)} degrees (${f.zone})`).join(' | ')}
----------------------------------------------------------------------------------------------------------------------
This file contains the full Vastu analysis.
\n`;

            const fullTextContent = header + formattedBody + footer;

            const blob = new Blob([fullTextContent], { type: 'text/plain' });
const a = document.createElement('a');
            a.download = `Vastu_Report_${Date.now()}.txt`;
            a.href = URL.createObjectURL(blob);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            saveReportButton.disabled = false;
}


        // --- CHATBOT LOGIC ---

        // IMPROVEMENT: Re-enabled bolding
        function appendMessage(text, sender) {
            const msgDiv = document.createElement('div');
msgDiv.className = `chat-message ${sender}-message`;

            if (sender === 'ai') {
                // Format AI text: Convert markdown bold to <strong> and newlines to <br>
                let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formattedText = formattedText.replace(/\n/g, '<br>');
                msgDiv.innerHTML = `<i class="fas fa-robot mr-1 text-blue-500"></i> ${formattedText}`;
} else {
                // User text is plain
                msgDiv.textContent = text;
}
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
}

        async function handleChat() {
            const userText = chatInput.value.trim();
if (!userText || isChatGenerating) return;

            // SERVER-CLIENT CHANGE: Check for Render URL
            if (renderApiUrl.includes("YOUR_RENDER_URL_HERE") || renderApiUrl.length < 10) {
    appendMessage("Error: Chat server not configured.", 'ai');
                 return;
            }
            
            appendMessage(userText, 'user');
chatInput.value = '';
            
            isChatGenerating = true;
            chatInput.disabled = true;
            sendChatButton.disabled = true;
chatHistory.push({ role: "user", parts: [{ text: userText }] });
            
            const chatHistoryToSend = chatHistory.slice(-3);

            // SERVER-CLIENT CHANGE: Create payload for our *own* server
            const clientPayload = {
                chatHistory: chatHistoryToSend,
                chatContextSummary: chatContextSummary
            };

            try {
                // SERVER-CLIENT CHANGE: Call our Render server, not Google
                const apiUrl = `${renderApiUrl}/api/handleChat`;
const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clientPayload)
                });
if (!response.ok) {
                    const errorData = await response.json();
throw new Error(`Server Error: ${response.status} - ${errorData.error || 'Failed to fetch'}`);
                }

                const result = await response.json();
const aiResponse = result.text || "Sorry, I couldn't process that query.";

                appendMessage(aiResponse, 'ai');
chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
} catch (error) {
                console.error('Chatbot Error:', error);
appendMessage(`I apologize, I encountered an error: ${error.message}. Please try again.`, 'ai');
} finally {
                isChatGenerating = false;
chatInput.disabled = false;
                sendChatButton.disabled = chatInput.value.trim() === '' || isChatGenerating;
                chatInput.focus();
}
        }

        // ----------------------------------------------------------------------------------
        // --- NEW: FLOOR PLANNER FUNCTIONS ---
        // ----------------------------------------------------------------------------------

        function initializePlanner() {
            if (fabricCanvas) return; // Already initialized

            plannerContainer = document.getElementById('plannerContainer');
            const canvasEl = document.getElementById('floorPlanCanvas');

            // Resize canvas to fit the container
            const containerWidth = plannerContainer.clientWidth;
            // --- *** FIX IS HERE *** ---
            // The container's height is set by padding-top: 100%, so clientHeight will be 0.
            // We must use clientWidth for both dimensions to respect the 1:1 ratio.
            const containerHeight = containerWidth; 
            canvasEl.width = containerWidth;
            canvasEl.height = containerHeight;

            fabricCanvas = new fabric.Canvas('floorPlanCanvas', {
                width: containerWidth,
                height: containerHeight,
                backgroundColor: 'rgba(0,0,0,0)', // Transparent
            });

            // Add tool listeners
            addRoomButton.addEventListener('click', () => {
                const room = new fabric.Rect({
                    left: fabricCanvas.width / 2 - 25,
                    top: fabricCanvas.height / 2 - 25,
                    fill: 'rgba(255, 255, 255, 0.7)',
                    width: 50,
                    height: 50,
                    stroke: 'var(--color-primary)',
                    strokeWidth: 2,
                    data: { type: 'room', label: 'Unlabeled' } // Custom data
                });
                fabricCanvas.add(room);
            });

            deleteRoomButton.addEventListener('click', () => {
                fabricCanvas.getActiveObjects().forEach(obj => {
                    fabricCanvas.remove(obj);
                });
                fabricCanvas.discardActiveObject().renderAll();
            });

            labelRoomButton.addEventListener('click', () => {
                const activeObj = fabricCanvas.getActiveObject();
                if (!activeObj) {
                    alert("Please select a room block first."); // Simple feedback
                    return;
                }
                const label = prompt("Enter a label for this room (e.g., Kitchen):", activeObj.data.label);
                if (label) {
                    activeObj.set('data', { ...activeObj.data, label: label });
                    // Update selection if this is the currently selected room
                    if (activeObj.data.type === 'room') {
                        selectRoomForScan(activeObj);
                    }
                }
            });

            setOuterWallButton.addEventListener('click', () => {
                const activeObjects = fabricCanvas.getActiveObjects();
                if (activeObjects.length === 0) {
                     alert("Please select one or more blocks that make up your outer wall.");
                    return;
                }
                
                // Reset old walls
                fabricCanvas.forEachObject(obj => {
                    if (obj.data.type === 'wall') {
                        obj.set('data', { ...obj.data, type: 'room' });
                        obj.set('fill', 'rgba(255, 255, 255, 0.7)');
                    }
                });

                // Create a group from selection to find its center
                const wallGroup = new fabric.Group(activeObjects, {
                    // We don't add this to canvas, just use it for calculation
                });

                brahmaCenter = wallGroup.getCenterPoint();

                // Set new walls
                activeObjects.forEach(obj => {
                    obj.set('data', { ...obj.data, type: 'wall' });
                    obj.set('fill', 'rgba(191, 219, 254, 0.7)'); // Blue-200
                });

                // Remove old dot
                if (brahmaDot) {
                    fabricCanvas.remove(brahmaDot);
                }

                // Add new dot
                brahmaDot = new fabric.Circle({
                    left: brahmaCenter.x - 5,
                    top: brahmaCenter.y - 5,
                    radius: 5,
                    fill: 'var(--color-primary)',
                    stroke: 'white',
                    strokeWidth: 2,
                    selectable: false,
                    evented: false,
                });
                fabricCanvas.add(brahmaDot);
                fabricCanvas.renderAll();
                
                // Set default scan context
                currentRoomTag = "Central Bhramsthan";
                roomLocationInHouse = "Center";
                currentRoomDisplay.innerHTML = `Selected for Scan: <strong>${currentRoomTag}</strong> (in <strong>${roomLocationInHouse}</strong> zone)`;
            });

            // Canvas event: Handle room selection
            fabricCanvas.on('mouse:down', (options) => {
                if (options.target) {
                    const obj = options.target;
                    // Only select rooms, not walls or the dot
                    if (obj.data && obj.data.type === 'room') {
                        selectRoomForScan(obj);
                    }
                }
            });
        }

        function selectRoomForScan(roomObject) {
            if (!brahmaCenter) {
                alert("Please set your outer wall first to find the Brahmasthan (center).");
                return;
            }

            const roomCenter = roomObject.getCenterPoint();
            
            // Calculate angle from Brahmasthan to room center
            // 0 degrees is East in this calculation
            const angleDeg = Math.atan2(
                roomCenter.y - brahmaCenter.y, 
                roomCenter.x - brahmaCenter.x
            ) * 180 / Math.PI;

            const zone = getVastuZoneFromAngle(angleDeg);
            const label = roomObject.data.label;

            // Set global state
            currentRoomTag = label;
            roomLocationInHouse = zone;

            // Update UI
            currentRoomDisplay.innerHTML = `Selected for Scan: <strong>${label}</strong> (in <strong>${zone}</strong> zone)`;
            
            // Visual feedback
            fabricCanvas.forEachObject(obj => {
                 if (obj.data && obj.data.type === 'room') {
                     obj.set('stroke', 'var(--color-primary)'); // Reset others
                 }
            });
            roomObject.set('stroke', '#f97316'); // Highlight selected in orange
            fabricCanvas.renderAll();
        }


        // --- Event Listeners and Initialization ---
        // IMPROVEMENT: All listeners are now wrapped in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {

            // --- IMPROVEMENT: ALL DOM ELEMENT GRABBERS MOVED HERE ---
            stepContents = [1, 2, 3, 4, 5, 6].map(i => document.getElementById(`stepContent${i}`));
            stepIndicators = [1, 2, 3, 4, 5, 6].map(i => document.getElementById(`step${i}`));
            tipsNextButton = document.getElementById('tipsNextButton');
            headingDisplay = document.getElementById('headingDisplay');
            sensorStatus = document.getElementById('sensorStatus');
            compassNeedle = document.getElementById('compassNeedle');
            compassButton = document.getElementById('compassButton');
            cameraButton = document.getElementById('cameraButton');
            captureCanvas = document.getElementById('captureCanvas');
            cameraVideo = document.getElementById('cameraVideo');
            cameraFallback = document.getElementById('cameraFallback');
            overlayHeading = document.getElementById('overlayHeading');
            overlayZone = document.getElementById('overlayZone');
            gallery = document.getElementById('gallery');
            captureButton = document.getElementById('captureButton');
            captureCountDisplay = document.getElementById('captureCount');
            captureProgressContainer = document.getElementById('captureProgressContainer');
            captureProgress = document.getElementById('captureProgress');
            analyzeButton = document.getElementById('analyzeButton');
            deepAnalysisButton = document.getElementById('deepAnalysisButton');
            saveReportButton = document.getElementById('saveReportButton');
            printReportButton = document.getElementById('printReportButton');
            reportContent = document.getElementById('reportContent');
            reportLoader = document.getElementById('reportLoader');
            reportTab = document.getElementById('reportTab');
            chatTab = document.getElementById('chatTab');
            reportView = document.getElementById('reportView');
            chatView = document.getElementById('chatView');
            chatMessages = document.getElementById('chatMessages');
            chatInput = document.getElementById('chatInput');
            sendChatButton = document.getElementById('sendChatButton');
            
            // --- OLD STEP 4 (REMOVED/RE-PURPOSED) ---
            // roomSelectionContainer = document.getElementById('roomSelectionContainer'); // REMOVED
            currentRoomDisplay = document.getElementById('currentRoomDisplay'); // RE-PURPOSED
            // roomLocationInput = document.getElementById('roomLocationInput'); // REMOVED
            floorNumberInput = document.getElementById('floorNumberInput'); // RE-PURPOSED
            
            // --- NEW STEP 4 GRABBERS ---
            addRoomButton = document.getElementById('addRoomButton');
            setOuterWallButton = document.getElementById('setOuterWallButton');
            labelRoomButton = document.getElementById('labelRoomButton');
            deleteRoomButton = document.getElementById('deleteRoomButton');


            holisticNextButton = document.getElementById('holisticNextButton');
            userConcernsContainer = document.getElementById('userConcernsContainer');
            surroundingsWater = document.getElementById('surroundingsWater');
            surroundingsHills = document.getElementById('surroundingsHills');
            
            // --- ADD THESE 5 LINES (for the tutorial modal) ---
            tutorialOverlay = document.getElementById('tutorialOverlay');
            tutorialTitle = document.getElementById('tutorialTitle');
            tutorialBody = document.getElementById('tutorialBody');
            tutorialCloseButton = document.getElementById('tutorialCloseButton');
            tutorialSkipAllButton = document.getElementById('tutorialSkipAllButton');
            // --- END OF DOM ELEMENT GRABBERS ---

            // Initial setup
            // initializeRoomSelection(); // REMOVED
            currentRoomDisplay.innerHTML = `Selected for Scan: <strong>${currentRoomTag}</strong> (in <strong>${roomLocationInHouse}</strong> zone)`;
            updateNextStepHighlight(); // Defaults to step 1 (Tips)
            switchReportTab('report'); // Default to report tab
        
            // Listener for the new Step 1 button
            tipsNextButton.addEventListener('click', () => updateNextStepHighlight(2));
            
            // Listener for the new Step 3 button
            holisticNextButton.addEventListener('click', () => updateNextStepHighlight(4));
            
            compassButton.addEventListener('click', activateCompass);
            
            // cameraButton now serves 2 purposes
            cameraButton.addEventListener('click', activateCamera);
            
    captureButton.addEventListener('click', startCapture);
            analyzeButton.addEventListener('click', () => generateReport(false)); // Standard report
            deepAnalysisButton.addEventListener('click', () => generateReport(true)); // Deep analysis report
            saveReportButton.addEventListener('click', exportReportAsTxt);
            printReportButton.addEventListener('click', () => window.print()); // NEW Print listener
            
            // ====================================================================
            // START: NEW TUTORIAL & NAVIGATION LISTENERS (Add this section)
            // ====================================================================

            // --- 1. Tutorial Modal Button Listeners ---
            tutorialCloseButton.addEventListener('click', () => {
                tutorialOverlay.classList.add('hidden');
            });

            tutorialSkipAllButton.addEventListener('click', () => {
                let userIsSure = false;
                try {
                   userIsSure = confirm("Are you sure you want to skip all tutorials? This is permanent.");
                } catch (e) {
                   console.warn("`confirm()` dialog might be blocked. Skipping tutorial for this session only.");
                }

                if (userIsSure) {
                    localStorage.setItem('vastuAppTutorialsSkipped', 'true');
                    tutorialOverlay.classList.add('hidden');
                } else if (!userIsSure) {
                    tutorialOverlay.classList.add('hidden');
                }
            });

            // --- 2. Free Step Navigation (Your Request) ---
            stepIndicators.forEach((indicator, index) => {
                const stepToOpen = index + 1;
                indicator.addEventListener('click', () => {
                    // This allows clicking on any step (1-6) to navigate
                    if (!isCapturing) { // Block navigation while scan is in progress
                        updateNextStepHighlight(stepToOpen);
                    }
                });
                // Add cursor-pointer to show they are clickable
                indicator.classList.add('cursor-pointer'); 
            });

            // ====================================================================
            // END: NEW TUTORIAL & NAVIGATION LISTENERS
            // ====================================================================
            
            // Listeners for new Step 3 inputs
            userConcernsContainer.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    userIssues = Array.from(userConcernsContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                }
            });
            surroundingsWater.addEventListener('input', () => {
                propertySurroundings[surroundingsWater.dataset.key] = surroundingsWater.value;
            });
            surroundingsHills.addEventListener('input', () => {
                propertySurroundings[surroundingsHills.dataset.key] = surroundingsHills.value;
            });

            // Listeners for Step 4 inputs
            // roomLocationInput.addEventListener('input', () => { // REMOVED
            //      roomLocationInHouse = roomLocationInHouse.value.trim();
            // });
    // Update floorNumber on input change
            floorNumberInput.addEventListener('input', () => {
                 floorNumber = floorNumberInput.value.trim();
            });

            // Listeners for Step 6
            reportTab.addEventListener('click', () => switchReportTab('report'));
            chatTab.addEventListener('click', () => {
                if (fullReportMarkdown) {
                    switchReportTab('chat');
                } else {
                    switchReportTab('report');
                }
            });
            
            sendChatButton.addEventListener('click', handleChat);
    chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChat();
                }
            });
    chatInput.addEventListener('input', () => {
                sendChatButton.disabled = chatInput.value.trim() === '' || isChatGenerating;
            });
        
        });
</script>
</body>
</html>

